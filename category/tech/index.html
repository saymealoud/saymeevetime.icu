
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Chester Zhao">
      
      
      
        <link rel="prev" href="../life/">
      
      
        <link rel="next" href="../../archive/2024/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.24">
    
    
      
        <title>tech - saymealoud</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tech" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="saymealoud" class="md-header__button md-logo" aria-label="saymealoud" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-6 8h-2V9h2v2m0-4h-2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2v2H9v2h4a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            saymealoud
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              tech
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07 19.07 3.5m-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13.51 1.67m-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87.4 1.31M19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35-2.53-2.2m4.33-2.7 1.15-2.77 2.2 2.54-3.35.23m1.15-4.96-1.14-2.78 3.34.24-2.2 2.54M9.63 18.93l2.77 1.15-2.53 2.19-.24-3.34Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.5 2c-1.79 1.15-3 3.18-3 5.5s1.21 4.35 3.03 5.5C4.46 13 2 10.54 2 7.5A5.5 5.5 0 0 1 7.5 2m11.57 1.5 1.43 1.43L4.93 20.5 3.5 19.07 19.07 3.5m-6.18 2.43L11.41 5 9.97 6l.42-1.7L9 3.24l1.75-.12.58-1.65L12 3.1l1.73.03-1.35 1.13.51 1.67m-3.3 3.61-1.16-.73-1.12.78.34-1.32-1.09-.83 1.36-.09.45-1.29.51 1.27 1.36.03-1.05.87.4 1.31M19 13.5a5.5 5.5 0 0 1-5.5 5.5c-1.22 0-2.35-.4-3.26-1.07l7.69-7.69c.67.91 1.07 2.04 1.07 3.26m-4.4 6.58 2.77-1.15-.24 3.35-2.53-2.2m4.33-2.7 1.15-2.77 2.2 2.54-3.35.23m1.15-4.96-1.14-2.78 3.34.24-2.2 2.54M9.63 18.93l2.77 1.15-2.53 2.19-.24-3.34Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/saymealoud/saymeevetime.icu" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    saymealoud/saymeevetime.icu
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="saymealoud" class="md-nav__button md-logo" aria-label="saymealoud" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-6 8h-2V9h2v2m0-4h-2a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2v2H9v2h4a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"/></svg>

    </a>
    saymealoud
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/saymealoud/saymeevetime.icu" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    saymealoud/saymeevetime.icu
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../book/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    book
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    tech
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="tech">tech</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/saymealoud.png" alt="Chester Zhao">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-22 00:00:00">May 22, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">tech</a></li>
        
        
          
          <li class="md-meta__item">
            
              23 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="devops"><a class="toclink" href="../../devops/">DevOps</a></h2>
<h4 id="devops_1"><a class="toclink" href="../../devops/#devops_1">一、DevOps介绍</a></h4>
<p>软件开发最开始是由两个团队组成：</p>
<ul>
<li>开发计划由<a href="">开发团队</a>从头开始设计和整体系统的构建。需要系统不停的迭代更新。</li>
<li><a href="">运维团队</a>将开发团队的Code进行测试后部署上线。希望系统稳定安全运行。</li>
</ul>
<p>这看似两个目标不同的团队需要协同完成一个软件的开发。</p>
<p>在开发团队指定好计划并完成coding后，需要提供到运维团队。</p>
<p>运维团队向开发团队反馈需要修复的BUG以及一些需要返工的任务。</p>
<p>这时开发团队需要经常等待运维团队的反馈。这无疑延长了事件并推迟了整个软件开发的周期。</p>
<p>会有一种方式，在开发团队等待的时候，让开发团队转移到下一个项目中。等待运维团队为之前的代码提供反馈。</p>
<p>可是这样就意味着一个完整的项目需要一个更长的周期才可以开发出最终代码。</p>
<hr />
<p>基于现在的互联网现状，更推崇敏捷式开发，这样就导致项目的迭代速度更快，但是由于开发团队与运维团队的沟通问题，会导致新版本上线的时间成本很高。这又违背的敏捷式开发的最初的目的。</p>
<p>那么如果让开发团队和运维团队整合到成一个团队，协同应对一套软件呢？这就被称为<a href="">DevOps</a>。</p>
<p><a href="">DevOps</a>，字面意思是Development &amp;Operations的缩写，也就是开发&amp;运维。</p>
<p>虽然字面意思只涉及到了开发团队和运维团队，其实QA测试团队也是参与其中的。</p>
<p>网上可以查看到<a href="">DevOps</a>的符号类似于一个无穷大的符号</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><a href="">DevOps</a></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124130409521" src="../../images/DevOps/image-20211124130409521.png" /></td>
</tr>
</tbody>
</table>
<p>这表明<a href="">DevOps</a>是一个不断提高效率并且持续不断工作的过程</p>
<p><a href="">DevOps</a>的方式可以让公司能够更快地应对更新和市场发展变化，开发可以快速交付，部署也更加稳定。</p>
<p>核心就在于<a href="">简化Dev和Ops团队之间的流程，使整体软件开发过程更快速。</a></p>
<p>整体的软件开发流程包括：</p>
<ul>
<li>PLAN：开发团队根据客户的目标制定开发计划</li>
<li>CODE：根据PLAN开始编码过程，需要将不同版本的代码存储在一个库中。</li>
<li>BUILD：编码完成后，需要将代码构建并且运行。</li>
<li>TEST：成功构建项目后，需要测试代码是否存在BUG或错误。</li>
<li>DEPLOY：代码经过手动测试和自动化测试后，认定代码已经准备好部署并且交给运维团队。</li>
<li>OPERATE：运维团队将代码部署到生产环境中。</li>
<li>MONITOR：项目部署上线后，需要持续的监控产品。</li>
<li>INTEGRATE：然后将监控阶段收到的反馈发送回PLAN阶段，整体反复的流程就是<a href="">DevOps</a>的核心，即持续集成、持续部署。</li>
</ul>
<p>为了保证整体流程可以高效的完成，各个阶段都有比较常见的工具，如下图：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">软件开发过程&amp;涉及工具</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="2021-11-23_175935" src="../../images/DevOps/2021-11-23_175935.png" /></td>
</tr>
</tbody>
</table>
<p>最终可以给<a href="">DevOps</a>下一个定义：<a href="">DevOps 强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理，从而更快、更频繁地交付更稳定的软件。</a></p>
<p>自动化的工具协作和沟通来完成软件的生命周期管理</p>
<h4 id="code"><a class="toclink" href="../../devops/#code">二、Code阶段工具</a></h4>
<p>在code阶段，我们需要将不同版本的代码存储到一个仓库中，常见的版本控制工具就是SVN或者Git，这里我们采用Git作为版本控制工具，GitLab作为远程仓库。</p>
<h5 id="21-git"><a class="toclink" href="../../devops/#21-git">2.1 Git安装</a></h5>
<p>https://git-scm.com/（傻瓜式安装）</p>
<h5 id="22-gitlab"><a class="toclink" href="../../devops/#22-gitlab">2.2 GitLab安装</a></h5>
<p>单独准备服务器，采用Docker安装</p>
<ul>
<li>查看GitLab镜像</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a>docker<span class="w"> </span>search<span class="w"> </span>gitlab
</span></code></pre></div>
<ul>
<li>拉取GitLab镜像</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a>docker<span class="w"> </span>pull<span class="w"> </span>gitlab/gitlab-ce
</span></code></pre></div>
<ul>
<li>准备docker-compose.yml文件</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a>version: &#39;3.1&#39;
</span><span id="__span-152-2"><a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a>services:
</span><span id="__span-152-3"><a id="__codelineno-152-3" name="__codelineno-152-3" href="#__codelineno-152-3"></a>  gitlab:
</span><span id="__span-152-4"><a id="__codelineno-152-4" name="__codelineno-152-4" href="#__codelineno-152-4"></a>    image: &#39;gitlab/gitlab-ce:latest&#39;
</span><span id="__span-152-5"><a id="__codelineno-152-5" name="__codelineno-152-5" href="#__codelineno-152-5"></a>    container_name: gitlab
</span><span id="__span-152-6"><a id="__codelineno-152-6" name="__codelineno-152-6" href="#__codelineno-152-6"></a>    restart: always
</span><span id="__span-152-7"><a id="__codelineno-152-7" name="__codelineno-152-7" href="#__codelineno-152-7"></a>    environment:
</span><span id="__span-152-8"><a id="__codelineno-152-8" name="__codelineno-152-8" href="#__codelineno-152-8"></a>      GITLAB_OMNIBUS_CONFIG: |
</span><span id="__span-152-9"><a id="__codelineno-152-9" name="__codelineno-152-9" href="#__codelineno-152-9"></a>        external_url &#39;http://192.168.11.11:8929&#39;
</span><span id="__span-152-10"><a id="__codelineno-152-10" name="__codelineno-152-10" href="#__codelineno-152-10"></a>        gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 2224
</span><span id="__span-152-11"><a id="__codelineno-152-11" name="__codelineno-152-11" href="#__codelineno-152-11"></a>    ports:
</span><span id="__span-152-12"><a id="__codelineno-152-12" name="__codelineno-152-12" href="#__codelineno-152-12"></a>      - &#39;8929:8929&#39;
</span><span id="__span-152-13"><a id="__codelineno-152-13" name="__codelineno-152-13" href="#__codelineno-152-13"></a>      - &#39;2224:2224&#39;
</span><span id="__span-152-14"><a id="__codelineno-152-14" name="__codelineno-152-14" href="#__codelineno-152-14"></a>    volumes:
</span><span id="__span-152-15"><a id="__codelineno-152-15" name="__codelineno-152-15" href="#__codelineno-152-15"></a>      - &#39;./config:/etc/gitlab&#39;
</span><span id="__span-152-16"><a id="__codelineno-152-16" name="__codelineno-152-16" href="#__codelineno-152-16"></a>      - &#39;./logs:/var/log/gitlab&#39;
</span><span id="__span-152-17"><a id="__codelineno-152-17" name="__codelineno-152-17" href="#__codelineno-152-17"></a>      - &#39;./data:/var/opt/gitlab&#39;
</span></code></pre></div>
<ul>
<li>启动容器（需要稍等一小会……）</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a>docker-compose<span class="w"> </span>up<span class="w"> </span>-d
</span></code></pre></div>
<ul>
<li>访问GitLab首页</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">首页</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124182140596" src="../../images/DevOps/image-20211124182140596.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>查看root用户初始密码</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>gitlab<span class="w"> </span>cat<span class="w"> </span>/etc/gitlab/initial_root_password
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">初始密码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124182921234" src="../../images/DevOps/image-20211124182921234.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>登录root用户</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">登录成功后跳转页面</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124183003858" src="../../images/DevOps/image-20211124183003858.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>第一次登录后需要修改密码</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">修改密码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124193444561" src="../../images/DevOps/image-20211124193444561.png" /></td>
</tr>
</tbody>
</table>
<p>搞定后，即可像Gitee、GitHub一样使用。</p>
<h4 id="build"><a class="toclink" href="../../devops/#build">三、Build阶段工具</a></h4>
<p>构建Java项目的工具一般有两种选择，一个是Maven，一个是Gradle。</p>
<p>这里我们选择Maven作为项目的编译工具。</p>
<p>具体安装Maven流程不做阐述，但是需要确保配置好Maven仓库私服以及JDK编译版本。</p>
<h4 id="operate"><a class="toclink" href="../../devops/#operate">四、Operate阶段工具</a></h4>
<p>部署过程，会采用Docker进行部署，暂时只安装Docker即可，后续还需安装Kubenetes</p>
<h5 id="41-docker"><a class="toclink" href="../../devops/#41-docker">4.1 Docker安装</a></h5>
<ul>
<li>
<p>准备测试环境&amp;生产环境</p>
</li>
<li>
<p>下载Docker依赖组件</p>
</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a>yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>yum-utils<span class="w"> </span>device-mapper-persistent-data<span class="w"> </span>lvm2
</span></code></pre></div>
<ul>
<li>设置下载Docker的镜像源为阿里云</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-156-1"><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a>yum-config-manager<span class="w"> </span>--add-repo<span class="w"> </span>http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></code></pre></div>
<ul>
<li>安装Docker服务</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-157-1"><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a>yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>docker-ce
</span></code></pre></div>
<ul>
<li>安装成功后，启动Docker并设置开机自启</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-158-1"><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="c1"># 启动Docker服务</span>
</span><span id="__span-158-2"><a id="__codelineno-158-2" name="__codelineno-158-2" href="#__codelineno-158-2"></a>systemctl<span class="w"> </span>start<span class="w"> </span>docker
</span><span id="__span-158-3"><a id="__codelineno-158-3" name="__codelineno-158-3" href="#__codelineno-158-3"></a><span class="c1"># 设置开机自动启动</span>
</span><span id="__span-158-4"><a id="__codelineno-158-4" name="__codelineno-158-4" href="#__codelineno-158-4"></a>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>docker
</span></code></pre></div>
<ul>
<li>测试安装成功</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-159-1"><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a>docker<span class="w"> </span>version
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124200317795" src="../../images/DevOps/image-20211124200317795.png" /></td>
</tr>
</tbody>
</table>
<h5 id="42-docker-compose"><a class="toclink" href="../../devops/#42-docker-compose">4.2 Docker-Compose安装</a></h5>
<ul>
<li>
<p>下载Docker/Compose：https://github.com/docker/compose</p>
</li>
<li>
<p>将下载好的<a href="">docker-compose-Linux-x86_64</a>文件移动到Linux操作系统：……</p>
</li>
<li>
<p>设置<a href="">docker-compose-Linux-x86_64</a>文件权限，并移动到$PATH目录中</p>
</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-160-1"><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a><span class="c1"># 设置文件权限</span>
</span><span id="__span-160-2"><a id="__codelineno-160-2" name="__codelineno-160-2" href="#__codelineno-160-2"></a>chmod<span class="w"> </span>a+x<span class="w"> </span>docker-compose-Linux-x86_64
</span><span id="__span-160-3"><a id="__codelineno-160-3" name="__codelineno-160-3" href="#__codelineno-160-3"></a><span class="c1"># 移动到/usr/bin目录下，并重命名为docker-compose</span>
</span><span id="__span-160-4"><a id="__codelineno-160-4" name="__codelineno-160-4" href="#__codelineno-160-4"></a>mv<span class="w"> </span>docker-compose-Linux-x86_64<span class="w"> </span>/usr/bin/docker-compose
</span></code></pre></div>
<ul>
<li>测试安装成功</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-161-1"><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a>docker-compose<span class="w"> </span>version
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124200658107" src="../../images/DevOps/image-20211124200658107.png" /></td>
</tr>
</tbody>
</table>
<h4 id="integrate"><a class="toclink" href="../../devops/#integrate">五、Integrate工具</a></h4>
<p>持续集成、持续部署的工具很多，其中Jenkins是一个开源的持续集成平台。</p>
<p>Jenkins涉及到将编写完毕的代码发布到测试环境和生产环境的任务，并且还涉及到了构建项目等任务。</p>
<p>Jenkins需要大量的插件保证工作，安装成本较高，下面会基于Docker搭建Jenkins。</p>
<h5 id="51-jenkins"><a class="toclink" href="../../devops/#51-jenkins">5.1 Jenkins介绍</a></h5>
<p>Jenkins是一个开源软件项目，是基于Java开发的一种持续集成工具</p>
<p>Jenkins应用广泛，大多数互联网公司都采用Jenkins配合GitLab、Docker、K8s作为实现<a href="">DevOps</a>的核心工具。</p>
<p>Jenkins最强大的就在于插件，Jenkins官方提供了大量的插件库，来自动化CI/CD过程中的各种琐碎功能。</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125141950900" src="../../images/DevOps/image-20211125141950900.png" /></td>
<td style="text-align: center;"><img alt="image-20211124200317795" src="../../images/DevOps/image-20211125141701495.png" /></td>
</tr>
</tbody>
</table>
<p>Jenkins最主要的工作就是将GitLab上可以构建的工程代码拉取并且进行构建，再根据流程可以选择发布到测试环境或是生产环境。</p>
<p>一般是GitLab上的代码经过大量的测试后，确定发行版本，再发布到生产环境。</p>
<p>CI/CD可以理解为：</p>
<ul>
<li>CI过程即是通过Jenkins将代码拉取、构建、制作镜像交给测试人员测试。</li>
<li>持续集成：让软件代码可以持续的集成到主干上，并自动构建和测试。</li>
<li>CD过程即是通过Jenkins将打好标签的发行版本代码拉取、构建、制作镜像交给运维人员部署。</li>
<li>持续交付：让经过持续集成的代码可以进行手动部署。</li>
<li>持续部署：让可以持续交付的代码随时随地的自动化部署。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">CI、CD</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125154112097" src="../../images/DevOps/image-20211125154112097.png" /></td>
</tr>
</tbody>
</table>
<h5 id="52-jenkins"><a class="toclink" href="../../devops/#52-jenkins">5.2 Jenkins安装</a></h5>
<ul>
<li>拉取Jenkins镜像</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-162-1"><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a>docker pull jenkins/jenkins
</span></code></pre></div>
<ul>
<li>编写docker-compose.yml</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-163-1"><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a>version: &quot;3.1&quot;
</span><span id="__span-163-2"><a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a>services:
</span><span id="__span-163-3"><a id="__codelineno-163-3" name="__codelineno-163-3" href="#__codelineno-163-3"></a>  jenkins:
</span><span id="__span-163-4"><a id="__codelineno-163-4" name="__codelineno-163-4" href="#__codelineno-163-4"></a>    image: jenkins/jenkins
</span><span id="__span-163-5"><a id="__codelineno-163-5" name="__codelineno-163-5" href="#__codelineno-163-5"></a>    container_name: jenkins
</span><span id="__span-163-6"><a id="__codelineno-163-6" name="__codelineno-163-6" href="#__codelineno-163-6"></a>    ports:
</span><span id="__span-163-7"><a id="__codelineno-163-7" name="__codelineno-163-7" href="#__codelineno-163-7"></a>      - 8080:8080
</span><span id="__span-163-8"><a id="__codelineno-163-8" name="__codelineno-163-8" href="#__codelineno-163-8"></a>      - 50000:50000
</span><span id="__span-163-9"><a id="__codelineno-163-9" name="__codelineno-163-9" href="#__codelineno-163-9"></a>    volumes:
</span><span id="__span-163-10"><a id="__codelineno-163-10" name="__codelineno-163-10" href="#__codelineno-163-10"></a>      - ./data/:/var/jenkins_home/
</span></code></pre></div>
<ul>
<li>首次启动会因为数据卷data目录没有权限导致启动失败，设置data目录写权限</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">错误日志</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124202610243" src="../../images/DevOps/image-20211124202610243.png" /></td>
</tr>
</tbody>
</table>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-164-1"><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a>chmod<span class="w"> </span>-R<span class="w"> </span>a+w<span class="w"> </span>data/
</span></code></pre></div>
<ul>
<li>重新启动Jenkins容器后，由于Jenkins需要下载大量内容，但是由于默认下载地址下载速度较慢，需要重新设置下载地址为国内镜像站</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-165-1"><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a><span class="c1"># 修改数据卷中的hudson.model.UpdateCenter.xml文件</span>
</span><span id="__span-165-2"><a id="__codelineno-165-2" name="__codelineno-165-2" href="#__codelineno-165-2"></a>&lt;?xml<span class="w"> </span><span class="nv">version</span><span class="o">=</span><span class="s1">&#39;1.1&#39;</span><span class="w"> </span><span class="nv">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span>?&gt;
</span><span id="__span-165-3"><a id="__codelineno-165-3" name="__codelineno-165-3" href="#__codelineno-165-3"></a>&lt;sites&gt;
</span><span id="__span-165-4"><a id="__codelineno-165-4" name="__codelineno-165-4" href="#__codelineno-165-4"></a><span class="w">  </span>&lt;site&gt;
</span><span id="__span-165-5"><a id="__codelineno-165-5" name="__codelineno-165-5" href="#__codelineno-165-5"></a><span class="w">    </span>&lt;id&gt;default&lt;/id&gt;
</span><span id="__span-165-6"><a id="__codelineno-165-6" name="__codelineno-165-6" href="#__codelineno-165-6"></a><span class="w">    </span>&lt;url&gt;https://updates.jenkins.io/update-center.json&lt;/url&gt;
</span><span id="__span-165-7"><a id="__codelineno-165-7" name="__codelineno-165-7" href="#__codelineno-165-7"></a><span class="w">  </span>&lt;/site&gt;
</span><span id="__span-165-8"><a id="__codelineno-165-8" name="__codelineno-165-8" href="#__codelineno-165-8"></a>&lt;/sites&gt;
</span><span id="__span-165-9"><a id="__codelineno-165-9" name="__codelineno-165-9" href="#__codelineno-165-9"></a><span class="c1"># 将下载地址替换为http://mirror.esuni.jp/jenkins/updates/update-center.json</span>
</span><span id="__span-165-10"><a id="__codelineno-165-10" name="__codelineno-165-10" href="#__codelineno-165-10"></a>&lt;?xml<span class="w"> </span><span class="nv">version</span><span class="o">=</span><span class="s1">&#39;1.1&#39;</span><span class="w"> </span><span class="nv">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span>?&gt;
</span><span id="__span-165-11"><a id="__codelineno-165-11" name="__codelineno-165-11" href="#__codelineno-165-11"></a>&lt;sites&gt;
</span><span id="__span-165-12"><a id="__codelineno-165-12" name="__codelineno-165-12" href="#__codelineno-165-12"></a><span class="w">  </span>&lt;site&gt;
</span><span id="__span-165-13"><a id="__codelineno-165-13" name="__codelineno-165-13" href="#__codelineno-165-13"></a><span class="w">    </span>&lt;id&gt;default&lt;/id&gt;
</span><span id="__span-165-14"><a id="__codelineno-165-14" name="__codelineno-165-14" href="#__codelineno-165-14"></a><span class="w">    </span>&lt;url&gt;http://mirror.esuni.jp/jenkins/updates/update-center.json&lt;/url&gt;
</span><span id="__span-165-15"><a id="__codelineno-165-15" name="__codelineno-165-15" href="#__codelineno-165-15"></a><span class="w">  </span>&lt;/site&gt;
</span><span id="__span-165-16"><a id="__codelineno-165-16" name="__codelineno-165-16" href="#__codelineno-165-16"></a>&lt;/sites&gt;
</span><span id="__span-165-17"><a id="__codelineno-165-17" name="__codelineno-165-17" href="#__codelineno-165-17"></a><span class="c1"># 清华大学的插件源也可以https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span>
</span></code></pre></div>
<ul>
<li>再次重启Jenkins容器，访问Jenkins（需要稍微等会）</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">Jenkins首页</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124204517433" src="../../images/DevOps/image-20211124204517433.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211124203336300" src="../../images/DevOps/image-20211124203336300.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>查看密码登录Jenkins，并登录下载插件</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-166-1"><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>jenkins<span class="w"> </span>cat<span class="w"> </span>/var/jenkins_home/secrets/initialAdminPassword
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">登录并下载插件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124205050484" src="../../images/DevOps/image-20211124205050484.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211124205513465" src="../../images/DevOps/image-20211124205513465.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>选择需要安装的插件</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">选择需要安装的插件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211124205854418" src="../../images/DevOps/image-20211124205854418.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211124205858730" src="../../images/DevOps/image-20211124205858730.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211124205917317" src="../../images/DevOps/image-20211124205917317.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>下载完毕设置信息进入首页（可能会出现下载失败的插件）</li>
</ul>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="image-20211124211635550" src="../../images/DevOps/image-20211124211635550.png" /></td>
</tr>
<tr>
<td><img alt="image-20211124211700999" src="../../images/DevOps/image-20211124211700999.png" /></td>
</tr>
<tr>
<td><img alt="image-20211124211720836" src="../../images/DevOps/image-20211124211720836.png" /></td>
</tr>
</tbody>
</table>
<h5 id="53-jenkins"><a class="toclink" href="../../devops/#53-jenkins">5.3 Jenkins入门配置</a></h5>
<p>由于Jenkins需要从Git拉取代码、需要本地构建、甚至需要直接发布自定义镜像到Docker仓库，所以Jenkins需要配置大量内容。</p>
<h6 id="531"><a class="toclink" href="../../devops/#531">5.3.1 构建任务</a></h6>
<p>准备好GitLab仓库中的项目，并且通过Jenkins配置项目的实现当前项目的<a href="">DevOps</a>基本流程。</p>
<ul>
<li>构建Maven工程发布到GitLab（Gitee、Github均可）</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">GitLab查看项目</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125195818670" src="../../images/DevOps/image-20211125195818670.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>Jenkins点击左侧导航新建任务</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">新建任务</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125163541645" src="../../images/DevOps/image-20211125163541645.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>选择自由风格构建任务</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">构建任务</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125170350811" src="../../images/DevOps/image-20211125170350811.png" /></td>
</tr>
</tbody>
</table>
<h6 id="531_1"><a class="toclink" href="../../devops/#531_1">5.3.1 配置源码拉取地址</a></h6>
<p>Jenkins需要将Git上存放的源码存储到Jenkins服务所在磁盘的本地</p>
<ul>
<li>配置任务源码拉取的地址</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">源码管理</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125170418337" src="../../images/DevOps/image-20211125170418337.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>Jenkins立即构建</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">点击任务test中的立即构建</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125200218093" src="../../images/DevOps/image-20211125200218093.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>查看构建工程的日志，点击上述③的任务条即可</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">查看任务拉取Git源码日志</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125201701443" src="../../images/DevOps/image-20211125201701443.png" /></td>
</tr>
</tbody>
</table>
<p>可以看到源码已经拉取带Jenkins本地，可以根据第三行日志信息，查看Jenkins本地拉取到的源码。</p>
<ul>
<li>查看Jenkins容器中<a href="">/var/jenkins_home/workspace/test</a>的源码</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">源码存放位置</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125201919108" src="../../images/DevOps/image-20211125201919108.png" /></td>
</tr>
</tbody>
</table>
<h6 id="532-maven"><a class="toclink" href="../../devops/#532-maven">5.3.2 配置Maven构建代码</a></h6>
<p>代码拉取到Jenkins本地后，需要在Jenkins中对代码进行构建，这里需要Maven的环境，而Maven需要Java的环境，接下来需要在Jenkins中安装JDK和Maven，并且配置到Jenkins服务。</p>
<ul>
<li>准备JDK、Maven压缩包通过数据卷映射到Jenkins容器内部</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">数据卷存放位置</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125203757232" src="../../images/DevOps/image-20211125203757232.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>解压压缩包，并配置Maven的settings.xml</li>
</ul>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-167-1"><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a><span class="cm">&lt;!-- 阿里云镜像地址 --&gt;</span>
</span><span id="__span-167-2"><a id="__codelineno-167-2" name="__codelineno-167-2" href="#__codelineno-167-2"></a><span class="nt">&lt;mirror&gt;</span><span class="w">  </span>
</span><span id="__span-167-3"><a id="__codelineno-167-3" name="__codelineno-167-3" href="#__codelineno-167-3"></a><span class="w">    </span><span class="nt">&lt;id&gt;</span>alimaven<span class="nt">&lt;/id&gt;</span><span class="w">  </span>
</span><span id="__span-167-4"><a id="__codelineno-167-4" name="__codelineno-167-4" href="#__codelineno-167-4"></a><span class="w">    </span><span class="nt">&lt;name&gt;</span>aliyun<span class="w"> </span>maven<span class="nt">&lt;/name&gt;</span><span class="w">  </span>
</span><span id="__span-167-5"><a id="__codelineno-167-5" name="__codelineno-167-5" href="#__codelineno-167-5"></a><span class="w">    </span><span class="nt">&lt;url&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="nt">&lt;/url&gt;</span>
</span><span id="__span-167-6"><a id="__codelineno-167-6" name="__codelineno-167-6" href="#__codelineno-167-6"></a><span class="w">    </span><span class="nt">&lt;mirrorOf&gt;</span>central<span class="nt">&lt;/mirrorOf&gt;</span><span class="w">          </span>
</span><span id="__span-167-7"><a id="__codelineno-167-7" name="__codelineno-167-7" href="#__codelineno-167-7"></a><span class="nt">&lt;/mirror&gt;</span>
</span><span id="__span-167-8"><a id="__codelineno-167-8" name="__codelineno-167-8" href="#__codelineno-167-8"></a><span class="cm">&lt;!-- JDK1.8编译插件 --&gt;</span>
</span><span id="__span-167-9"><a id="__codelineno-167-9" name="__codelineno-167-9" href="#__codelineno-167-9"></a><span class="nt">&lt;profile&gt;</span>
</span><span id="__span-167-10"><a id="__codelineno-167-10" name="__codelineno-167-10" href="#__codelineno-167-10"></a><span class="w">    </span><span class="nt">&lt;id&gt;</span>jdk-1.8<span class="nt">&lt;/id&gt;</span>
</span><span id="__span-167-11"><a id="__codelineno-167-11" name="__codelineno-167-11" href="#__codelineno-167-11"></a><span class="w">    </span><span class="nt">&lt;activation&gt;</span>
</span><span id="__span-167-12"><a id="__codelineno-167-12" name="__codelineno-167-12" href="#__codelineno-167-12"></a><span class="w">        </span><span class="nt">&lt;activeByDefault&gt;</span>true<span class="nt">&lt;/activeByDefault&gt;</span>
</span><span id="__span-167-13"><a id="__codelineno-167-13" name="__codelineno-167-13" href="#__codelineno-167-13"></a><span class="w">        </span><span class="nt">&lt;jdk&gt;</span>1.8<span class="nt">&lt;/jdk&gt;</span>
</span><span id="__span-167-14"><a id="__codelineno-167-14" name="__codelineno-167-14" href="#__codelineno-167-14"></a><span class="w">    </span><span class="nt">&lt;/activation&gt;</span>
</span><span id="__span-167-15"><a id="__codelineno-167-15" name="__codelineno-167-15" href="#__codelineno-167-15"></a><span class="w">    </span><span class="nt">&lt;properties&gt;</span>
</span><span id="__span-167-16"><a id="__codelineno-167-16" name="__codelineno-167-16" href="#__codelineno-167-16"></a><span class="w">        </span><span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
</span><span id="__span-167-17"><a id="__codelineno-167-17" name="__codelineno-167-17" href="#__codelineno-167-17"></a><span class="w">        </span><span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
</span><span id="__span-167-18"><a id="__codelineno-167-18" name="__codelineno-167-18" href="#__codelineno-167-18"></a><span class="w">        </span><span class="nt">&lt;maven.compiler.compilerVersion&gt;</span>1.8<span class="nt">&lt;/maven.compiler.compilerVersion&gt;</span>
</span><span id="__span-167-19"><a id="__codelineno-167-19" name="__codelineno-167-19" href="#__codelineno-167-19"></a><span class="w">    </span><span class="nt">&lt;/properties&gt;</span><span class="w">        </span>
</span><span id="__span-167-20"><a id="__codelineno-167-20" name="__codelineno-167-20" href="#__codelineno-167-20"></a><span class="nt">&lt;/profile&gt;</span>
</span></code></pre></div>
<ul>
<li>Jenkins配置JDK&amp;Maven并保存</li>
</ul>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="image-20211125204811759" src="../../images/DevOps/image-20211125204811759.png" /></td>
</tr>
<tr>
<td><img alt="image-20211125204818869" src="../../images/DevOps/image-20211125204818869.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>配置Jenkins任务构建代码</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">配置Maven构建代码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125205027013" src="../../images/DevOps/image-20211125205027013.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211125205020738" src="../../images/DevOps/image-20211125205020738.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>立即构建测试，查看target下的jar包</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">构建源码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125205240208" src="../../images/DevOps/image-20211125205240208.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211125205725948" src="../../images/DevOps/image-20211125205725948.png" /></td>
</tr>
</tbody>
</table>
<h6 id="533-publish"><a class="toclink" href="../../devops/#533-publish">5.3.3 配置Publish发布&amp;远程操作</a></h6>
<p>jar包构建好之后，就可以根据情况发布到测试或生产环境，这里需要用到之前下载好的插件Publish Over SSH。</p>
<ul>
<li>配置Publish Over SSH连接测试、生产环境</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">Publish Over SSH配置</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125210148202" src="../../images/DevOps/image-20211125210148202.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>配置任务的构建后操作，发布jar包到目标服务</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">配置构建后操作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125205027013" src="../../images/DevOps/image-20211125205027013.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211125210424346" src="../../images/DevOps/image-20211125210424346.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211125210626631" src="../../images/DevOps/image-20211125210626631.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>立即构建任务，并去目标服务查看</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">立即构建</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211125210755556" src="../../images/DevOps/image-20211125210755556.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211125210826057" src="../../images/DevOps/image-20211125210826057.png" /></td>
</tr>
</tbody>
</table>
<h4 id="cicd"><a class="toclink" href="../../devops/#cicd">六、CI、CD入门操作</a></h4>
<p>基于Jenkins拉取GitLab的SpringBoot代码进行构建发布到测试环境实现持续集成</p>
<p>基于Jenkins拉取GitLab指定发行版本的SpringBoot代码进行构建发布到生产环境实现CD实现持续部署</p>
<h5 id="61"><a class="toclink" href="../../devops/#61">6.1 持续集成</a></h5>
<p>为了让程序代码可以自动推送到测试环境基于Docker服务运行，需要添加Docker配置和脚本文件让程序可以在集成到主干的同时运行起来。</p>
<ul>
<li>添加Dockerfile文件</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">构建自定义镜像</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126161304485" src="../../images/DevOps/image-20211126161304485.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>添加docker-compose.yml文件</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">加载自定义镜像启动容器</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126161331991" src="../../images/DevOps/image-20211126161331991.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>追加Jenkins构建后操作脚本命令</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">构建后发布并执行脚本命令</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126161408514" src="../../images/DevOps/image-20211126161408514.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>发布到GitLab后由Jenkins立即构建并托送到目标服务器</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">构建日志</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126161448527" src="../../images/DevOps/image-20211126161448527.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>测试部署到目标服务器程序</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">查看目标服务器并测试接口</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126161504715" src="../../images/DevOps/image-20211126161504715.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211126161509411" src="../../images/DevOps/image-20211126161509411.png" /></td>
</tr>
</tbody>
</table>
<h5 id="62"><a class="toclink" href="../../devops/#62">6.2 持续交付、部署</a></h5>
<p>程序代码在经过多次集成操作到达最终可以交付，持续交付整体流程和持续集成类似，不过需要选取指定的发行版本</p>
<ul>
<li>下载Git Parameter插件</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">下载Git Parameter</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126165209057" src="../../images/DevOps/image-20211126165209057.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>设置项目参数化构建</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">基于Git标签构建</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126165444124" src="../../images/DevOps/image-20211126165444124.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211126172828266" src="../../images/DevOps/image-20211126172828266.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>给项目添加tag版本</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">添加tag版本</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126165639286" src="../../images/DevOps/image-20211126165639286.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>任务构建时，采用Shell方式构建，拉取指定tag版本代码</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">切换指定标签并构建项目</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126174715028" src="../../images/DevOps/image-20211126174715028.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>基于Parameter构建任务，任务发布到目标服务器</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">构建任务</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211126174159487" src="../../images/DevOps/image-20211126174159487.png" /></td>
</tr>
</tbody>
</table>
<h4 id="sonar-qube"><a class="toclink" href="../../devops/#sonar-qube">七、集成Sonar Qube</a></h4>
<h5 id="71-sonar-qube"><a class="toclink" href="../../devops/#71-sonar-qube">7.1 Sonar Qube介绍</a></h5>
<p>Sonar Qube是一个开源的代码分析平台，支持Java、Python、PHP、JavaScript、CSS等25种以上的语言，可以检测出重复代码、代码漏洞、代码规范和安全性漏洞的问题。</p>
<p>Sonar Qube可以与多种软件整合进行代码扫描，比如Maven，Gradle，Git，Jenkins等，并且会将代码检测结果推送回Sonar Qube并且在系统提供的UI界面上显示出来</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Sonar Qube的UI界面</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129190039986" src="../../images/DevOps/image-20211129190039986.png" /></td>
</tr>
</tbody>
</table>
<h5 id="72-sonar-qube"><a class="toclink" href="../../devops/#72-sonar-qube">7.2 Sonar Qube环境搭建</a></h5>
<h6 id="721-sonar-qube"><a class="toclink" href="../../devops/#721-sonar-qube">7.2.1 Sonar Qube安装</a></h6>
<p>Sonar Qube在7.9版本中已经放弃了对MySQL的支持，并且建议在商业环境中采用PostgreSQL，那么安装Sonar Qube时需要依赖PostgreSQL。</p>
<p>并且这里会安装Sonar Qube的长期支持版本<a href="">8.9</a></p>
<ul>
<li>拉取镜像</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-168-1"><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a>docker<span class="w"> </span>pull<span class="w"> </span>postgres
</span><span id="__span-168-2"><a id="__codelineno-168-2" name="__codelineno-168-2" href="#__codelineno-168-2"></a>docker<span class="w"> </span>pull<span class="w"> </span>sonarqube:8.9.3-community
</span></code></pre></div>
<ul>
<li>编写docker-compoe.yml</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-169-1"><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a>version: &quot;3.1&quot;
</span><span id="__span-169-2"><a id="__codelineno-169-2" name="__codelineno-169-2" href="#__codelineno-169-2"></a>services:
</span><span id="__span-169-3"><a id="__codelineno-169-3" name="__codelineno-169-3" href="#__codelineno-169-3"></a>  db:
</span><span id="__span-169-4"><a id="__codelineno-169-4" name="__codelineno-169-4" href="#__codelineno-169-4"></a>    image: postgres
</span><span id="__span-169-5"><a id="__codelineno-169-5" name="__codelineno-169-5" href="#__codelineno-169-5"></a>    container_name: db
</span><span id="__span-169-6"><a id="__codelineno-169-6" name="__codelineno-169-6" href="#__codelineno-169-6"></a>    ports:
</span><span id="__span-169-7"><a id="__codelineno-169-7" name="__codelineno-169-7" href="#__codelineno-169-7"></a>      - 5432:5432
</span><span id="__span-169-8"><a id="__codelineno-169-8" name="__codelineno-169-8" href="#__codelineno-169-8"></a>    networks:
</span><span id="__span-169-9"><a id="__codelineno-169-9" name="__codelineno-169-9" href="#__codelineno-169-9"></a>      - sonarnet
</span><span id="__span-169-10"><a id="__codelineno-169-10" name="__codelineno-169-10" href="#__codelineno-169-10"></a>    environment:
</span><span id="__span-169-11"><a id="__codelineno-169-11" name="__codelineno-169-11" href="#__codelineno-169-11"></a>      POSTGRES_USER: sonar
</span><span id="__span-169-12"><a id="__codelineno-169-12" name="__codelineno-169-12" href="#__codelineno-169-12"></a>      POSTGRES_PASSWORD: sonar
</span><span id="__span-169-13"><a id="__codelineno-169-13" name="__codelineno-169-13" href="#__codelineno-169-13"></a>  sonarqube:
</span><span id="__span-169-14"><a id="__codelineno-169-14" name="__codelineno-169-14" href="#__codelineno-169-14"></a>    image: sonarqube:8.9.3-community
</span><span id="__span-169-15"><a id="__codelineno-169-15" name="__codelineno-169-15" href="#__codelineno-169-15"></a>    container_name: sonarqube
</span><span id="__span-169-16"><a id="__codelineno-169-16" name="__codelineno-169-16" href="#__codelineno-169-16"></a>    depends_on:
</span><span id="__span-169-17"><a id="__codelineno-169-17" name="__codelineno-169-17" href="#__codelineno-169-17"></a>      - db
</span><span id="__span-169-18"><a id="__codelineno-169-18" name="__codelineno-169-18" href="#__codelineno-169-18"></a>    ports:
</span><span id="__span-169-19"><a id="__codelineno-169-19" name="__codelineno-169-19" href="#__codelineno-169-19"></a>      - &quot;9000:9000&quot;
</span><span id="__span-169-20"><a id="__codelineno-169-20" name="__codelineno-169-20" href="#__codelineno-169-20"></a>    networks:
</span><span id="__span-169-21"><a id="__codelineno-169-21" name="__codelineno-169-21" href="#__codelineno-169-21"></a>      - sonarnet
</span><span id="__span-169-22"><a id="__codelineno-169-22" name="__codelineno-169-22" href="#__codelineno-169-22"></a>    environment:
</span><span id="__span-169-23"><a id="__codelineno-169-23" name="__codelineno-169-23" href="#__codelineno-169-23"></a>      SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar
</span><span id="__span-169-24"><a id="__codelineno-169-24" name="__codelineno-169-24" href="#__codelineno-169-24"></a>      SONAR_JDBC_USERNAME: sonar
</span><span id="__span-169-25"><a id="__codelineno-169-25" name="__codelineno-169-25" href="#__codelineno-169-25"></a>      SONAR_JDBC_PASSWORD: sonar
</span><span id="__span-169-26"><a id="__codelineno-169-26" name="__codelineno-169-26" href="#__codelineno-169-26"></a>networks:
</span><span id="__span-169-27"><a id="__codelineno-169-27" name="__codelineno-169-27" href="#__codelineno-169-27"></a>  sonarnet:
</span><span id="__span-169-28"><a id="__codelineno-169-28" name="__codelineno-169-28" href="#__codelineno-169-28"></a>    driver: bridge
</span></code></pre></div>
<ul>
<li>启动容器</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-170-1"><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a>docker-compose up -d
</span></code></pre></div>
<ul>
<li>需要设置sysctl.conf文件信息</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">设置vm.max_map_count</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211207145215817" src="../../images/DevOps/image-20211207145215817.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211207145342350" src="../../images/DevOps/image-20211207145342350.png" /></td>
</tr>
</tbody>
</table>
<p>并执行命令刷新</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-171-1"><a id="__codelineno-171-1" name="__codelineno-171-1" href="#__codelineno-171-1"></a>sysctl -p
</span></code></pre></div>
<ul>
<li>重新启动需要一定时间启动，可以可以查看容器日志，看到如下内容代表启动成功</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">容器日志</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129191426344" src="../../images/DevOps/image-20211129191426344.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>访问Sonar Qube首页</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">登录</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129191537050" src="../../images/DevOps/image-20211129191537050.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>还需要重新设置一次密码</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">重新设置密码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129193824428" src="../../images/DevOps/image-20211129193824428.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>Sonar Qube首页</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">Sonar Qube首页</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129194148239" src="../../images/DevOps/image-20211129194148239.png" /></td>
</tr>
</tbody>
</table>
<h6 id="722"><a class="toclink" href="../../devops/#722">7.2.2 安装中文插件</a></h6>
<table>
<thead>
<tr>
<th style="text-align: center;">安装中文插件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129194621820" src="../../images/DevOps/image-20211129194621820.png" /></td>
</tr>
</tbody>
</table>
<p>安装成功后需要重启，安装失败重新点击install重装即可。</p>
<p>安装成功后，会查看到重启按钮，点击即可</p>
<table>
<thead>
<tr>
<th style="text-align: center;">重启按钮</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129194748765" src="../../images/DevOps/image-20211129194748765.png" /></td>
</tr>
</tbody>
</table>
<p>重启后查看效果</p>
<table>
<thead>
<tr>
<th style="text-align: center;">首页效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129194931944" src="../../images/DevOps/image-20211129194931944.png" /></td>
</tr>
</tbody>
</table>
<h5 id="73-sonar-qube"><a class="toclink" href="../../devops/#73-sonar-qube">7.3 Sonar Qube基本使用</a></h5>
<p>Sonar Qube的使用方式很多，Maven可以整合，也可以采用sonar-scanner的方式，再查看Sonar Qube的检测效果</p>
<h6 id="731-maven"><a class="toclink" href="../../devops/#731-maven">7.3.1 Maven实现代码检测</a></h6>
<ul>
<li>修改Maven的settings.xml文件配置Sonar Qube信息</li>
</ul>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-172-1"><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a><span class="nt">&lt;profile&gt;</span>
</span><span id="__span-172-2"><a id="__codelineno-172-2" name="__codelineno-172-2" href="#__codelineno-172-2"></a><span class="w">    </span><span class="nt">&lt;id&gt;</span>sonar<span class="nt">&lt;/id&gt;</span>
</span><span id="__span-172-3"><a id="__codelineno-172-3" name="__codelineno-172-3" href="#__codelineno-172-3"></a><span class="w">    </span><span class="nt">&lt;activation&gt;</span>
</span><span id="__span-172-4"><a id="__codelineno-172-4" name="__codelineno-172-4" href="#__codelineno-172-4"></a><span class="w">        </span><span class="nt">&lt;activeByDefault&gt;</span>true<span class="nt">&lt;/activeByDefault&gt;</span>
</span><span id="__span-172-5"><a id="__codelineno-172-5" name="__codelineno-172-5" href="#__codelineno-172-5"></a><span class="w">    </span><span class="nt">&lt;/activation&gt;</span>
</span><span id="__span-172-6"><a id="__codelineno-172-6" name="__codelineno-172-6" href="#__codelineno-172-6"></a><span class="w">    </span><span class="nt">&lt;properties&gt;</span>
</span><span id="__span-172-7"><a id="__codelineno-172-7" name="__codelineno-172-7" href="#__codelineno-172-7"></a><span class="w">        </span><span class="nt">&lt;sonar.login&gt;</span>admin<span class="nt">&lt;/sonar.login&gt;</span>
</span><span id="__span-172-8"><a id="__codelineno-172-8" name="__codelineno-172-8" href="#__codelineno-172-8"></a><span class="w">        </span><span class="nt">&lt;sonar.password&gt;</span>123456789<span class="nt">&lt;/sonar.password&gt;</span>
</span><span id="__span-172-9"><a id="__codelineno-172-9" name="__codelineno-172-9" href="#__codelineno-172-9"></a><span class="w">        </span><span class="nt">&lt;sonar.host.url&gt;</span>http://192.168.11.11:9000<span class="nt">&lt;/sonar.host.url&gt;</span>
</span><span id="__span-172-10"><a id="__codelineno-172-10" name="__codelineno-172-10" href="#__codelineno-172-10"></a><span class="w">    </span><span class="nt">&lt;/properties&gt;</span>
</span><span id="__span-172-11"><a id="__codelineno-172-11" name="__codelineno-172-11" href="#__codelineno-172-11"></a><span class="nt">&lt;/profile&gt;</span>
</span></code></pre></div>
<ul>
<li>在代码位置执行命令：mvn sonar:sonar</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">执行代码检测</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129195430146" src="../../images/DevOps/image-20211129195430146.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>查看Sonar Qube界面检测结果</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">Sonar Qube检测结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129195503762" src="../../images/DevOps/image-20211129195503762.png" /></td>
</tr>
</tbody>
</table>
<h6 id="732-sonar-scanner"><a class="toclink" href="../../devops/#732-sonar-scanner">7.3.2 Sonar-scanner实现代码检测</a></h6>
<ul>
<li>下载Sonar-scanner：https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</li>
</ul>
<p>下载4.6.x版本即可，要求Linux版本</p>
<ul>
<li>
<p>解压并配置sonar服务端信息</p>
</li>
<li>
<p>由于是zip压缩包，需要安装unzip解压插件</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-173-1"><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a>yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>unzip
</span></code></pre></div>
</li>
<li>
<p>解压压缩包</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-174-1"><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a>unzip<span class="w"> </span>sonar-scanner-cli/sonar-scanner-cli-4.6.0.2311-linux.zip
</span></code></pre></div>
</li>
<li>
<p>配置sonarQube服务端地址，修改conf下的sonar-scanner.properties</p>
<table>
<thead>
<tr>
<th style="text-align: center;">配置服务端信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130140043382" src="../../images/DevOps/image-20211130140043382.png" /></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>执行命令检测代码</p>
</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-175-1"><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a><span class="c1"># 在项目所在目录执行以下命令</span>
</span><span id="__span-175-2"><a id="__codelineno-175-2" name="__codelineno-175-2" href="#__codelineno-175-2"></a>~/sonar-scanner/bin/sonar-scanner<span class="w"> </span>-Dsonar.sources<span class="o">=</span>./<span class="w"> </span>-Dsonar.projectname<span class="o">=</span>demo<span class="w"> </span>-Dsonar.projectKey<span class="o">=</span>java<span class="w"> </span>-Dsonar.java.binaries<span class="o">=</span>target/
</span></code></pre></div>
<p><a href="">Ps：主要查看我的sonar-scanner执行命令的位置</a></p>
<table>
<thead>
<tr>
<th style="text-align: center;">查看日志信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130141303457" src="../../images/DevOps/image-20211130141303457.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>查看SonarQube界面检测结果</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">检测结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130144608025" src="../../images/DevOps/image-20211130144608025.png" /></td>
</tr>
</tbody>
</table>
<h5 id="74-jenkinssonar-qube"><a class="toclink" href="../../devops/#74-jenkinssonar-qube">7.4 Jenkins集成Sonar Qube</a></h5>
<p>Jenkins继承Sonar Qube实现代码扫描需要先下载整合插件</p>
<h6 id="741-jenkins"><a class="toclink" href="../../devops/#741-jenkins">7.4.1 Jenkins安装插件</a></h6>
<table>
<thead>
<tr>
<th style="text-align: center;">下载Sonar Qube插件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129201625561" src="../../images/DevOps/image-20211129201625561.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211129201607240" src="../../images/DevOps/image-20211129201607240.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211129202147390" src="../../images/DevOps/image-20211129202147390.png" /></td>
</tr>
</tbody>
</table>
<h6 id="742-jenkinssonar-qube"><a class="toclink" href="../../devops/#742-jenkinssonar-qube">7.4.2 Jenkins配置Sonar Qube</a></h6>
<ul>
<li>开启Sonar Qube权限验证</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">开启Sonar Qube权限校验</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130144850186" src="../../images/DevOps/image-20211130144850186.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>获取Sonar Qube的令牌</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">获取令牌</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211129203102334" src="../../images/DevOps/image-20211129203102334.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>配置Jenkins的Sonar Qube信息</li>
</ul>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="image-20211129203235019" src="../../images/DevOps/image-20211129203235019.png" /></td>
</tr>
<tr>
<td><img alt="image-20211129203342171" src="../../images/DevOps/image-20211129203342171.png" /></td>
</tr>
<tr>
<td><img alt="image-20211129203457604" src="../../images/DevOps/image-20211129203457604.png" /></td>
</tr>
</tbody>
</table>
<h6 id="743-sonar-scanner"><a class="toclink" href="../../devops/#743-sonar-scanner">7.4.3 配置Sonar-scanner</a></h6>
<ul>
<li>将Sonar-scaner添加到Jenkins数据卷中并配置全局配置</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">配置Sonar-scanner</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130153628925" src="../../images/DevOps/image-20211130153628925.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>配置任务的Sonar-scanner</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">配置任务的Sonar-scanner</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130155849143" src="../../images/DevOps/image-20211130155849143.png" /></td>
</tr>
</tbody>
</table>
<h6 id="744"><a class="toclink" href="../../devops/#744">7.4.4 构建任务</a></h6>
<table>
<thead>
<tr>
<th style="text-align: center;">构建任务</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130160017465" src="../../images/DevOps/image-20211130160017465.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211130160047648" src="../../images/DevOps/image-20211130160047648.png" /></td>
</tr>
</tbody>
</table>
<h4 id="harbor"><a class="toclink" href="../../devops/#harbor">八、集成Harbor</a></h4>
<h5 id="81-harbor"><a class="toclink" href="../../devops/#81-harbor">8.1 Harbor介绍</a></h5>
<p>前面在部署项目时，我们主要采用Jenkins推送jar包到指定服务器，再通过脚本命令让目标服务器对当前jar进行部署，这种方式在项目较多时，每个目标服务器都需要将jar包制作成自定义镜像再通过docker进行启动，重复操作比较多，会降低项目部署时间。</p>
<p>我们可以通过Harbor作为私有的Docker镜像仓库。让Jenkins统一将项目打包并制作成Docker镜像发布到Harbor仓库中，只需要通知目标服务，让目标服务统一去Harbor仓库上拉取镜像并在本地部署即可。</p>
<p>Docker官方提供了Registry镜像仓库，但是Registry的功能相对简陋。Harbor是VMware公司提供的一款镜像仓库，提供了权限控制、分布式发布、强大的安全扫描与审查机制等功能</p>
<h5 id="82-harbor"><a class="toclink" href="../../devops/#82-harbor">8.2 Harbor安装</a></h5>
<p>这里采用原生的方式安装Harbor。</p>
<ul>
<li>
<p>下载Harbor安装包：https://github.com/goharbor/harbor/releases/download/v2.3.4/harbor-offline-installer-v2.3.4.tgz</p>
</li>
<li>
<p>拖拽到Linux并解压：</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-176-1"><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a>tar -zxvf harbor-offline-installer-v2.3.4.tgz -C /usr/local/
</span></code></pre></div>
<ul>
<li>
<p>修改Harbor配置文件：</p>
</li>
<li>
<p>首先复制一份harbor.yml配置</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-177-1"><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a>cp<span class="w"> </span>harbor.yml.tmpl<span class="w"> </span>harbor.yml
</span></code></pre></div>
</li>
<li>
<p>编辑harbor.yml配置文件</p>
<table>
<thead>
<tr>
<th style="text-align: center;">配置Harbor文件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130215555218" src="../../images/DevOps/image-20211130215555218.png" /></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>启动Harbor</p>
</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-178-1"><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a>./install.sh
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">查看日志</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130215941857" src="../../images/DevOps/image-20211130215941857.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>登录Harbor</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">登录Harbor</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130220028840" src="../../images/DevOps/image-20211130220028840.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>首页信息</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">首页信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211130220111602" src="../../images/DevOps/image-20211130220111602.png" /></td>
</tr>
</tbody>
</table>
<h5 id="83-harbor"><a class="toclink" href="../../devops/#83-harbor">8.3 Harbor使用方式</a></h5>
<p>Harbor作为镜像仓库，主要的交互方式就是将镜像上传到Harbor上，以及从Harbor上下载指定镜像</p>
<p>在传输镜像前，可以先使用Harbor提供的权限管理，将项目设置为私有项目，并对不同用户设置不同角色，从而更方便管理镜像。</p>
<h6 id="831"><a class="toclink" href="../../devops/#831">8.3.1 添加用户构建项目</a></h6>
<ul>
<li>创建用户</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">创建用户</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211201213427157" src="../../images/DevOps/image-20211201213427157.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>构建项目（设置为私有）</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">构建项目</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211201213751780" src="../../images/DevOps/image-20211201213751780.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>给项目追加用户</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">追加用户管理</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211201213832458" src="../../images/DevOps/image-20211201213832458.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>切换测试用户</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">切换测试用户</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211201214008303" src="../../images/DevOps/image-20211201214008303.png" /></td>
</tr>
</tbody>
</table>
<h6 id="832-harbor"><a class="toclink" href="../../devops/#832-harbor">8.3.2 发布镜像到Harbor</a></h6>
<ul>
<li>修改镜像名称</li>
</ul>
<p>名称要求：<a href="">harbor地址/项目名/镜像名:版本</a></p>
<table>
<thead>
<tr>
<th>修改镜像名称</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="image-20211201221040200" src="../../images/DevOps/image-20211201221040200.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>修改daemon.json，支持Docker仓库，并重启Docker</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">修改daemon.json，支持Docker仓库</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211201215931237" src="../../images/DevOps/image-20211201215931237.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>设置登录仓库信息</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-179-1"><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a>docker<span class="w"> </span>login<span class="w"> </span>-u<span class="w"> </span>用户名<span class="w"> </span>-p<span class="w"> </span>密码<span class="w"> </span>Harbor地址
</span></code></pre></div>
<ul>
<li>推送镜像到Harbor</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">推送镜像到Harbor</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211201221225196" src="../../images/DevOps/image-20211201221225196.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211201221300055" src="../../images/DevOps/image-20211201221300055.png" /></td>
</tr>
</tbody>
</table>
<h6 id="833-harborls"><a class="toclink" href="../../devops/#833-harborls">8.3.3 从Harbor拉取镜像ls</a></h6>
<p>跟传统方式一样，不过需要先配置<a href="">/etc/docker/daemon.json</a>文件</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-180-1"><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a><span class="p">{</span>
</span><span id="__span-180-2"><a id="__codelineno-180-2" name="__codelineno-180-2" href="#__codelineno-180-2"></a><span class="w">        </span><span class="nt">&quot;registry-mirrors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;https://pee6w651.mirror.aliyuncs.com&quot;</span><span class="p">],</span>
</span><span id="__span-180-3"><a id="__codelineno-180-3" name="__codelineno-180-3" href="#__codelineno-180-3"></a><span class="w">        </span><span class="nt">&quot;insecure-registries&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;192.168.11.11:80&quot;</span><span class="p">]</span>
</span><span id="__span-180-4"><a id="__codelineno-180-4" name="__codelineno-180-4" href="#__codelineno-180-4"></a><span class="p">}</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">拉取镜像</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211201222450091" src="../../images/DevOps/image-20211201222450091.png" /></td>
</tr>
</tbody>
</table>
<h6 id="834-jenkinsdocker"><a class="toclink" href="../../devops/#834-jenkinsdocker">8.3.4 Jenkins容器使用宿主机Docker</a></h6>
<p>构建镜像和发布镜像到harbor都需要使用到docker命令。而在Jenkins容器内部安装Docker官方推荐直接采用宿主机带的Docker即可。</p>
<p>设置Jenkins容器使用宿主机Docker</p>
<ul>
<li>设置宿主机docker.sock权限：</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-181-1"><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a>sudo<span class="w"> </span>chown<span class="w"> </span>root:root<span class="w"> </span>/var/run/docker.sock
</span><span id="__span-181-2"><a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a>sudo<span class="w"> </span>chmod<span class="w"> </span>o+rw<span class="w"> </span>/var/run/docker.sock
</span></code></pre></div>
<ul>
<li>添加数据卷</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-182-1"><a id="__codelineno-182-1" name="__codelineno-182-1" href="#__codelineno-182-1"></a>version: &quot;3.1&quot;
</span><span id="__span-182-2"><a id="__codelineno-182-2" name="__codelineno-182-2" href="#__codelineno-182-2"></a>services:
</span><span id="__span-182-3"><a id="__codelineno-182-3" name="__codelineno-182-3" href="#__codelineno-182-3"></a>  jenkins:
</span><span id="__span-182-4"><a id="__codelineno-182-4" name="__codelineno-182-4" href="#__codelineno-182-4"></a>    image: jenkins/jenkins
</span><span id="__span-182-5"><a id="__codelineno-182-5" name="__codelineno-182-5" href="#__codelineno-182-5"></a>    container_name: jenkins
</span><span id="__span-182-6"><a id="__codelineno-182-6" name="__codelineno-182-6" href="#__codelineno-182-6"></a>    ports:
</span><span id="__span-182-7"><a id="__codelineno-182-7" name="__codelineno-182-7" href="#__codelineno-182-7"></a>      - 8080:8080
</span><span id="__span-182-8"><a id="__codelineno-182-8" name="__codelineno-182-8" href="#__codelineno-182-8"></a>      - 50000:50000
</span><span id="__span-182-9"><a id="__codelineno-182-9" name="__codelineno-182-9" href="#__codelineno-182-9"></a>    volumes:
</span><span id="__span-182-10"><a id="__codelineno-182-10" name="__codelineno-182-10" href="#__codelineno-182-10"></a>      - ./data/:/var/jenkins_home/
</span><span id="__span-182-11"><a id="__codelineno-182-11" name="__codelineno-182-11" href="#__codelineno-182-11"></a>      - /usr/bin/docker:/usr/bin/docker
</span><span id="__span-182-12"><a id="__codelineno-182-12" name="__codelineno-182-12" href="#__codelineno-182-12"></a>      - /var/run/docker.sock:/var/run/docker.sock
</span><span id="__span-182-13"><a id="__codelineno-182-13" name="__codelineno-182-13" href="#__codelineno-182-13"></a>      - /etc/docker/daemon.json:/etc/docker/daemon.json
</span></code></pre></div>
<h6 id="835"><a class="toclink" href="../../devops/#835">8.3.5 添加构建操作</a></h6>
<table>
<thead>
<tr>
<th style="text-align: center;">制作自定义镜像</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211229155834500" src="../../images/DevOps/image-20211229155834500.png" /></td>
</tr>
</tbody>
</table>
<h6 id="836"><a class="toclink" href="../../devops/#836">8.3.6 编写部署脚本</a></h6>
<p>部署项目需要通过Publish Over SSH插件，让目标服务器执行命令。为了方便一次性实现拉取镜像和启动的命令，推荐采用脚本文件的方式。</p>
<p>添加脚本文件到目标服务器，再通过Publish Over SSH插件让目标服务器执行脚本即可。</p>
<ul>
<li>编写脚本文件，添加到目标服务器</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-183-1"><a id="__codelineno-183-1" name="__codelineno-183-1" href="#__codelineno-183-1"></a><span class="nv">harbor_url</span><span class="o">=</span><span class="nv">$1</span>
</span><span id="__span-183-2"><a id="__codelineno-183-2" name="__codelineno-183-2" href="#__codelineno-183-2"></a><span class="nv">harbor_project_name</span><span class="o">=</span><span class="nv">$2</span>
</span><span id="__span-183-3"><a id="__codelineno-183-3" name="__codelineno-183-3" href="#__codelineno-183-3"></a><span class="nv">project_name</span><span class="o">=</span><span class="nv">$3</span>
</span><span id="__span-183-4"><a id="__codelineno-183-4" name="__codelineno-183-4" href="#__codelineno-183-4"></a><span class="nv">tag</span><span class="o">=</span><span class="nv">$4</span>
</span><span id="__span-183-5"><a id="__codelineno-183-5" name="__codelineno-183-5" href="#__codelineno-183-5"></a><span class="nv">port</span><span class="o">=</span><span class="nv">$5</span>
</span><span id="__span-183-6"><a id="__codelineno-183-6" name="__codelineno-183-6" href="#__codelineno-183-6"></a>
</span><span id="__span-183-7"><a id="__codelineno-183-7" name="__codelineno-183-7" href="#__codelineno-183-7"></a><span class="nv">imageName</span><span class="o">=</span><span class="nv">$harbor_url</span>/<span class="nv">$harbor_project_name</span>/<span class="nv">$project_name</span>:<span class="nv">$tag</span>
</span><span id="__span-183-8"><a id="__codelineno-183-8" name="__codelineno-183-8" href="#__codelineno-183-8"></a>
</span><span id="__span-183-9"><a id="__codelineno-183-9" name="__codelineno-183-9" href="#__codelineno-183-9"></a><span class="nv">containerId</span><span class="o">=</span><span class="sb">`</span>docker<span class="w"> </span>ps<span class="w"> </span>-a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="si">${</span><span class="nv">project_name</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</span><span id="__span-183-10"><a id="__codelineno-183-10" name="__codelineno-183-10" href="#__codelineno-183-10"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$containerId</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-183-11"><a id="__codelineno-183-11" name="__codelineno-183-11" href="#__codelineno-183-11"></a><span class="w">    </span>docker<span class="w"> </span>stop<span class="w"> </span><span class="nv">$containerId</span>
</span><span id="__span-183-12"><a id="__codelineno-183-12" name="__codelineno-183-12" href="#__codelineno-183-12"></a><span class="w">    </span>docker<span class="w"> </span>rm<span class="w"> </span><span class="nv">$containerId</span>
</span><span id="__span-183-13"><a id="__codelineno-183-13" name="__codelineno-183-13" href="#__codelineno-183-13"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Delete Container Success&quot;</span>
</span><span id="__span-183-14"><a id="__codelineno-183-14" name="__codelineno-183-14" href="#__codelineno-183-14"></a><span class="k">fi</span>
</span><span id="__span-183-15"><a id="__codelineno-183-15" name="__codelineno-183-15" href="#__codelineno-183-15"></a>
</span><span id="__span-183-16"><a id="__codelineno-183-16" name="__codelineno-183-16" href="#__codelineno-183-16"></a><span class="nv">imageId</span><span class="o">=</span><span class="sb">`</span>docker<span class="w"> </span>images<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="si">${</span><span class="nv">project_name</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $3}&#39;</span><span class="sb">`</span>
</span><span id="__span-183-17"><a id="__codelineno-183-17" name="__codelineno-183-17" href="#__codelineno-183-17"></a>
</span><span id="__span-183-18"><a id="__codelineno-183-18" name="__codelineno-183-18" href="#__codelineno-183-18"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$imageId</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-183-19"><a id="__codelineno-183-19" name="__codelineno-183-19" href="#__codelineno-183-19"></a><span class="w">    </span>docker<span class="w"> </span>rmi<span class="w"> </span>-f<span class="w"> </span><span class="nv">$imageId</span>
</span><span id="__span-183-20"><a id="__codelineno-183-20" name="__codelineno-183-20" href="#__codelineno-183-20"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Delete Image Success&quot;</span>
</span><span id="__span-183-21"><a id="__codelineno-183-21" name="__codelineno-183-21" href="#__codelineno-183-21"></a><span class="k">fi</span>
</span><span id="__span-183-22"><a id="__codelineno-183-22" name="__codelineno-183-22" href="#__codelineno-183-22"></a>
</span><span id="__span-183-23"><a id="__codelineno-183-23" name="__codelineno-183-23" href="#__codelineno-183-23"></a>docker<span class="w"> </span>login<span class="w"> </span>-u<span class="w"> </span>DevOps<span class="w"> </span>-p<span class="w"> </span>P@ssw0rd<span class="w"> </span><span class="nv">$harbor_url</span>
</span><span id="__span-183-24"><a id="__codelineno-183-24" name="__codelineno-183-24" href="#__codelineno-183-24"></a>
</span><span id="__span-183-25"><a id="__codelineno-183-25" name="__codelineno-183-25" href="#__codelineno-183-25"></a>docker<span class="w"> </span>pull<span class="w"> </span><span class="nv">$imageName</span>
</span><span id="__span-183-26"><a id="__codelineno-183-26" name="__codelineno-183-26" href="#__codelineno-183-26"></a>
</span><span id="__span-183-27"><a id="__codelineno-183-27" name="__codelineno-183-27" href="#__codelineno-183-27"></a>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="nv">$port</span>:<span class="nv">$port</span><span class="w"> </span>--name<span class="w"> </span><span class="nv">$project_name</span><span class="w"> </span><span class="nv">$imageName</span>
</span><span id="__span-183-28"><a id="__codelineno-183-28" name="__codelineno-183-28" href="#__codelineno-183-28"></a>
</span><span id="__span-183-29"><a id="__codelineno-183-29" name="__codelineno-183-29" href="#__codelineno-183-29"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Start Container Success&quot;</span>
</span><span id="__span-183-30"><a id="__codelineno-183-30" name="__codelineno-183-30" href="#__codelineno-183-30"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$project_name</span>
</span></code></pre></div>
<p>并设置权限为可执行</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-184-1"><a id="__codelineno-184-1" name="__codelineno-184-1" href="#__codelineno-184-1"></a>chmod a+x deploy.sh
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">如图</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211203192047357" src="../../images/DevOps/image-20211203192047357.png" /></td>
</tr>
</tbody>
</table>
<h6 id="837"><a class="toclink" href="../../devops/#837">8.3.7 配置构建后操作</a></h6>
<table>
<thead>
<tr>
<th style="text-align: center;">执行脚本文件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211229155949038" src="../../images/DevOps/image-20211229155949038.png" /></td>
</tr>
</tbody>
</table>
<h4 id="jenkins"><a class="toclink" href="../../devops/#jenkins">九、Jenkins流水线</a></h4>
<h5 id="91-jenkins"><a class="toclink" href="../../devops/#91-jenkins">9.1 Jenkins流水线任务介绍</a></h5>
<p>之前采用Jenkins的自由风格构建的项目，每个步骤流程都要通过不同的方式设置，并且构建过程中整体流程是不可见的，无法确认每个流程花费的时间，并且问题不方便定位问题。</p>
<p>Jenkins的Pipeline可以让项目的发布整体流程可视化，明确执行的阶段，可以快速的定位问题。并且整个项目的生命周期可以通过一个Jenkinsfile文件管理，而且Jenkinsfile文件是可以放在项目中维护。</p>
<p>所以Pipeline相对自由风格或者其他的项目风格更容易操作。</p>
<h5 id="92-jenkins"><a class="toclink" href="../../devops/#92-jenkins">9.2 Jenkins流水线任务</a></h5>
<h6 id="921-jenkins"><a class="toclink" href="../../devops/#921-jenkins">9.2.1 构建Jenkins流水线任务</a></h6>
<ul>
<li>构建任务</li>
</ul>
<table>
<thead>
<tr>
<th>构建Jenkins流水线任务</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="image-20211202144429302" src="../../images/DevOps/image-20211202144429302.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>生成Groovy脚本</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">Hello World脚本生成</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202144531749" src="../../images/DevOps/image-20211202144531749.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>构建后查看视图</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">构建后查看视图</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202144616117" src="../../images/DevOps/image-20211202144616117.png" /></td>
</tr>
</tbody>
</table>
<h6 id="922-groovy"><a class="toclink" href="../../devops/#922-groovy">9.2.2 Groovy脚本</a></h6>
<ul>
<li>Groovy脚本基础语法</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-185-1"><a id="__codelineno-185-1" name="__codelineno-185-1" href="#__codelineno-185-1"></a>//<span class="w"> </span>所有脚本命令包含在pipeline<span class="o">{}</span>中
</span><span id="__span-185-2"><a id="__codelineno-185-2" name="__codelineno-185-2" href="#__codelineno-185-2"></a>pipeline<span class="w"> </span><span class="o">{</span><span class="w">  </span>
</span><span id="__span-185-3"><a id="__codelineno-185-3" name="__codelineno-185-3" href="#__codelineno-185-3"></a><span class="w">  </span>//<span class="w"> </span>指定任务在哪个节点执行（Jenkins支持分布式）
</span><span id="__span-185-4"><a id="__codelineno-185-4" name="__codelineno-185-4" href="#__codelineno-185-4"></a><span class="w">    </span>agent<span class="w"> </span>any
</span><span id="__span-185-5"><a id="__codelineno-185-5" name="__codelineno-185-5" href="#__codelineno-185-5"></a>
</span><span id="__span-185-6"><a id="__codelineno-185-6" name="__codelineno-185-6" href="#__codelineno-185-6"></a><span class="w">    </span>//<span class="w"> </span>配置全局环境，指定变量名<span class="o">=</span>变量值信息
</span><span id="__span-185-7"><a id="__codelineno-185-7" name="__codelineno-185-7" href="#__codelineno-185-7"></a><span class="w">    </span>environment<span class="o">{</span>
</span><span id="__span-185-8"><a id="__codelineno-185-8" name="__codelineno-185-8" href="#__codelineno-185-8"></a><span class="w">      </span><span class="nv">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;192.168.11.11&#39;</span>
</span><span id="__span-185-9"><a id="__codelineno-185-9" name="__codelineno-185-9" href="#__codelineno-185-9"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-185-10"><a id="__codelineno-185-10" name="__codelineno-185-10" href="#__codelineno-185-10"></a>
</span><span id="__span-185-11"><a id="__codelineno-185-11" name="__codelineno-185-11" href="#__codelineno-185-11"></a><span class="w">    </span>//<span class="w"> </span>存放所有任务的合集
</span><span id="__span-185-12"><a id="__codelineno-185-12" name="__codelineno-185-12" href="#__codelineno-185-12"></a><span class="w">    </span>stages<span class="w"> </span><span class="o">{</span>
</span><span id="__span-185-13"><a id="__codelineno-185-13" name="__codelineno-185-13" href="#__codelineno-185-13"></a><span class="w">      </span>//<span class="w"> </span>单个任务
</span><span id="__span-185-14"><a id="__codelineno-185-14" name="__codelineno-185-14" href="#__codelineno-185-14"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;任务1&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-185-15"><a id="__codelineno-185-15" name="__codelineno-185-15" href="#__codelineno-185-15"></a><span class="w">          </span>//<span class="w"> </span>实现任务的具体流程
</span><span id="__span-185-16"><a id="__codelineno-185-16" name="__codelineno-185-16" href="#__codelineno-185-16"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-185-17"><a id="__codelineno-185-17" name="__codelineno-185-17" href="#__codelineno-185-17"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;do something&#39;</span>
</span><span id="__span-185-18"><a id="__codelineno-185-18" name="__codelineno-185-18" href="#__codelineno-185-18"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-185-19"><a id="__codelineno-185-19" name="__codelineno-185-19" href="#__codelineno-185-19"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-185-20"><a id="__codelineno-185-20" name="__codelineno-185-20" href="#__codelineno-185-20"></a><span class="w">      </span>//<span class="w"> </span>单个任务
</span><span id="__span-185-21"><a id="__codelineno-185-21" name="__codelineno-185-21" href="#__codelineno-185-21"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;任务2&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-185-22"><a id="__codelineno-185-22" name="__codelineno-185-22" href="#__codelineno-185-22"></a><span class="w">          </span>//<span class="w"> </span>实现任务的具体流程
</span><span id="__span-185-23"><a id="__codelineno-185-23" name="__codelineno-185-23" href="#__codelineno-185-23"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-185-24"><a id="__codelineno-185-24" name="__codelineno-185-24" href="#__codelineno-185-24"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;do something&#39;</span>
</span><span id="__span-185-25"><a id="__codelineno-185-25" name="__codelineno-185-25" href="#__codelineno-185-25"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-185-26"><a id="__codelineno-185-26" name="__codelineno-185-26" href="#__codelineno-185-26"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-185-27"><a id="__codelineno-185-27" name="__codelineno-185-27" href="#__codelineno-185-27"></a><span class="w">        </span>//<span class="w"> </span>……
</span><span id="__span-185-28"><a id="__codelineno-185-28" name="__codelineno-185-28" href="#__codelineno-185-28"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-185-29"><a id="__codelineno-185-29" name="__codelineno-185-29" href="#__codelineno-185-29"></a><span class="o">}</span>
</span></code></pre></div>
<ul>
<li>编写例子测试</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-186-1"><a id="__codelineno-186-1" name="__codelineno-186-1" href="#__codelineno-186-1"></a>pipeline<span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-2"><a id="__codelineno-186-2" name="__codelineno-186-2" href="#__codelineno-186-2"></a><span class="w">    </span>agent<span class="w"> </span>any
</span><span id="__span-186-3"><a id="__codelineno-186-3" name="__codelineno-186-3" href="#__codelineno-186-3"></a>
</span><span id="__span-186-4"><a id="__codelineno-186-4" name="__codelineno-186-4" href="#__codelineno-186-4"></a><span class="w">    </span>//<span class="w"> </span>存放所有任务的合集
</span><span id="__span-186-5"><a id="__codelineno-186-5" name="__codelineno-186-5" href="#__codelineno-186-5"></a><span class="w">    </span>stages<span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-6"><a id="__codelineno-186-6" name="__codelineno-186-6" href="#__codelineno-186-6"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;拉取Git代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-7"><a id="__codelineno-186-7" name="__codelineno-186-7" href="#__codelineno-186-7"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-8"><a id="__codelineno-186-8" name="__codelineno-186-8" href="#__codelineno-186-8"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;拉取Git代码&#39;</span>
</span><span id="__span-186-9"><a id="__codelineno-186-9" name="__codelineno-186-9" href="#__codelineno-186-9"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-186-10"><a id="__codelineno-186-10" name="__codelineno-186-10" href="#__codelineno-186-10"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-186-11"><a id="__codelineno-186-11" name="__codelineno-186-11" href="#__codelineno-186-11"></a>
</span><span id="__span-186-12"><a id="__codelineno-186-12" name="__codelineno-186-12" href="#__codelineno-186-12"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;检测代码质量&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-13"><a id="__codelineno-186-13" name="__codelineno-186-13" href="#__codelineno-186-13"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-14"><a id="__codelineno-186-14" name="__codelineno-186-14" href="#__codelineno-186-14"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;检测代码质量&#39;</span>
</span><span id="__span-186-15"><a id="__codelineno-186-15" name="__codelineno-186-15" href="#__codelineno-186-15"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-186-16"><a id="__codelineno-186-16" name="__codelineno-186-16" href="#__codelineno-186-16"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-186-17"><a id="__codelineno-186-17" name="__codelineno-186-17" href="#__codelineno-186-17"></a>
</span><span id="__span-186-18"><a id="__codelineno-186-18" name="__codelineno-186-18" href="#__codelineno-186-18"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;构建代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-19"><a id="__codelineno-186-19" name="__codelineno-186-19" href="#__codelineno-186-19"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-20"><a id="__codelineno-186-20" name="__codelineno-186-20" href="#__codelineno-186-20"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;构建代码&#39;</span>
</span><span id="__span-186-21"><a id="__codelineno-186-21" name="__codelineno-186-21" href="#__codelineno-186-21"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-186-22"><a id="__codelineno-186-22" name="__codelineno-186-22" href="#__codelineno-186-22"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-186-23"><a id="__codelineno-186-23" name="__codelineno-186-23" href="#__codelineno-186-23"></a>
</span><span id="__span-186-24"><a id="__codelineno-186-24" name="__codelineno-186-24" href="#__codelineno-186-24"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;制作自定义镜像并发布Harbor&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-25"><a id="__codelineno-186-25" name="__codelineno-186-25" href="#__codelineno-186-25"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-26"><a id="__codelineno-186-26" name="__codelineno-186-26" href="#__codelineno-186-26"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;制作自定义镜像并发布Harbor&#39;</span>
</span><span id="__span-186-27"><a id="__codelineno-186-27" name="__codelineno-186-27" href="#__codelineno-186-27"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-186-28"><a id="__codelineno-186-28" name="__codelineno-186-28" href="#__codelineno-186-28"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-186-29"><a id="__codelineno-186-29" name="__codelineno-186-29" href="#__codelineno-186-29"></a>
</span><span id="__span-186-30"><a id="__codelineno-186-30" name="__codelineno-186-30" href="#__codelineno-186-30"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;基于Harbor部署工程&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-31"><a id="__codelineno-186-31" name="__codelineno-186-31" href="#__codelineno-186-31"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-186-32"><a id="__codelineno-186-32" name="__codelineno-186-32" href="#__codelineno-186-32"></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;基于Harbor部署工程&#39;</span>
</span><span id="__span-186-33"><a id="__codelineno-186-33" name="__codelineno-186-33" href="#__codelineno-186-33"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-186-34"><a id="__codelineno-186-34" name="__codelineno-186-34" href="#__codelineno-186-34"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-186-35"><a id="__codelineno-186-35" name="__codelineno-186-35" href="#__codelineno-186-35"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-186-36"><a id="__codelineno-186-36" name="__codelineno-186-36" href="#__codelineno-186-36"></a><span class="o">}</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">配置Grovvy脚本</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202145155428" src="../../images/DevOps/image-20211202145155428.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>查看效果</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">查看效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202145240166" src="../../images/DevOps/image-20211202145240166.png" /></td>
</tr>
</tbody>
</table>
<p><a href="">Ps：涉及到特定脚本，Jenkins给予了充足的提示，可以自动生成命令</a></p>
<table>
<thead>
<tr>
<th style="text-align: center;">生成命令位置</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202145349043" src="../../images/DevOps/image-20211202145349043.png" /></td>
</tr>
</tbody>
</table>
<h6 id="923-jenkinsfile"><a class="toclink" href="../../devops/#923-jenkinsfile">9.2.3 Jenkinsfile实现</a></h6>
<p>Jenkinsfile方式需要将脚本内容编写到项目中的Jenkinsfile文件中，每次构建会自动拉取项目并且获取项目中Jenkinsfile文件对项目进行构建</p>
<ul>
<li>配置pipeline</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">配置pipeline</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202151127254" src="../../images/DevOps/image-20211202151127254.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>准备Jenkinsfile</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">准备Jenkinsfile文件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202151155145" src="../../images/DevOps/image-20211202151155145.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>测试效果</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">测试效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202151225161" src="../../images/DevOps/image-20211202151225161.png" /></td>
</tr>
</tbody>
</table>
<h5 id="93-jenkins"><a class="toclink" href="../../devops/#93-jenkins">9.3 Jenkins流水线任务实现</a></h5>
<h6 id="931"><a class="toclink" href="../../devops/#931">9.3.1 参数化构建</a></h6>
<p>添加参数化构建，方便选择不的项目版本</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Git参数化构建</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202191944277" src="../../images/DevOps/image-20211202191944277.png" /></td>
</tr>
</tbody>
</table>
<h6 id="932-git"><a class="toclink" href="../../devops/#932-git">9.3.2 拉取Git代码</a></h6>
<p>通过流水线语法生成Checkout代码的脚本</p>
<table>
<thead>
<tr>
<th style="text-align: center;">语法生成</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211202192047619" src="../../images/DevOps/image-20211202192047619.png" /></td>
</tr>
</tbody>
</table>
<p><img alt="image-20211202192129895" src="../../images/DevOps/image-20211202192129895.png" />将*/master更改为标签<a href="">${tag}</a></p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-187-1"><a id="__codelineno-187-1" name="__codelineno-187-1" href="#__codelineno-187-1"></a>pipeline<span class="w"> </span><span class="o">{</span>
</span><span id="__span-187-2"><a id="__codelineno-187-2" name="__codelineno-187-2" href="#__codelineno-187-2"></a><span class="w">    </span>agent<span class="w"> </span>any
</span><span id="__span-187-3"><a id="__codelineno-187-3" name="__codelineno-187-3" href="#__codelineno-187-3"></a><span class="w">    </span>stages<span class="w"> </span><span class="o">{</span>
</span><span id="__span-187-4"><a id="__codelineno-187-4" name="__codelineno-187-4" href="#__codelineno-187-4"></a>
</span><span id="__span-187-5"><a id="__codelineno-187-5" name="__codelineno-187-5" href="#__codelineno-187-5"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;拉取Git代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-187-6"><a id="__codelineno-187-6" name="__codelineno-187-6" href="#__codelineno-187-6"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-187-7"><a id="__codelineno-187-7" name="__codelineno-187-7" href="#__codelineno-187-7"></a><span class="w">                </span>checkout<span class="o">([</span><span class="nv">$class</span>:<span class="w"> </span><span class="s1">&#39;GitSCM&#39;</span>,<span class="w"> </span>branches:<span class="w"> </span><span class="o">[[</span>name:<span class="w"> </span><span class="s1">&#39;${tag}&#39;</span><span class="o">]]</span>,<span class="w"> </span>extensions:<span class="w"> </span><span class="o">[]</span>,<span class="w"> </span>userRemoteConfigs:<span class="w"> </span><span class="o">[[</span>url:<span class="w"> </span><span class="s1">&#39;http://49.233.115.171:8929/root/test.git&#39;</span><span class="o">]]])</span>
</span><span id="__span-187-8"><a id="__codelineno-187-8" name="__codelineno-187-8" href="#__codelineno-187-8"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-187-9"><a id="__codelineno-187-9" name="__codelineno-187-9" href="#__codelineno-187-9"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-187-10"><a id="__codelineno-187-10" name="__codelineno-187-10" href="#__codelineno-187-10"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-187-11"><a id="__codelineno-187-11" name="__codelineno-187-11" href="#__codelineno-187-11"></a><span class="o">}</span>
</span></code></pre></div>
<h6 id="933"><a class="toclink" href="../../devops/#933">9.3.3 构建代码</a></h6>
<p>通过脚本执行mvn的构建命令</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-188-1"><a id="__codelineno-188-1" name="__codelineno-188-1" href="#__codelineno-188-1"></a>pipeline<span class="w"> </span><span class="o">{</span>
</span><span id="__span-188-2"><a id="__codelineno-188-2" name="__codelineno-188-2" href="#__codelineno-188-2"></a><span class="w">    </span>agent<span class="w"> </span>any
</span><span id="__span-188-3"><a id="__codelineno-188-3" name="__codelineno-188-3" href="#__codelineno-188-3"></a>
</span><span id="__span-188-4"><a id="__codelineno-188-4" name="__codelineno-188-4" href="#__codelineno-188-4"></a><span class="w">    </span>stages<span class="w"> </span><span class="o">{</span>
</span><span id="__span-188-5"><a id="__codelineno-188-5" name="__codelineno-188-5" href="#__codelineno-188-5"></a>
</span><span id="__span-188-6"><a id="__codelineno-188-6" name="__codelineno-188-6" href="#__codelineno-188-6"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;拉取Git代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-188-7"><a id="__codelineno-188-7" name="__codelineno-188-7" href="#__codelineno-188-7"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-188-8"><a id="__codelineno-188-8" name="__codelineno-188-8" href="#__codelineno-188-8"></a><span class="w">                </span>checkout<span class="o">([</span><span class="nv">$class</span>:<span class="w"> </span><span class="s1">&#39;GitSCM&#39;</span>,<span class="w"> </span>branches:<span class="w"> </span><span class="o">[[</span>name:<span class="w"> </span><span class="s1">&#39;${tag}&#39;</span><span class="o">]]</span>,<span class="w"> </span>extensions:<span class="w"> </span><span class="o">[]</span>,<span class="w"> </span>userRemoteConfigs:<span class="w"> </span><span class="o">[[</span>url:<span class="w"> </span><span class="s1">&#39;http://49.233.115.171:8929/root/test.git&#39;</span><span class="o">]]])</span>
</span><span id="__span-188-9"><a id="__codelineno-188-9" name="__codelineno-188-9" href="#__codelineno-188-9"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-188-10"><a id="__codelineno-188-10" name="__codelineno-188-10" href="#__codelineno-188-10"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-188-11"><a id="__codelineno-188-11" name="__codelineno-188-11" href="#__codelineno-188-11"></a>
</span><span id="__span-188-12"><a id="__codelineno-188-12" name="__codelineno-188-12" href="#__codelineno-188-12"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;构建代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-188-13"><a id="__codelineno-188-13" name="__codelineno-188-13" href="#__codelineno-188-13"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-188-14"><a id="__codelineno-188-14" name="__codelineno-188-14" href="#__codelineno-188-14"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#39;</span>
</span><span id="__span-188-15"><a id="__codelineno-188-15" name="__codelineno-188-15" href="#__codelineno-188-15"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-188-16"><a id="__codelineno-188-16" name="__codelineno-188-16" href="#__codelineno-188-16"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-188-17"><a id="__codelineno-188-17" name="__codelineno-188-17" href="#__codelineno-188-17"></a><span class="o">}</span>
</span></code></pre></div>
<h6 id="934"><a class="toclink" href="../../devops/#934">9.3.4 代码质量检测</a></h6>
<p>通过脚本执行sonar-scanner命令即可</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-189-1"><a id="__codelineno-189-1" name="__codelineno-189-1" href="#__codelineno-189-1"></a>pipeline<span class="w"> </span><span class="o">{</span>
</span><span id="__span-189-2"><a id="__codelineno-189-2" name="__codelineno-189-2" href="#__codelineno-189-2"></a><span class="w">    </span>agent<span class="w"> </span>any
</span><span id="__span-189-3"><a id="__codelineno-189-3" name="__codelineno-189-3" href="#__codelineno-189-3"></a>
</span><span id="__span-189-4"><a id="__codelineno-189-4" name="__codelineno-189-4" href="#__codelineno-189-4"></a><span class="w">    </span>stages<span class="w"> </span><span class="o">{</span>
</span><span id="__span-189-5"><a id="__codelineno-189-5" name="__codelineno-189-5" href="#__codelineno-189-5"></a>
</span><span id="__span-189-6"><a id="__codelineno-189-6" name="__codelineno-189-6" href="#__codelineno-189-6"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;拉取Git代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-189-7"><a id="__codelineno-189-7" name="__codelineno-189-7" href="#__codelineno-189-7"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-189-8"><a id="__codelineno-189-8" name="__codelineno-189-8" href="#__codelineno-189-8"></a><span class="w">                </span>checkout<span class="o">([</span><span class="nv">$class</span>:<span class="w"> </span><span class="s1">&#39;GitSCM&#39;</span>,<span class="w"> </span>branches:<span class="w"> </span><span class="o">[[</span>name:<span class="w"> </span><span class="s1">&#39;${tag}&#39;</span><span class="o">]]</span>,<span class="w"> </span>extensions:<span class="w"> </span><span class="o">[]</span>,<span class="w"> </span>userRemoteConfigs:<span class="w"> </span><span class="o">[[</span>url:<span class="w"> </span><span class="s1">&#39;http://49.233.115.171:8929/root/test.git&#39;</span><span class="o">]]])</span>
</span><span id="__span-189-9"><a id="__codelineno-189-9" name="__codelineno-189-9" href="#__codelineno-189-9"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-189-10"><a id="__codelineno-189-10" name="__codelineno-189-10" href="#__codelineno-189-10"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-189-11"><a id="__codelineno-189-11" name="__codelineno-189-11" href="#__codelineno-189-11"></a>
</span><span id="__span-189-12"><a id="__codelineno-189-12" name="__codelineno-189-12" href="#__codelineno-189-12"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;构建代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-189-13"><a id="__codelineno-189-13" name="__codelineno-189-13" href="#__codelineno-189-13"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-189-14"><a id="__codelineno-189-14" name="__codelineno-189-14" href="#__codelineno-189-14"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#39;</span>
</span><span id="__span-189-15"><a id="__codelineno-189-15" name="__codelineno-189-15" href="#__codelineno-189-15"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-189-16"><a id="__codelineno-189-16" name="__codelineno-189-16" href="#__codelineno-189-16"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-189-17"><a id="__codelineno-189-17" name="__codelineno-189-17" href="#__codelineno-189-17"></a>
</span><span id="__span-189-18"><a id="__codelineno-189-18" name="__codelineno-189-18" href="#__codelineno-189-18"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;检测代码质量&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-189-19"><a id="__codelineno-189-19" name="__codelineno-189-19" href="#__codelineno-189-19"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-189-20"><a id="__codelineno-189-20" name="__codelineno-189-20" href="#__codelineno-189-20"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=${JOB_NAME} -Dsonar.projectKey=${JOB_NAME} -Dsonar.java.binaries=target/ -Dsonar.login=31388be45653876c1f51ec02f0d478e2d9d0e1fa&#39;</span><span class="w"> </span>
</span><span id="__span-189-21"><a id="__codelineno-189-21" name="__codelineno-189-21" href="#__codelineno-189-21"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-189-22"><a id="__codelineno-189-22" name="__codelineno-189-22" href="#__codelineno-189-22"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-189-23"><a id="__codelineno-189-23" name="__codelineno-189-23" href="#__codelineno-189-23"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-189-24"><a id="__codelineno-189-24" name="__codelineno-189-24" href="#__codelineno-189-24"></a><span class="o">}</span>
</span></code></pre></div>
<h6 id="935"><a class="toclink" href="../../devops/#935">9.3.5 制作自定义镜像并发布</a></h6>
<ul>
<li>生成自定义镜像脚本</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-190-1"><a id="__codelineno-190-1" name="__codelineno-190-1" href="#__codelineno-190-1"></a>pipeline<span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-2"><a id="__codelineno-190-2" name="__codelineno-190-2" href="#__codelineno-190-2"></a><span class="w">    </span>agent<span class="w"> </span>any
</span><span id="__span-190-3"><a id="__codelineno-190-3" name="__codelineno-190-3" href="#__codelineno-190-3"></a><span class="w">    </span>environment<span class="o">{</span>
</span><span id="__span-190-4"><a id="__codelineno-190-4" name="__codelineno-190-4" href="#__codelineno-190-4"></a><span class="w">        </span><span class="nv">harborHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;192.168.11.11:80&#39;</span>
</span><span id="__span-190-5"><a id="__codelineno-190-5" name="__codelineno-190-5" href="#__codelineno-190-5"></a><span class="w">        </span><span class="nv">harborRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;repository&#39;</span>
</span><span id="__span-190-6"><a id="__codelineno-190-6" name="__codelineno-190-6" href="#__codelineno-190-6"></a><span class="w">        </span><span class="nv">harborUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DevOps&#39;</span>
</span><span id="__span-190-7"><a id="__codelineno-190-7" name="__codelineno-190-7" href="#__codelineno-190-7"></a><span class="w">        </span><span class="nv">harborPasswd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;P@ssw0rd&#39;</span>
</span><span id="__span-190-8"><a id="__codelineno-190-8" name="__codelineno-190-8" href="#__codelineno-190-8"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-190-9"><a id="__codelineno-190-9" name="__codelineno-190-9" href="#__codelineno-190-9"></a>
</span><span id="__span-190-10"><a id="__codelineno-190-10" name="__codelineno-190-10" href="#__codelineno-190-10"></a><span class="w">    </span>//<span class="w"> </span>存放所有任务的合集
</span><span id="__span-190-11"><a id="__codelineno-190-11" name="__codelineno-190-11" href="#__codelineno-190-11"></a><span class="w">    </span>stages<span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-12"><a id="__codelineno-190-12" name="__codelineno-190-12" href="#__codelineno-190-12"></a>
</span><span id="__span-190-13"><a id="__codelineno-190-13" name="__codelineno-190-13" href="#__codelineno-190-13"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;拉取Git代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-14"><a id="__codelineno-190-14" name="__codelineno-190-14" href="#__codelineno-190-14"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-15"><a id="__codelineno-190-15" name="__codelineno-190-15" href="#__codelineno-190-15"></a><span class="w">                </span>checkout<span class="o">([</span><span class="nv">$class</span>:<span class="w"> </span><span class="s1">&#39;GitSCM&#39;</span>,<span class="w"> </span>branches:<span class="w"> </span><span class="o">[[</span>name:<span class="w"> </span><span class="s1">&#39;${tag}&#39;</span><span class="o">]]</span>,<span class="w"> </span>extensions:<span class="w"> </span><span class="o">[]</span>,<span class="w"> </span>userRemoteConfigs:<span class="w"> </span><span class="o">[[</span>url:<span class="w"> </span><span class="s1">&#39;http://49.233.115.171:8929/root/test.git&#39;</span><span class="o">]]])</span>
</span><span id="__span-190-16"><a id="__codelineno-190-16" name="__codelineno-190-16" href="#__codelineno-190-16"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-190-17"><a id="__codelineno-190-17" name="__codelineno-190-17" href="#__codelineno-190-17"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-190-18"><a id="__codelineno-190-18" name="__codelineno-190-18" href="#__codelineno-190-18"></a>
</span><span id="__span-190-19"><a id="__codelineno-190-19" name="__codelineno-190-19" href="#__codelineno-190-19"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;构建代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-20"><a id="__codelineno-190-20" name="__codelineno-190-20" href="#__codelineno-190-20"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-21"><a id="__codelineno-190-21" name="__codelineno-190-21" href="#__codelineno-190-21"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#39;</span>
</span><span id="__span-190-22"><a id="__codelineno-190-22" name="__codelineno-190-22" href="#__codelineno-190-22"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-190-23"><a id="__codelineno-190-23" name="__codelineno-190-23" href="#__codelineno-190-23"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-190-24"><a id="__codelineno-190-24" name="__codelineno-190-24" href="#__codelineno-190-24"></a>
</span><span id="__span-190-25"><a id="__codelineno-190-25" name="__codelineno-190-25" href="#__codelineno-190-25"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;检测代码质量&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-26"><a id="__codelineno-190-26" name="__codelineno-190-26" href="#__codelineno-190-26"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-27"><a id="__codelineno-190-27" name="__codelineno-190-27" href="#__codelineno-190-27"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=${JOB_NAME} -Dsonar.projectKey=${JOB_NAME} -Dsonar.java.binaries=target/ -Dsonar.login=31388be45653876c1f51ec02f0d478e2d9d0e1fa&#39;</span><span class="w"> </span>
</span><span id="__span-190-28"><a id="__codelineno-190-28" name="__codelineno-190-28" href="#__codelineno-190-28"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-190-29"><a id="__codelineno-190-29" name="__codelineno-190-29" href="#__codelineno-190-29"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-190-30"><a id="__codelineno-190-30" name="__codelineno-190-30" href="#__codelineno-190-30"></a>
</span><span id="__span-190-31"><a id="__codelineno-190-31" name="__codelineno-190-31" href="#__codelineno-190-31"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;制作自定义镜像并发布Harbor&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-32"><a id="__codelineno-190-32" name="__codelineno-190-32" href="#__codelineno-190-32"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-190-33"><a id="__codelineno-190-33" name="__codelineno-190-33" href="#__codelineno-190-33"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;&#39;&#39;cp ./target/*.jar ./docker/</span>
</span><span id="__span-190-34"><a id="__codelineno-190-34" name="__codelineno-190-34" href="#__codelineno-190-34"></a><span class="s1">                cd ./docker</span>
</span><span id="__span-190-35"><a id="__codelineno-190-35" name="__codelineno-190-35" href="#__codelineno-190-35"></a><span class="s1">                docker build -t ${JOB_NAME}:${tag} ./&#39;&#39;&#39;</span>
</span><span id="__span-190-36"><a id="__codelineno-190-36" name="__codelineno-190-36" href="#__codelineno-190-36"></a>
</span><span id="__span-190-37"><a id="__codelineno-190-37" name="__codelineno-190-37" href="#__codelineno-190-37"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;&#39;&#39;docker login -u ${harborUser} -p ${harborPasswd} ${harborHost}</span>
</span><span id="__span-190-38"><a id="__codelineno-190-38" name="__codelineno-190-38" href="#__codelineno-190-38"></a><span class="s1">                docker tag ${JOB_NAME}:${tag} ${harborHost}/${harborRepo}/${JOB_NAME}:${tag}</span>
</span><span id="__span-190-39"><a id="__codelineno-190-39" name="__codelineno-190-39" href="#__codelineno-190-39"></a><span class="s1">                docker push ${harborHost}/${harborRepo}/${JOB_NAME}:${tag}&#39;&#39;&#39;</span>
</span><span id="__span-190-40"><a id="__codelineno-190-40" name="__codelineno-190-40" href="#__codelineno-190-40"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-190-41"><a id="__codelineno-190-41" name="__codelineno-190-41" href="#__codelineno-190-41"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-190-42"><a id="__codelineno-190-42" name="__codelineno-190-42" href="#__codelineno-190-42"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-190-43"><a id="__codelineno-190-43" name="__codelineno-190-43" href="#__codelineno-190-43"></a><span class="o">}</span>
</span></code></pre></div>
<ul>
<li>生成Publish Over SSH脚本</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-191-1"><a id="__codelineno-191-1" name="__codelineno-191-1" href="#__codelineno-191-1"></a>pipeline<span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-2"><a id="__codelineno-191-2" name="__codelineno-191-2" href="#__codelineno-191-2"></a><span class="w">    </span>agent<span class="w"> </span>any
</span><span id="__span-191-3"><a id="__codelineno-191-3" name="__codelineno-191-3" href="#__codelineno-191-3"></a><span class="w">    </span>environment<span class="o">{</span>
</span><span id="__span-191-4"><a id="__codelineno-191-4" name="__codelineno-191-4" href="#__codelineno-191-4"></a><span class="w">        </span><span class="nv">harborHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;192.168.11.11:80&#39;</span>
</span><span id="__span-191-5"><a id="__codelineno-191-5" name="__codelineno-191-5" href="#__codelineno-191-5"></a><span class="w">        </span><span class="nv">harborRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;repository&#39;</span>
</span><span id="__span-191-6"><a id="__codelineno-191-6" name="__codelineno-191-6" href="#__codelineno-191-6"></a><span class="w">        </span><span class="nv">harborUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DevOps&#39;</span>
</span><span id="__span-191-7"><a id="__codelineno-191-7" name="__codelineno-191-7" href="#__codelineno-191-7"></a><span class="w">        </span><span class="nv">harborPasswd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;P@ssw0rd&#39;</span>
</span><span id="__span-191-8"><a id="__codelineno-191-8" name="__codelineno-191-8" href="#__codelineno-191-8"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-191-9"><a id="__codelineno-191-9" name="__codelineno-191-9" href="#__codelineno-191-9"></a>
</span><span id="__span-191-10"><a id="__codelineno-191-10" name="__codelineno-191-10" href="#__codelineno-191-10"></a><span class="w">    </span>//<span class="w"> </span>存放所有任务的合集
</span><span id="__span-191-11"><a id="__codelineno-191-11" name="__codelineno-191-11" href="#__codelineno-191-11"></a><span class="w">    </span>stages<span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-12"><a id="__codelineno-191-12" name="__codelineno-191-12" href="#__codelineno-191-12"></a>
</span><span id="__span-191-13"><a id="__codelineno-191-13" name="__codelineno-191-13" href="#__codelineno-191-13"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;拉取Git代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-14"><a id="__codelineno-191-14" name="__codelineno-191-14" href="#__codelineno-191-14"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-15"><a id="__codelineno-191-15" name="__codelineno-191-15" href="#__codelineno-191-15"></a><span class="w">                </span>checkout<span class="o">([</span><span class="nv">$class</span>:<span class="w"> </span><span class="s1">&#39;GitSCM&#39;</span>,<span class="w"> </span>branches:<span class="w"> </span><span class="o">[[</span>name:<span class="w"> </span><span class="s1">&#39;${tag}&#39;</span><span class="o">]]</span>,<span class="w"> </span>extensions:<span class="w"> </span><span class="o">[]</span>,<span class="w"> </span>userRemoteConfigs:<span class="w"> </span><span class="o">[[</span>url:<span class="w"> </span><span class="s1">&#39;http://49.233.115.171:8929/root/test.git&#39;</span><span class="o">]]])</span>
</span><span id="__span-191-16"><a id="__codelineno-191-16" name="__codelineno-191-16" href="#__codelineno-191-16"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-191-17"><a id="__codelineno-191-17" name="__codelineno-191-17" href="#__codelineno-191-17"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-191-18"><a id="__codelineno-191-18" name="__codelineno-191-18" href="#__codelineno-191-18"></a>
</span><span id="__span-191-19"><a id="__codelineno-191-19" name="__codelineno-191-19" href="#__codelineno-191-19"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;构建代码&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-20"><a id="__codelineno-191-20" name="__codelineno-191-20" href="#__codelineno-191-20"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-21"><a id="__codelineno-191-21" name="__codelineno-191-21" href="#__codelineno-191-21"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#39;</span>
</span><span id="__span-191-22"><a id="__codelineno-191-22" name="__codelineno-191-22" href="#__codelineno-191-22"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-191-23"><a id="__codelineno-191-23" name="__codelineno-191-23" href="#__codelineno-191-23"></a><span class="w">        </span><span class="o">}</span>docker
</span><span id="__span-191-24"><a id="__codelineno-191-24" name="__codelineno-191-24" href="#__codelineno-191-24"></a>
</span><span id="__span-191-25"><a id="__codelineno-191-25" name="__codelineno-191-25" href="#__codelineno-191-25"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;检测代码质量&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-26"><a id="__codelineno-191-26" name="__codelineno-191-26" href="#__codelineno-191-26"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-27"><a id="__codelineno-191-27" name="__codelineno-191-27" href="#__codelineno-191-27"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=${JOB_NAME} -Dsonar.projectKey=${JOB_NAME} -Dsonar.java.binaries=target/ -Dsonar.login=7d66af4b39cfe4f52ac0a915d4c9d5c513207098&#39;</span><span class="w"> </span>
</span><span id="__span-191-28"><a id="__codelineno-191-28" name="__codelineno-191-28" href="#__codelineno-191-28"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-191-29"><a id="__codelineno-191-29" name="__codelineno-191-29" href="#__codelineno-191-29"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-191-30"><a id="__codelineno-191-30" name="__codelineno-191-30" href="#__codelineno-191-30"></a>
</span><span id="__span-191-31"><a id="__codelineno-191-31" name="__codelineno-191-31" href="#__codelineno-191-31"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;制作自定义镜像并发布Harbor&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-32"><a id="__codelineno-191-32" name="__codelineno-191-32" href="#__codelineno-191-32"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-33"><a id="__codelineno-191-33" name="__codelineno-191-33" href="#__codelineno-191-33"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;&#39;&#39;cp ./target/*.jar ./docker/</span>
</span><span id="__span-191-34"><a id="__codelineno-191-34" name="__codelineno-191-34" href="#__codelineno-191-34"></a><span class="s1">                cd ./docker</span>
</span><span id="__span-191-35"><a id="__codelineno-191-35" name="__codelineno-191-35" href="#__codelineno-191-35"></a><span class="s1">                docker build -t ${JOB_NAME}:${tag} ./&#39;&#39;&#39;</span>
</span><span id="__span-191-36"><a id="__codelineno-191-36" name="__codelineno-191-36" href="#__codelineno-191-36"></a>
</span><span id="__span-191-37"><a id="__codelineno-191-37" name="__codelineno-191-37" href="#__codelineno-191-37"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;&#39;&#39;docker login -u ${harborUser} -p ${harborPasswd} ${harborHost}</span>
</span><span id="__span-191-38"><a id="__codelineno-191-38" name="__codelineno-191-38" href="#__codelineno-191-38"></a><span class="s1">                docker tag ${JOB_NAME}:${tag} ${harborHost}/${harborRepo}/${JOB_NAME}:${tag}</span>
</span><span id="__span-191-39"><a id="__codelineno-191-39" name="__codelineno-191-39" href="#__codelineno-191-39"></a><span class="s1">                docker push ${harborHost}/${harborRepo}/${JOB_NAME}:${tag}&#39;&#39;&#39;</span>
</span><span id="__span-191-40"><a id="__codelineno-191-40" name="__codelineno-191-40" href="#__codelineno-191-40"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-191-41"><a id="__codelineno-191-41" name="__codelineno-191-41" href="#__codelineno-191-41"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-191-42"><a id="__codelineno-191-42" name="__codelineno-191-42" href="#__codelineno-191-42"></a>
</span><span id="__span-191-43"><a id="__codelineno-191-43" name="__codelineno-191-43" href="#__codelineno-191-43"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;目标服务器拉取镜像并运行&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-44"><a id="__codelineno-191-44" name="__codelineno-191-44" href="#__codelineno-191-44"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-191-45"><a id="__codelineno-191-45" name="__codelineno-191-45" href="#__codelineno-191-45"></a><span class="w">                </span>sshPublisher<span class="o">(</span>publishers:<span class="w"> </span><span class="o">[</span>sshPublisherDesc<span class="o">(</span>configName:<span class="w"> </span><span class="s1">&#39;testEnvironment&#39;</span>,<span class="w"> </span>transfers:<span class="w"> </span><span class="o">[</span>sshTransfer<span class="o">(</span>cleanRemote:<span class="w"> </span>false,<span class="w"> </span>excludes:<span class="w"> </span><span class="s1">&#39;&#39;</span>,<span class="w"> </span>execCommand:<span class="w"> </span><span class="s2">&quot;/usr/bin/deploy.sh </span><span class="nv">$harborHost</span><span class="s2"> </span><span class="nv">$harborRepo</span><span class="s2"> </span><span class="nv">$JOB_NAME</span><span class="s2"> </span><span class="nv">$tag</span><span class="s2"> </span><span class="nv">$port</span><span class="s2"> &quot;</span>,<span class="w"> </span>execTimeout:<span class="w"> </span><span class="m">120000</span>,<span class="w"> </span>flatten:<span class="w"> </span>false,<span class="w"> </span>makeEmptyDirs:<span class="w"> </span>false,<span class="w"> </span>noDefaultExcludes:<span class="w"> </span>false,<span class="w"> </span>patternSeparator:<span class="w"> </span><span class="s1">&#39;[, ]+&#39;</span>,<span class="w"> </span>remoteDirectory:<span class="w"> </span><span class="s1">&#39;&#39;</span>,<span class="w"> </span>remoteDirectorySDF:<span class="w"> </span>false,<span class="w"> </span>removePrefix:<span class="w"> </span><span class="s1">&#39;&#39;</span>,<span class="w"> </span>sourceFiles:<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">)]</span>,<span class="w"> </span>usePromotionTimestamp:<span class="w"> </span>false,<span class="w"> </span>useWorkspaceInPromotion:<span class="w"> </span>false,<span class="w"> </span>verbose:<span class="w"> </span><span class="nb">false</span><span class="o">)])</span>
</span><span id="__span-191-46"><a id="__codelineno-191-46" name="__codelineno-191-46" href="#__codelineno-191-46"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-191-47"><a id="__codelineno-191-47" name="__codelineno-191-47" href="#__codelineno-191-47"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-191-48"><a id="__codelineno-191-48" name="__codelineno-191-48" href="#__codelineno-191-48"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-191-49"><a id="__codelineno-191-49" name="__codelineno-191-49" href="#__codelineno-191-49"></a><span class="o">}</span>
</span></code></pre></div>
<p><a href="">Ps：由于采用变量，记得使用双引号</a></p>
<h5 id="94-jenkins"><a class="toclink" href="../../devops/#94-jenkins">9.4 Jenkins流水线整合钉钉</a></h5>
<p>在程序部署成功后，可以通过钉钉的机器人及时向群众发送部署的最终结果通知</p>
<ul>
<li>安装插件</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">安装插件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211209151549412" src="../../images/DevOps/image-20211209151549412.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>钉钉内部创建群组并构建机器人</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">钉钉内部创建群组并构建机器人</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211209152217433" src="../../images/DevOps/image-20211209152217433.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211209152252050" src="../../images/DevOps/image-20211209152252050.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20211209152403312" src="../../images/DevOps/image-20211209152403312.png" /></td>
</tr>
</tbody>
</table>
<p>最终或获取到Webhook信息</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-192-1"><a id="__codelineno-192-1" name="__codelineno-192-1" href="#__codelineno-192-1"></a>https://oapi.dingtalk.com/robot/send?access_token=kej4ehkj34gjhg34jh5bh5jb34hj53b4
</span></code></pre></div>
<ul>
<li>系统配置添加钉钉通知</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">配置钉钉通知</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211209162923440" src="../../images/DevOps/image-20211209162923440.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>任务中追加流水线配置</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-193-1"><a id="__codelineno-193-1" name="__codelineno-193-1" href="#__codelineno-193-1"></a>pipeline<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-2"><a id="__codelineno-193-2" name="__codelineno-193-2" href="#__codelineno-193-2"></a><span class="w">    </span>agent<span class="w"> </span>any
</span><span id="__span-193-3"><a id="__codelineno-193-3" name="__codelineno-193-3" href="#__codelineno-193-3"></a>
</span><span id="__span-193-4"><a id="__codelineno-193-4" name="__codelineno-193-4" href="#__codelineno-193-4"></a><span class="w">    </span>environment<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-5"><a id="__codelineno-193-5" name="__codelineno-193-5" href="#__codelineno-193-5"></a><span class="w">        </span><span class="nv">sonarLogin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2bab7bf7d5af25e2c2ca2f178af2c3c55c64d5d8&#39;</span>
</span><span id="__span-193-6"><a id="__codelineno-193-6" name="__codelineno-193-6" href="#__codelineno-193-6"></a><span class="w">        </span><span class="nv">harborUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span>
</span><span id="__span-193-7"><a id="__codelineno-193-7" name="__codelineno-193-7" href="#__codelineno-193-7"></a><span class="w">        </span><span class="nv">harborPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Harbor12345&#39;</span>
</span><span id="__span-193-8"><a id="__codelineno-193-8" name="__codelineno-193-8" href="#__codelineno-193-8"></a><span class="w">        </span><span class="nv">harborHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;192.168.11.12:8888&#39;</span>
</span><span id="__span-193-9"><a id="__codelineno-193-9" name="__codelineno-193-9" href="#__codelineno-193-9"></a><span class="w">        </span><span class="nv">harborRepo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;repository&#39;</span>
</span><span id="__span-193-10"><a id="__codelineno-193-10" name="__codelineno-193-10" href="#__codelineno-193-10"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-193-11"><a id="__codelineno-193-11" name="__codelineno-193-11" href="#__codelineno-193-11"></a>
</span><span id="__span-193-12"><a id="__codelineno-193-12" name="__codelineno-193-12" href="#__codelineno-193-12"></a><span class="w">    </span>stages<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-13"><a id="__codelineno-193-13" name="__codelineno-193-13" href="#__codelineno-193-13"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;拉取Git代码&#39;</span><span class="o">){</span>
</span><span id="__span-193-14"><a id="__codelineno-193-14" name="__codelineno-193-14" href="#__codelineno-193-14"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-15"><a id="__codelineno-193-15" name="__codelineno-193-15" href="#__codelineno-193-15"></a><span class="w">                </span>checkout<span class="o">([</span><span class="nv">$class</span>:<span class="w"> </span><span class="s1">&#39;GitSCM&#39;</span>,<span class="w"> </span>branches:<span class="w"> </span><span class="o">[[</span>name:<span class="w"> </span><span class="s1">&#39;$tag&#39;</span><span class="o">]]</span>,<span class="w"> </span>extensions:<span class="w"> </span><span class="o">[]</span>,<span class="w"> </span>userRemoteConfigs:<span class="w"> </span><span class="o">[[</span>url:<span class="w"> </span><span class="s1">&#39;http://49.233.115.171:8929/root/lsx.git&#39;</span><span class="o">]]])</span>
</span><span id="__span-193-16"><a id="__codelineno-193-16" name="__codelineno-193-16" href="#__codelineno-193-16"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-193-17"><a id="__codelineno-193-17" name="__codelineno-193-17" href="#__codelineno-193-17"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-193-18"><a id="__codelineno-193-18" name="__codelineno-193-18" href="#__codelineno-193-18"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;Maven构建代码&#39;</span><span class="o">){</span>
</span><span id="__span-193-19"><a id="__codelineno-193-19" name="__codelineno-193-19" href="#__codelineno-193-19"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-20"><a id="__codelineno-193-20" name="__codelineno-193-20" href="#__codelineno-193-20"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#39;</span>
</span><span id="__span-193-21"><a id="__codelineno-193-21" name="__codelineno-193-21" href="#__codelineno-193-21"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-193-22"><a id="__codelineno-193-22" name="__codelineno-193-22" href="#__codelineno-193-22"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-193-23"><a id="__codelineno-193-23" name="__codelineno-193-23" href="#__codelineno-193-23"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;SonarQube检测代码&#39;</span><span class="o">){</span>
</span><span id="__span-193-24"><a id="__codelineno-193-24" name="__codelineno-193-24" href="#__codelineno-193-24"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-25"><a id="__codelineno-193-25" name="__codelineno-193-25" href="#__codelineno-193-25"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=${JOB_NAME} -Dsonar.projectKey=${JOB_NAME} -Dsonar.java.binaries=target/ -Dsonar.login=${sonarLogin}&#39;</span>
</span><span id="__span-193-26"><a id="__codelineno-193-26" name="__codelineno-193-26" href="#__codelineno-193-26"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-193-27"><a id="__codelineno-193-27" name="__codelineno-193-27" href="#__codelineno-193-27"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-193-28"><a id="__codelineno-193-28" name="__codelineno-193-28" href="#__codelineno-193-28"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;制作自定义镜像&#39;</span><span class="o">){</span>
</span><span id="__span-193-29"><a id="__codelineno-193-29" name="__codelineno-193-29" href="#__codelineno-193-29"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-30"><a id="__codelineno-193-30" name="__codelineno-193-30" href="#__codelineno-193-30"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;&#39;&#39;cd docker</span>
</span><span id="__span-193-31"><a id="__codelineno-193-31" name="__codelineno-193-31" href="#__codelineno-193-31"></a><span class="s1">                mv ../target/*.jar ./</span>
</span><span id="__span-193-32"><a id="__codelineno-193-32" name="__codelineno-193-32" href="#__codelineno-193-32"></a><span class="s1">                docker build -t ${JOB_NAME}:$tag .</span>
</span><span id="__span-193-33"><a id="__codelineno-193-33" name="__codelineno-193-33" href="#__codelineno-193-33"></a><span class="s1">                &#39;&#39;&#39;</span>
</span><span id="__span-193-34"><a id="__codelineno-193-34" name="__codelineno-193-34" href="#__codelineno-193-34"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-193-35"><a id="__codelineno-193-35" name="__codelineno-193-35" href="#__codelineno-193-35"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-193-36"><a id="__codelineno-193-36" name="__codelineno-193-36" href="#__codelineno-193-36"></a>
</span><span id="__span-193-37"><a id="__codelineno-193-37" name="__codelineno-193-37" href="#__codelineno-193-37"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;推送自定义镜像&#39;</span><span class="o">){</span>
</span><span id="__span-193-38"><a id="__codelineno-193-38" name="__codelineno-193-38" href="#__codelineno-193-38"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-39"><a id="__codelineno-193-39" name="__codelineno-193-39" href="#__codelineno-193-39"></a><span class="w">                </span>sh<span class="w"> </span><span class="s1">&#39;&#39;&#39;docker login -u ${harborUser} -p ${harborPassword} ${harborHost}</span>
</span><span id="__span-193-40"><a id="__codelineno-193-40" name="__codelineno-193-40" href="#__codelineno-193-40"></a><span class="s1">                docker tag ${JOB_NAME}:$tag ${harborHost}/${harborRepo}/${JOB_NAME}:$tag</span>
</span><span id="__span-193-41"><a id="__codelineno-193-41" name="__codelineno-193-41" href="#__codelineno-193-41"></a><span class="s1">                docker push ${harborHost}/${harborRepo}/${JOB_NAME}:$tag&#39;&#39;&#39;</span>
</span><span id="__span-193-42"><a id="__codelineno-193-42" name="__codelineno-193-42" href="#__codelineno-193-42"></a><span class="w">            </span><span class="o">}</span>
</span><span id="__span-193-43"><a id="__codelineno-193-43" name="__codelineno-193-43" href="#__codelineno-193-43"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-193-44"><a id="__codelineno-193-44" name="__codelineno-193-44" href="#__codelineno-193-44"></a>
</span><span id="__span-193-45"><a id="__codelineno-193-45" name="__codelineno-193-45" href="#__codelineno-193-45"></a><span class="w">        </span>stage<span class="o">(</span><span class="s1">&#39;通知目标服务器&#39;</span><span class="o">){</span>
</span><span id="__span-193-46"><a id="__codelineno-193-46" name="__codelineno-193-46" href="#__codelineno-193-46"></a><span class="w">            </span>steps<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-47"><a id="__codelineno-193-47" name="__codelineno-193-47" href="#__codelineno-193-47"></a><span class="w">                </span>sshPublisher<span class="o">(</span>publishers:<span class="w"> </span><span class="o">[</span>sshPublisherDesc<span class="o">(</span>configName:<span class="w"> </span><span class="s1">&#39;centos-docker&#39;</span>,<span class="w"> </span>transfers:<span class="w"> </span><span class="o">[</span>sshTransfer<span class="o">(</span>cleanRemote:<span class="w"> </span>false,<span class="w"> </span>excludes:<span class="w"> </span><span class="s1">&#39;&#39;</span>,<span class="w"> </span>execCommand:<span class="w"> </span><span class="s2">&quot;/usr/bin/deploy.sh </span><span class="nv">$harborHost</span><span class="s2"> </span><span class="nv">$harborRepo</span><span class="s2"> </span><span class="nv">$JOB_NAME</span><span class="s2"> </span><span class="nv">$tag</span><span class="s2"> </span><span class="nv">$port</span><span class="s2">&quot;</span>,<span class="w"> </span>execTimeout:<span class="w"> </span><span class="m">120000</span>,<span class="w"> </span>flatten:<span class="w"> </span>false,<span class="w"> </span>makeEmptyDirs:<span class="w"> </span>false,<span class="w"> </span>noDefaultExcludes:<span class="w"> </span>false,<span class="w"> </span>patternSeparator:<span class="w"> </span><span class="s1">&#39;[, ]+&#39;</span>,<span class="w"> </span>remoteDirectory:<span class="w"> </span><span class="s1">&#39;&#39;</span>,<span class="w"> </span>remoteDirectorySDF:<span class="w"> </span>false,<span class="w"> </span>removePrefix:<span class="w"> </span><span class="s1">&#39;&#39;</span>,<span class="w"> </span>sourceFiles:<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">)]</span>,<span class="w"> </span>usePromotionTimestamp:<span class="w"> </span>false,<span class="w"> </span>useWorkspaceInPromotion:<span class="w"> </span>false,<span class="w"> </span>verbose:<span class="w"> </span><span class="nb">false</span><span class="o">)])</span>
</span><span id="__span-193-48"><a id="__codelineno-193-48" name="__codelineno-193-48" href="#__codelineno-193-48"></a><span class="w">            </span><span class="o">}</span><span class="w">  </span>
</span><span id="__span-193-49"><a id="__codelineno-193-49" name="__codelineno-193-49" href="#__codelineno-193-49"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-193-50"><a id="__codelineno-193-50" name="__codelineno-193-50" href="#__codelineno-193-50"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-193-51"><a id="__codelineno-193-51" name="__codelineno-193-51" href="#__codelineno-193-51"></a><span class="w">    </span>post<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-52"><a id="__codelineno-193-52" name="__codelineno-193-52" href="#__codelineno-193-52"></a><span class="w">        </span>success<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-53"><a id="__codelineno-193-53" name="__codelineno-193-53" href="#__codelineno-193-53"></a><span class="w">            </span>dingtalk<span class="w"> </span><span class="o">(</span>
</span><span id="__span-193-54"><a id="__codelineno-193-54" name="__codelineno-193-54" href="#__codelineno-193-54"></a><span class="w">                </span>robot:<span class="w"> </span><span class="s1">&#39;Jenkins-DingDing&#39;</span>,
</span><span id="__span-193-55"><a id="__codelineno-193-55" name="__codelineno-193-55" href="#__codelineno-193-55"></a><span class="w">                </span>type:<span class="s1">&#39;MARKDOWN&#39;</span>,
</span><span id="__span-193-56"><a id="__codelineno-193-56" name="__codelineno-193-56" href="#__codelineno-193-56"></a><span class="w">                </span>title:<span class="w"> </span><span class="s2">&quot;success: </span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">&quot;</span>,
</span><span id="__span-193-57"><a id="__codelineno-193-57" name="__codelineno-193-57" href="#__codelineno-193-57"></a><span class="w">                </span>text:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;- 成功构建:</span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">项目!\n- 版本:</span><span class="si">${</span><span class="nv">tag</span><span class="si">}</span><span class="s2">\n- 持续时间:</span><span class="si">${</span><span class="nv">currentBuild</span><span class="p">.durationString</span><span class="si">}</span><span class="s2">\n- 任务:#</span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]</span>
</span><span id="__span-193-58"><a id="__codelineno-193-58" name="__codelineno-193-58" href="#__codelineno-193-58"></a><span class="w">            </span><span class="o">)</span>
</span><span id="__span-193-59"><a id="__codelineno-193-59" name="__codelineno-193-59" href="#__codelineno-193-59"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-193-60"><a id="__codelineno-193-60" name="__codelineno-193-60" href="#__codelineno-193-60"></a><span class="w">        </span>failure<span class="w"> </span><span class="o">{</span>
</span><span id="__span-193-61"><a id="__codelineno-193-61" name="__codelineno-193-61" href="#__codelineno-193-61"></a><span class="w">            </span>dingtalk<span class="w"> </span><span class="o">(</span>
</span><span id="__span-193-62"><a id="__codelineno-193-62" name="__codelineno-193-62" href="#__codelineno-193-62"></a><span class="w">                </span>robot:<span class="w"> </span><span class="s1">&#39;Jenkins-DingDing&#39;</span>,
</span><span id="__span-193-63"><a id="__codelineno-193-63" name="__codelineno-193-63" href="#__codelineno-193-63"></a><span class="w">                </span>type:<span class="s1">&#39;MARKDOWN&#39;</span>,
</span><span id="__span-193-64"><a id="__codelineno-193-64" name="__codelineno-193-64" href="#__codelineno-193-64"></a><span class="w">                </span>title:<span class="w"> </span><span class="s2">&quot;fail: </span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">&quot;</span>,
</span><span id="__span-193-65"><a id="__codelineno-193-65" name="__codelineno-193-65" href="#__codelineno-193-65"></a><span class="w">                </span>text:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;- 失败构建:</span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">项目!\n- 版本:</span><span class="si">${</span><span class="nv">tag</span><span class="si">}</span><span class="s2">\n- 持续时间:</span><span class="si">${</span><span class="nv">currentBuild</span><span class="p">.durationString</span><span class="si">}</span><span class="s2">\n- 任务:#</span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]</span>
</span><span id="__span-193-66"><a id="__codelineno-193-66" name="__codelineno-193-66" href="#__codelineno-193-66"></a><span class="w">            </span><span class="o">)</span>
</span><span id="__span-193-67"><a id="__codelineno-193-67" name="__codelineno-193-67" href="#__codelineno-193-67"></a><span class="w">        </span><span class="o">}</span>
</span><span id="__span-193-68"><a id="__codelineno-193-68" name="__codelineno-193-68" href="#__codelineno-193-68"></a><span class="w">    </span><span class="o">}</span>
</span><span id="__span-193-69"><a id="__codelineno-193-69" name="__codelineno-193-69" href="#__codelineno-193-69"></a><span class="o">}</span>
</span></code></pre></div>
<ul>
<li>查看效果</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">钉钉通知效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211209163021396" src="../../images/DevOps/image-20211209163021396.png" /></td>
</tr>
</tbody>
</table>
<h4 id="kubernetes"><a class="toclink" href="../../devops/#kubernetes">十、Kubernetes编排工具</a></h4>
<h5 id="101-kubernetes"><a class="toclink" href="../../devops/#101-kubernetes">10.1 Kubernetes介绍</a></h5>
<p>Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful），Kubernetes提供了应用部署，规划，更新，维护的一种机制。</p>
<p>Kubernetes一个核心的特点就是能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行着，管理员可以加载一个微型服务，让规划器来找到合适的位置，同时，Kubernetes也系统提升工具以及人性化方面，让用户能够方便的部署自己的应用。</p>
<p>Kubernetes主要能帮助我们完成：</p>
<ul>
<li>服务发现和负载均衡</li>
</ul>
<p>Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果进入容器的流量很大， Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</p>
<ul>
<li>存储编排</li>
</ul>
<p>Kubernetes 允许你自动挂载你选择的存储系统，比如本地存储，类似Docker的数据卷。</p>
<ul>
<li>自动部署和回滚</li>
</ul>
<p>你可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态 更改为期望状态。Kubernetes 会自动帮你根据情况部署创建新容器，并删除现有容器给新容器提供资源。</p>
<ul>
<li>自动完成装箱计算</li>
</ul>
<p>Kubernetes 允许你设置每个容器的资源，比如CPU和内存。</p>
<ul>
<li>自我修复</li>
</ul>
<p>Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的容器，并运行状况检查的容器。</p>
<ul>
<li>秘钥与配置管理</li>
</ul>
<p>Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p>
<h5 id="102-kubernetes"><a class="toclink" href="../../devops/#102-kubernetes">10.2 Kubernetes架构</a></h5>
<p>Kubernetes 搭建需要至少两个节点，一个Master负责管理，一个Slave搭建在工作服务器上负责分配。</p>
<table>
<thead>
<tr>
<th style="text-align: center;">kubernetes架构</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211210114507638" src="../../images/DevOps/image-20211210114507638.png" /></td>
</tr>
</tbody>
</table>
<p>从图中可以看到各个组件的基本功能：</p>
<ul>
<li>API Server：作为K8s通讯的核心组件，K8s内部交互以及接收发送指令的组件。</li>
<li>controller-manager：作为K8s的核心组件，主要做资源调度，根据集群情况分配资源</li>
<li>etcd：一个key-value的数据库，存储存储集群的状态信息</li>
<li>scheduler：负责调度每个工作节点</li>
<li>cloud-controller-manager：负责调度其他云服务产品</li>
<li>kubelet：管理Pods上面的容器。</li>
<li>kube-proxy：负责处理其他Slave或客户端的请求。</li>
<li>Pod：可以理解为就是运行的容器</li>
</ul>
<h5 id="103-kubernetes"><a class="toclink" href="../../devops/#103-kubernetes">10.3 Kubernetes安装</a></h5>
<p>这里会采用https://kuboard.cn/提供的方式安装K8s，安装单Master节点</p>
<ul>
<li>要求使用Centos7.8版本：https://vault.centos.org/7.8.2003/isos/x86_64/CentOS-7-x86_64-Minimal-2003.iso</li>
<li>至少2台 <strong>2核4G</strong> 的服务器</li>
</ul>
<p>安装流程</p>
<table>
<thead>
<tr>
<th style="text-align: center;">安装流程</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211210190653687" src="../../images/DevOps/image-20211210190653687.png" /></td>
</tr>
</tbody>
</table>
<p>准备好服务器后开始安装</p>
<ul>
<li>重新设置hostname，不允许为localhost</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-194-1"><a id="__codelineno-194-1" name="__codelineno-194-1" href="#__codelineno-194-1"></a><span class="c1"># 修改 hostname，名字不允许使用下划线、小数点、大写字母，不能叫master</span>
</span><span id="__span-194-2"><a id="__codelineno-194-2" name="__codelineno-194-2" href="#__codelineno-194-2"></a>hostnamectl<span class="w"> </span>set-hostname<span class="w"> </span>your-new-host-name
</span><span id="__span-194-3"><a id="__codelineno-194-3" name="__codelineno-194-3" href="#__codelineno-194-3"></a><span class="c1"># 查看修改结果</span>
</span><span id="__span-194-4"><a id="__codelineno-194-4" name="__codelineno-194-4" href="#__codelineno-194-4"></a>hostnamectl<span class="w"> </span>status
</span><span id="__span-194-5"><a id="__codelineno-194-5" name="__codelineno-194-5" href="#__codelineno-194-5"></a><span class="c1"># 设置 hostname 解析</span>
</span><span id="__span-194-6"><a id="__codelineno-194-6" name="__codelineno-194-6" href="#__codelineno-194-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;127.0.0.1   </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/hosts
</span></code></pre></div>
<ul>
<li>
<p>要求2台服务之间可以相互通讯</p>
</li>
<li>
<p>安装软件</p>
</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-195-1"><a id="__codelineno-195-1" name="__codelineno-195-1" href="#__codelineno-195-1"></a><span class="c1"># 阿里云 docker hub 镜像</span>
</span><span id="__span-195-2"><a id="__codelineno-195-2" name="__codelineno-195-2" href="#__codelineno-195-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">REGISTRY_MIRROR</span><span class="o">=</span>https://registry.cn-hangzhou.aliyuncs.com
</span><span id="__span-195-3"><a id="__codelineno-195-3" name="__codelineno-195-3" href="#__codelineno-195-3"></a>curl<span class="w"> </span>-sSL<span class="w"> </span>https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh<span class="w"> </span>-s<span class="w"> </span><span class="m">1</span>.19.5
</span></code></pre></div>
<p>首先初始化Master节点</p>
<blockquote>
<p>关于初始化时用到的环境变量</p>
<ul>
<li><strong>APISERVER_NAME</strong> 不能是 master 的 hostname</li>
<li><strong>APISERVER_NAME</strong> 必须全为小写字母、数字、小数点，不能包含减号</li>
<li><strong>POD_SUBNET</strong> 所使用的网段不能与 <strong><em>master节点/worker节点</em></strong> 所在的网段重叠。该字段的取值为一个 <a href="https://kuboard.cn/glossary/cidr.html">CIDR</a> 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.0/16 命令，不做修改</li>
</ul>
</blockquote>
<ul>
<li>设置ip，域名，网段并执行初始化操作</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-196-1"><a id="__codelineno-196-1" name="__codelineno-196-1" href="#__codelineno-196-1"></a><span class="c1"># 只在 master 节点执行</span>
</span><span id="__span-196-2"><a id="__codelineno-196-2" name="__codelineno-196-2" href="#__codelineno-196-2"></a><span class="c1"># 替换 x.x.x.x 为 master 节点实际 IP（请使用内网 IP）</span>
</span><span id="__span-196-3"><a id="__codelineno-196-3" name="__codelineno-196-3" href="#__codelineno-196-3"></a><span class="c1"># export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span>
</span><span id="__span-196-4"><a id="__codelineno-196-4" name="__codelineno-196-4" href="#__codelineno-196-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">MASTER_IP</span><span class="o">=</span><span class="m">192</span>.168.11.32
</span><span id="__span-196-5"><a id="__codelineno-196-5" name="__codelineno-196-5" href="#__codelineno-196-5"></a><span class="c1"># 替换 apiserver.demo 为 您想要的 dnsName</span>
</span><span id="__span-196-6"><a id="__codelineno-196-6" name="__codelineno-196-6" href="#__codelineno-196-6"></a><span class="nb">export</span><span class="w"> </span><span class="nv">APISERVER_NAME</span><span class="o">=</span>apiserver.demo
</span><span id="__span-196-7"><a id="__codelineno-196-7" name="__codelineno-196-7" href="#__codelineno-196-7"></a><span class="c1"># Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span>
</span><span id="__span-196-8"><a id="__codelineno-196-8" name="__codelineno-196-8" href="#__codelineno-196-8"></a><span class="nb">export</span><span class="w"> </span><span class="nv">POD_SUBNET</span><span class="o">=</span><span class="m">10</span>.100.0.1/16
</span><span id="__span-196-9"><a id="__codelineno-196-9" name="__codelineno-196-9" href="#__codelineno-196-9"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MASTER_IP</span><span class="si">}</span><span class="s2">    </span><span class="si">${</span><span class="nv">APISERVER_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/hosts
</span><span id="__span-196-10"><a id="__codelineno-196-10" name="__codelineno-196-10" href="#__codelineno-196-10"></a>curl<span class="w"> </span>-sSL<span class="w"> </span>https://kuboard.cn/install-script/v1.19.x/init_master.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh<span class="w"> </span>-s<span class="w"> </span><span class="m">1</span>.19.5
</span></code></pre></div>
<ul>
<li>检查Master启动状态</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-197-1"><a id="__codelineno-197-1" name="__codelineno-197-1" href="#__codelineno-197-1"></a><span class="c1"># 只在 master 节点执行</span>
</span><span id="__span-197-2"><a id="__codelineno-197-2" name="__codelineno-197-2" href="#__codelineno-197-2"></a>
</span><span id="__span-197-3"><a id="__codelineno-197-3" name="__codelineno-197-3" href="#__codelineno-197-3"></a><span class="c1"># 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span>
</span><span id="__span-197-4"><a id="__codelineno-197-4" name="__codelineno-197-4" href="#__codelineno-197-4"></a>watch<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>-o<span class="w"> </span>wide
</span><span id="__span-197-5"><a id="__codelineno-197-5" name="__codelineno-197-5" href="#__codelineno-197-5"></a>
</span><span id="__span-197-6"><a id="__codelineno-197-6" name="__codelineno-197-6" href="#__codelineno-197-6"></a><span class="c1"># 查看 master 节点初始化结果</span>
</span><span id="__span-197-7"><a id="__codelineno-197-7" name="__codelineno-197-7" href="#__codelineno-197-7"></a>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>wide
</span></code></pre></div>
<p><code>Ps：如果出现NotReady的情况执行（最新版本的BUG，1.19一般没有）</code></p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-198-1"><a id="__codelineno-198-1" name="__codelineno-198-1" href="#__codelineno-198-1"></a>docker<span class="w"> </span>pull<span class="w"> </span>quay.io/coreos/flannel:v0.10.0-amd64<span class="w"> </span>
</span><span id="__span-198-2"><a id="__codelineno-198-2" name="__codelineno-198-2" href="#__codelineno-198-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/cni/net.d/
</span><span id="__span-198-3"><a id="__codelineno-198-3" name="__codelineno-198-3" href="#__codelineno-198-3"></a>cat<span class="w"> </span><span class="s">&lt;&lt;EOF&gt; /etc/cni/net.d/10-flannel.conf</span>
</span><span id="__span-198-4"><a id="__codelineno-198-4" name="__codelineno-198-4" href="#__codelineno-198-4"></a><span class="s">{&quot;name&quot;:&quot;cbr0&quot;,&quot;type&quot;:&quot;flannel&quot;,&quot;delegate&quot;: {&quot;isDefaultGateway&quot;: true}}</span>
</span><span id="__span-198-5"><a id="__codelineno-198-5" name="__codelineno-198-5" href="#__codelineno-198-5"></a><span class="s">EOF</span>
</span><span id="__span-198-6"><a id="__codelineno-198-6" name="__codelineno-198-6" href="#__codelineno-198-6"></a>mkdir<span class="w"> </span>/usr/share/oci-umount/oci-umount.d<span class="w"> </span>-p
</span><span id="__span-198-7"><a id="__codelineno-198-7" name="__codelineno-198-7" href="#__codelineno-198-7"></a>mkdir<span class="w"> </span>/run/flannel/
</span><span id="__span-198-8"><a id="__codelineno-198-8" name="__codelineno-198-8" href="#__codelineno-198-8"></a>cat<span class="w"> </span><span class="s">&lt;&lt;EOF&gt; /run/flannel/subnet.env</span>
</span><span id="__span-198-9"><a id="__codelineno-198-9" name="__codelineno-198-9" href="#__codelineno-198-9"></a><span class="s">FLANNEL_NETWORK=172.100.0.0/16</span>
</span><span id="__span-198-10"><a id="__codelineno-198-10" name="__codelineno-198-10" href="#__codelineno-198-10"></a><span class="s">FLANNEL_SUBNET=172.100.1.0/24</span>
</span><span id="__span-198-11"><a id="__codelineno-198-11" name="__codelineno-198-11" href="#__codelineno-198-11"></a><span class="s">FLANNEL_MTU=1450</span>
</span><span id="__span-198-12"><a id="__codelineno-198-12" name="__codelineno-198-12" href="#__codelineno-198-12"></a><span class="s">FLANNEL_IPMASQ=true</span>
</span><span id="__span-198-13"><a id="__codelineno-198-13" name="__codelineno-198-13" href="#__codelineno-198-13"></a><span class="s">EOF</span>
</span><span id="__span-198-14"><a id="__codelineno-198-14" name="__codelineno-198-14" href="#__codelineno-198-14"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml
</span></code></pre></div>
<p>安装网络服务插件</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-199-1"><a id="__codelineno-199-1" name="__codelineno-199-1" href="#__codelineno-199-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">POD_SUBNET</span><span class="o">=</span><span class="m">10</span>.100.0.0/16
</span><span id="__span-199-2"><a id="__codelineno-199-2" name="__codelineno-199-2" href="#__codelineno-199-2"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://kuboard.cn/install-script/v1.22.x/calico-operator.yaml
</span><span id="__span-199-3"><a id="__codelineno-199-3" name="__codelineno-199-3" href="#__codelineno-199-3"></a>wget<span class="w"> </span>https://kuboard.cn/install-script/v1.22.x/calico-custom-resources.yaml
</span><span id="__span-199-4"><a id="__codelineno-199-4" name="__codelineno-199-4" href="#__codelineno-199-4"></a>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s#192.168.0.0/16#</span><span class="si">${</span><span class="nv">POD_SUBNET</span><span class="si">}</span><span class="s2">#&quot;</span><span class="w"> </span>calico-custom-resources.yaml
</span><span id="__span-199-5"><a id="__codelineno-199-5" name="__codelineno-199-5" href="#__codelineno-199-5"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>calico-custom-resources.yaml
</span></code></pre></div>
<p>初始化worker节点</p>
<ul>
<li>获取Join命令参数，在Master节点执行</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-200-1"><a id="__codelineno-200-1" name="__codelineno-200-1" href="#__codelineno-200-1"></a><span class="c1"># 只在 master 节点执行</span>
</span><span id="__span-200-2"><a id="__codelineno-200-2" name="__codelineno-200-2" href="#__codelineno-200-2"></a>kubeadm<span class="w"> </span>token<span class="w"> </span>create<span class="w"> </span>--print-join-command
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">获取命令</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211213183025291" src="../../images/DevOps/image-20211213183025291.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>在worker节点初始化</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-201-1"><a id="__codelineno-201-1" name="__codelineno-201-1" href="#__codelineno-201-1"></a><span class="c1"># 只在 worker 节点执行</span>
</span><span id="__span-201-2"><a id="__codelineno-201-2" name="__codelineno-201-2" href="#__codelineno-201-2"></a><span class="c1"># 替换 x.x.x.x 为 master 节点的内网 IP</span>
</span><span id="__span-201-3"><a id="__codelineno-201-3" name="__codelineno-201-3" href="#__codelineno-201-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">MASTER_IP</span><span class="o">=</span><span class="m">192</span>.168.11.32
</span><span id="__span-201-4"><a id="__codelineno-201-4" name="__codelineno-201-4" href="#__codelineno-201-4"></a><span class="c1"># 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span>
</span><span id="__span-201-5"><a id="__codelineno-201-5" name="__codelineno-201-5" href="#__codelineno-201-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">APISERVER_NAME</span><span class="o">=</span>apiserver.demo
</span><span id="__span-201-6"><a id="__codelineno-201-6" name="__codelineno-201-6" href="#__codelineno-201-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MASTER_IP</span><span class="si">}</span><span class="s2">    </span><span class="si">${</span><span class="nv">APISERVER_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/hosts
</span><span id="__span-201-7"><a id="__codelineno-201-7" name="__codelineno-201-7" href="#__codelineno-201-7"></a>
</span><span id="__span-201-8"><a id="__codelineno-201-8" name="__codelineno-201-8" href="#__codelineno-201-8"></a><span class="c1"># 替换为 master 节点上 kubeadm token create 命令的输出</span>
</span><span id="__span-201-9"><a id="__codelineno-201-9" name="__codelineno-201-9" href="#__codelineno-201-9"></a>kubeadm<span class="w"> </span>join<span class="w"> </span>apiserver.demo:6443<span class="w"> </span>--token<span class="w"> </span>vwfilu.3nhndohc5gn1jv9k<span class="w">     </span>--discovery-token-ca-cert-hash<span class="w"> </span>sha256:22ff15cabfe87ab48a7db39b3bbf986fee92ec92eb8efc7fe9b0abe2175ff0c2
</span></code></pre></div>
<p>检查最终运行效果</p>
<ul>
<li>在 master 节点上执行</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-202-1"><a id="__codelineno-202-1" name="__codelineno-202-1" href="#__codelineno-202-1"></a><span class="c1"># 只在 master 节点执行</span>
</span><span id="__span-202-2"><a id="__codelineno-202-2" name="__codelineno-202-2" href="#__codelineno-202-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>wide
</span></code></pre></div>
<p><code>Ps：如果出现NotReady的情况执行（最新版本的BUG，1.19一般没有）</code></p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-203-1"><a id="__codelineno-203-1" name="__codelineno-203-1" href="#__codelineno-203-1"></a>docker<span class="w"> </span>pull<span class="w"> </span>quay.io/coreos/flannel:v0.10.0-amd64<span class="w"> </span>
</span><span id="__span-203-2"><a id="__codelineno-203-2" name="__codelineno-203-2" href="#__codelineno-203-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/cni/net.d/
</span><span id="__span-203-3"><a id="__codelineno-203-3" name="__codelineno-203-3" href="#__codelineno-203-3"></a>cat<span class="w"> </span><span class="s">&lt;&lt;EOF&gt; /etc/cni/net.d/10-flannel.conf</span>
</span><span id="__span-203-4"><a id="__codelineno-203-4" name="__codelineno-203-4" href="#__codelineno-203-4"></a><span class="s">{&quot;name&quot;:&quot;cbr0&quot;,&quot;type&quot;:&quot;flannel&quot;,&quot;delegate&quot;: {&quot;isDefaultGateway&quot;: true}}</span>
</span><span id="__span-203-5"><a id="__codelineno-203-5" name="__codelineno-203-5" href="#__codelineno-203-5"></a><span class="s">EOF</span>
</span><span id="__span-203-6"><a id="__codelineno-203-6" name="__codelineno-203-6" href="#__codelineno-203-6"></a>mkdir<span class="w"> </span>/usr/share/oci-umount/oci-umount.d<span class="w"> </span>-p
</span><span id="__span-203-7"><a id="__codelineno-203-7" name="__codelineno-203-7" href="#__codelineno-203-7"></a>mkdir<span class="w"> </span>/run/flannel/
</span><span id="__span-203-8"><a id="__codelineno-203-8" name="__codelineno-203-8" href="#__codelineno-203-8"></a>cat<span class="w"> </span><span class="s">&lt;&lt;EOF&gt; /run/flannel/subnet.env</span>
</span><span id="__span-203-9"><a id="__codelineno-203-9" name="__codelineno-203-9" href="#__codelineno-203-9"></a><span class="s">FLANNEL_NETWORK=172.100.0.0/16</span>
</span><span id="__span-203-10"><a id="__codelineno-203-10" name="__codelineno-203-10" href="#__codelineno-203-10"></a><span class="s">FLANNEL_SUBNET=172.100.1.0/24</span>
</span><span id="__span-203-11"><a id="__codelineno-203-11" name="__codelineno-203-11" href="#__codelineno-203-11"></a><span class="s">FLANNEL_MTU=1450</span>
</span><span id="__span-203-12"><a id="__codelineno-203-12" name="__codelineno-203-12" href="#__codelineno-203-12"></a><span class="s">FLANNEL_IPMASQ=true</span>
</span><span id="__span-203-13"><a id="__codelineno-203-13" name="__codelineno-203-13" href="#__codelineno-203-13"></a><span class="s">EOF</span>
</span><span id="__span-203-14"><a id="__codelineno-203-14" name="__codelineno-203-14" href="#__codelineno-203-14"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml
</span></code></pre></div>
<ul>
<li>输出结果如下所示：</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-204-1"><a id="__codelineno-204-1" name="__codelineno-204-1" href="#__codelineno-204-1"></a><span class="o">[</span>root@k8smaster<span class="w"> </span>~<span class="o">]</span><span class="c1"># kubectl get nodes</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">搭建成功效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211210184851810" src="../../images/DevOps/image-20211210184851810.png" /></td>
</tr>
</tbody>
</table>
<p>安装Kuboard管理K8s集群</p>
<ul>
<li>安装Kuboard</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-205-1"><a id="__codelineno-205-1" name="__codelineno-205-1" href="#__codelineno-205-1"></a>kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml
</span><span id="__span-205-2"><a id="__codelineno-205-2" name="__codelineno-205-2" href="#__codelineno-205-2"></a># 您也可以使用下面的指令，唯一的区别是，该指令使用华为云的镜像仓库替代 docker hub 分发 Kuboard 所需要的镜像
</span><span id="__span-205-3"><a id="__codelineno-205-3" name="__codelineno-205-3" href="#__codelineno-205-3"></a># kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3-swr.yaml
</span></code></pre></div>
<ul>
<li>查看启动情况</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-206-1"><a id="__codelineno-206-1" name="__codelineno-206-1" href="#__codelineno-206-1"></a>watch kubectl get pods -n kuboard
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">查看效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211213184701784" src="../../images/DevOps/image-20211213184701784.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>在浏览器中打开链接 http://your-node-ip-address:30080</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">首页</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211213184742709" src="../../images/DevOps/image-20211213184742709.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>输入初始用户名和密码，并登录</p>
</li>
<li>
<p>用户名： <code>admin</code></p>
</li>
<li>密码： <code>Kuboard123</code></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">首页效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20211213184840120" src="../../images/DevOps/image-20211213184840120.png" /></td>
</tr>
</tbody>
</table>
<h5 id="104-kubernetes"><a class="toclink" href="../../devops/#104-kubernetes">10.4 Kubernetes操作</a></h5>
<p>首先我们要了解Kubernetes在运行我们的资源时，关联到了哪些内容</p>
<ul>
<li>
<p>资源的构建方式：</p>
</li>
<li>
<p>采用kubectl的命令方式</p>
</li>
<li>yaml文件方式</li>
</ul>
<h6 id="1041-namespace"><a class="toclink" href="../../devops/#1041-namespace">10.4.1 Namespace</a></h6>
<ul>
<li>命名空间：主要是为了对Kubernetes中运行的资源进行过隔离， 但是网络是互通的，类似Docker的容器，可以将多个资源配置到一个NameSpace中。而NameSpace可以对不同环境进行资源隔离，默认情况下Kubernetes提供了default命名空间，在构建资源时，如果不指定资源，默认采用default资源。
  命令方式：</li>
</ul>
<p><div class="language-sh highlight"><pre><span></span><code><span id="__span-207-1"><a id="__codelineno-207-1" name="__codelineno-207-1" href="#__codelineno-207-1"></a><span class="c1"># 查看现有的全部命名空间</span>
</span><span id="__span-207-2"><a id="__codelineno-207-2" name="__codelineno-207-2" href="#__codelineno-207-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>ns
</span><span id="__span-207-3"><a id="__codelineno-207-3" name="__codelineno-207-3" href="#__codelineno-207-3"></a>
</span><span id="__span-207-4"><a id="__codelineno-207-4" name="__codelineno-207-4" href="#__codelineno-207-4"></a><span class="c1"># 构建命名空间</span>
</span><span id="__span-207-5"><a id="__codelineno-207-5" name="__codelineno-207-5" href="#__codelineno-207-5"></a>kubectl<span class="w"> </span>create<span class="w"> </span>ns<span class="w"> </span>命名空间名称
</span><span id="__span-207-6"><a id="__codelineno-207-6" name="__codelineno-207-6" href="#__codelineno-207-6"></a>
</span><span id="__span-207-7"><a id="__codelineno-207-7" name="__codelineno-207-7" href="#__codelineno-207-7"></a><span class="c1"># 删除现有命名空间， 并且会删除空间下的全部资源</span>
</span><span id="__span-207-8"><a id="__codelineno-207-8" name="__codelineno-207-8" href="#__codelineno-207-8"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>ns<span class="w"> </span>命名空间名称
</span></code></pre></div>
  yaml文件方式：（构建资源时，设置命名空间）</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-208-1"><a id="__codelineno-208-1" name="__codelineno-208-1" href="#__codelineno-208-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-208-2"><a id="__codelineno-208-2" name="__codelineno-208-2" href="#__codelineno-208-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id="__span-208-3"><a id="__codelineno-208-3" name="__codelineno-208-3" href="#__codelineno-208-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-208-4"><a id="__codelineno-208-4" name="__codelineno-208-4" href="#__codelineno-208-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span></code></pre></div>
<h6 id="1042-pod"><a class="toclink" href="../../devops/#1042-pod">10.4.2 Pod</a></h6>
<ul>
<li>
<p>Pod：Kubernetes运行的一组容器，Pod是Kubernetes的最小单位，但是对于Docker而然，Pod中会运行多个Docker容器</p>
</li>
<li>
<p>命令方式：
    <div class="language-bash highlight"><pre><span></span><code><span id="__span-209-1"><a id="__codelineno-209-1" name="__codelineno-209-1" href="#__codelineno-209-1"></a><span class="c1"># 查看所有运行的pod</span>
</span><span id="__span-209-2"><a id="__codelineno-209-2" name="__codelineno-209-2" href="#__codelineno-209-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-A
</span><span id="__span-209-3"><a id="__codelineno-209-3" name="__codelineno-209-3" href="#__codelineno-209-3"></a>
</span><span id="__span-209-4"><a id="__codelineno-209-4" name="__codelineno-209-4" href="#__codelineno-209-4"></a><span class="c1"># 查看指定Namespace下的Pod</span>
</span><span id="__span-209-5"><a id="__codelineno-209-5" name="__codelineno-209-5" href="#__codelineno-209-5"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span><span class="o">[</span>-n<span class="w"> </span>命名空间<span class="o">]</span><span class="w">  </span><span class="c1">#（默认default）</span>
</span><span id="__span-209-6"><a id="__codelineno-209-6" name="__codelineno-209-6" href="#__codelineno-209-6"></a>
</span><span id="__span-209-7"><a id="__codelineno-209-7" name="__codelineno-209-7" href="#__codelineno-209-7"></a><span class="c1"># 创建Pod</span>
</span><span id="__span-209-8"><a id="__codelineno-209-8" name="__codelineno-209-8" href="#__codelineno-209-8"></a>kubectl<span class="w"> </span>run<span class="w"> </span>pod名称<span class="w"> </span>--image<span class="o">=</span>镜像名称
</span><span id="__span-209-9"><a id="__codelineno-209-9" name="__codelineno-209-9" href="#__codelineno-209-9"></a>
</span><span id="__span-209-10"><a id="__codelineno-209-10" name="__codelineno-209-10" href="#__codelineno-209-10"></a><span class="c1"># 查看Pod详细信息</span>
</span><span id="__span-209-11"><a id="__codelineno-209-11" name="__codelineno-209-11" href="#__codelineno-209-11"></a>kubectl<span class="w"> </span>describe<span class="w"> </span>pod<span class="w"> </span>pod名称
</span><span id="__span-209-12"><a id="__codelineno-209-12" name="__codelineno-209-12" href="#__codelineno-209-12"></a>
</span><span id="__span-209-13"><a id="__codelineno-209-13" name="__codelineno-209-13" href="#__codelineno-209-13"></a><span class="c1"># 删除pod</span>
</span><span id="__span-209-14"><a id="__codelineno-209-14" name="__codelineno-209-14" href="#__codelineno-209-14"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>pod名称<span class="w"> </span><span class="o">[</span>-n<span class="w"> </span>命名空间<span class="o">]</span><span class="w">  </span><span class="c1">#（默认default）</span>
</span><span id="__span-209-15"><a id="__codelineno-209-15" name="__codelineno-209-15" href="#__codelineno-209-15"></a>
</span><span id="__span-209-16"><a id="__codelineno-209-16" name="__codelineno-209-16" href="#__codelineno-209-16"></a><span class="c1"># 查看pod输出的日志</span>
</span><span id="__span-209-17"><a id="__codelineno-209-17" name="__codelineno-209-17" href="#__codelineno-209-17"></a>kubectl<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>pod名称
</span><span id="__span-209-18"><a id="__codelineno-209-18" name="__codelineno-209-18" href="#__codelineno-209-18"></a>
</span><span id="__span-209-19"><a id="__codelineno-209-19" name="__codelineno-209-19" href="#__codelineno-209-19"></a><span class="c1"># 进去pod容器内部</span>
</span><span id="__span-209-20"><a id="__codelineno-209-20" name="__codelineno-209-20" href="#__codelineno-209-20"></a>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>pod名称<span class="w"> </span>--<span class="w"> </span>bash
</span><span id="__span-209-21"><a id="__codelineno-209-21" name="__codelineno-209-21" href="#__codelineno-209-21"></a>
</span><span id="__span-209-22"><a id="__codelineno-209-22" name="__codelineno-209-22" href="#__codelineno-209-22"></a><span class="c1"># 查看kubernetes给Pod分配的ip信息，并且通过ip和容器的端口，可以直接访问</span>
</span><span id="__span-209-23"><a id="__codelineno-209-23" name="__codelineno-209-23" href="#__codelineno-209-23"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-owide
</span></code></pre></div></p>
</li>
<li>
<p>yaml方式（推荐）
    <div class="language-yaml highlight"><pre><span></span><code><span id="__span-210-1"><a id="__codelineno-210-1" name="__codelineno-210-1" href="#__codelineno-210-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-210-2"><a id="__codelineno-210-2" name="__codelineno-210-2" href="#__codelineno-210-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id="__span-210-3"><a id="__codelineno-210-3" name="__codelineno-210-3" href="#__codelineno-210-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-210-4"><a id="__codelineno-210-4" name="__codelineno-210-4" href="#__codelineno-210-4"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-210-5"><a id="__codelineno-210-5" name="__codelineno-210-5" href="#__codelineno-210-5"></a><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">运行的pod名称</span>
</span><span id="__span-210-6"><a id="__codelineno-210-6" name="__codelineno-210-6" href="#__codelineno-210-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod名称</span>
</span><span id="__span-210-7"><a id="__codelineno-210-7" name="__codelineno-210-7" href="#__codelineno-210-7"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">命名空间</span>
</span><span id="__span-210-8"><a id="__codelineno-210-8" name="__codelineno-210-8" href="#__codelineno-210-8"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-210-9"><a id="__codelineno-210-9" name="__codelineno-210-9" href="#__codelineno-210-9"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-210-10"><a id="__codelineno-210-10" name="__codelineno-210-10" href="#__codelineno-210-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">镜像名称</span>
</span><span id="__span-210-11"><a id="__codelineno-210-11" name="__codelineno-210-11" href="#__codelineno-210-11"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">容器名称</span>
</span><span id="__span-210-12"><a id="__codelineno-210-12" name="__codelineno-210-12" href="#__codelineno-210-12"></a>
</span><span id="__span-210-13"><a id="__codelineno-210-13" name="__codelineno-210-13" href="#__codelineno-210-13"></a><span class="c1"># 启动Pod：kubectl apply -f yaml文件名称</span>
</span><span id="__span-210-14"><a id="__codelineno-210-14" name="__codelineno-210-14" href="#__codelineno-210-14"></a><span class="c1"># 删除Pod：kubectl delete -f yaml文件名称</span>
</span></code></pre></div></p>
</li>
<li>
<p>Pod中运行多个容器</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-211-1"><a id="__codelineno-211-1" name="__codelineno-211-1" href="#__codelineno-211-1"></a>apiVersion: v1
</span><span id="__span-211-2"><a id="__codelineno-211-2" name="__codelineno-211-2" href="#__codelineno-211-2"></a>kind: Pod
</span><span id="__span-211-3"><a id="__codelineno-211-3" name="__codelineno-211-3" href="#__codelineno-211-3"></a>metadata:
</span><span id="__span-211-4"><a id="__codelineno-211-4" name="__codelineno-211-4" href="#__codelineno-211-4"></a>  labels:
</span><span id="__span-211-5"><a id="__codelineno-211-5" name="__codelineno-211-5" href="#__codelineno-211-5"></a>    run: 运行的pod名称
</span><span id="__span-211-6"><a id="__codelineno-211-6" name="__codelineno-211-6" href="#__codelineno-211-6"></a>  name: pod名称
</span><span id="__span-211-7"><a id="__codelineno-211-7" name="__codelineno-211-7" href="#__codelineno-211-7"></a>  namespace: 命名空间
</span><span id="__span-211-8"><a id="__codelineno-211-8" name="__codelineno-211-8" href="#__codelineno-211-8"></a>spec:
</span><span id="__span-211-9"><a id="__codelineno-211-9" name="__codelineno-211-9" href="#__codelineno-211-9"></a>  containers:
</span><span id="__span-211-10"><a id="__codelineno-211-10" name="__codelineno-211-10" href="#__codelineno-211-10"></a>  - image: 镜像名称
</span><span id="__span-211-11"><a id="__codelineno-211-11" name="__codelineno-211-11" href="#__codelineno-211-11"></a>    name: 容器名称
</span><span id="__span-211-12"><a id="__codelineno-211-12" name="__codelineno-211-12" href="#__codelineno-211-12"></a>  - image: 镜像名称
</span><span id="__span-211-13"><a id="__codelineno-211-13" name="__codelineno-211-13" href="#__codelineno-211-13"></a>    name: 容器名称
</span><span id="__span-211-14"><a id="__codelineno-211-14" name="__codelineno-211-14" href="#__codelineno-211-14"></a>…………    
</span></code></pre></div>
<p>启动后可以查看到</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Kuboard效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220104203155749" src="../../images/DevOps/image-20220104203155749.png" /></td>
</tr>
</tbody>
</table>
</li>
</ul>
<h6 id="1043-deployment"><a class="toclink" href="../../devops/#1043-deployment">10.4.3 Deployment</a></h6>
<p>部署时，可以通过Deployment管理和编排Pod</p>
<p>Deployment部署实现</p>
<ul>
<li>命令方式</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-212-1"><a id="__codelineno-212-1" name="__codelineno-212-1" href="#__codelineno-212-1"></a><span class="c1"># 基于Deployment启动容器</span>
</span><span id="__span-212-2"><a id="__codelineno-212-2" name="__codelineno-212-2" href="#__codelineno-212-2"></a>kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>deployment名称<span class="w"> </span>--image<span class="o">=</span>镜像名称
</span><span id="__span-212-3"><a id="__codelineno-212-3" name="__codelineno-212-3" href="#__codelineno-212-3"></a><span class="c1"># 用deployment启动的容器会在被删除后自动再次创建，达到故障漂移的效果</span>
</span><span id="__span-212-4"><a id="__codelineno-212-4" name="__codelineno-212-4" href="#__codelineno-212-4"></a><span class="c1"># 需要使用deploy的方式删除deploy</span>
</span><span id="__span-212-5"><a id="__codelineno-212-5" name="__codelineno-212-5" href="#__codelineno-212-5"></a><span class="c1"># 查看现在的deployment</span>
</span><span id="__span-212-6"><a id="__codelineno-212-6" name="__codelineno-212-6" href="#__codelineno-212-6"></a>kubectl<span class="w"> </span>get<span class="w"> </span>deployment
</span><span id="__span-212-7"><a id="__codelineno-212-7" name="__codelineno-212-7" href="#__codelineno-212-7"></a>
</span><span id="__span-212-8"><a id="__codelineno-212-8" name="__codelineno-212-8" href="#__codelineno-212-8"></a><span class="c1"># 删除deployment</span>
</span><span id="__span-212-9"><a id="__codelineno-212-9" name="__codelineno-212-9" href="#__codelineno-212-9"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>deployment<span class="w"> </span>deployment名称
</span><span id="__span-212-10"><a id="__codelineno-212-10" name="__codelineno-212-10" href="#__codelineno-212-10"></a>
</span><span id="__span-212-11"><a id="__codelineno-212-11" name="__codelineno-212-11" href="#__codelineno-212-11"></a><span class="c1"># 基于Deployment启动容器并设置Pod集群数</span>
</span><span id="__span-212-12"><a id="__codelineno-212-12" name="__codelineno-212-12" href="#__codelineno-212-12"></a>kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>deployment名称<span class="w"> </span>--image<span class="o">=</span>镜像名称<span class="w"> </span>--replicas<span class="w"> </span>集群个数
</span></code></pre></div>
<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">配置文件方式</a></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-213-1"><a id="__codelineno-213-1" name="__codelineno-213-1" href="#__codelineno-213-1"></a>apiVersion: apps/v1
</span><span id="__span-213-2"><a id="__codelineno-213-2" name="__codelineno-213-2" href="#__codelineno-213-2"></a>kind: Deployment
</span><span id="__span-213-3"><a id="__codelineno-213-3" name="__codelineno-213-3" href="#__codelineno-213-3"></a>metadata:
</span><span id="__span-213-4"><a id="__codelineno-213-4" name="__codelineno-213-4" href="#__codelineno-213-4"></a>  name: nginx-deployment
</span><span id="__span-213-5"><a id="__codelineno-213-5" name="__codelineno-213-5" href="#__codelineno-213-5"></a>  labels:
</span><span id="__span-213-6"><a id="__codelineno-213-6" name="__codelineno-213-6" href="#__codelineno-213-6"></a>    app: nginx
</span><span id="__span-213-7"><a id="__codelineno-213-7" name="__codelineno-213-7" href="#__codelineno-213-7"></a>spec:
</span><span id="__span-213-8"><a id="__codelineno-213-8" name="__codelineno-213-8" href="#__codelineno-213-8"></a>  replicas: 3
</span><span id="__span-213-9"><a id="__codelineno-213-9" name="__codelineno-213-9" href="#__codelineno-213-9"></a>  selector:
</span><span id="__span-213-10"><a id="__codelineno-213-10" name="__codelineno-213-10" href="#__codelineno-213-10"></a>    matchLabels:
</span><span id="__span-213-11"><a id="__codelineno-213-11" name="__codelineno-213-11" href="#__codelineno-213-11"></a>      app: nginx
</span><span id="__span-213-12"><a id="__codelineno-213-12" name="__codelineno-213-12" href="#__codelineno-213-12"></a>  template:
</span><span id="__span-213-13"><a id="__codelineno-213-13" name="__codelineno-213-13" href="#__codelineno-213-13"></a>    metadata:
</span><span id="__span-213-14"><a id="__codelineno-213-14" name="__codelineno-213-14" href="#__codelineno-213-14"></a>      labels:
</span><span id="__span-213-15"><a id="__codelineno-213-15" name="__codelineno-213-15" href="#__codelineno-213-15"></a>        app: nginx
</span><span id="__span-213-16"><a id="__codelineno-213-16" name="__codelineno-213-16" href="#__codelineno-213-16"></a>    spec:
</span><span id="__span-213-17"><a id="__codelineno-213-17" name="__codelineno-213-17" href="#__codelineno-213-17"></a>      containers:
</span><span id="__span-213-18"><a id="__codelineno-213-18" name="__codelineno-213-18" href="#__codelineno-213-18"></a>      - name: nginx
</span><span id="__span-213-19"><a id="__codelineno-213-19" name="__codelineno-213-19" href="#__codelineno-213-19"></a>       image: nginx
</span><span id="__span-213-20"><a id="__codelineno-213-20" name="__codelineno-213-20" href="#__codelineno-213-20"></a>       ports:
</span><span id="__span-213-21"><a id="__codelineno-213-21" name="__codelineno-213-21" href="#__codelineno-213-21"></a>       - containerPort: 80
</span></code></pre></div>
<p>正常使用kubectl运行yaml即可</p>
<p>弹性伸缩功能</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-214-1"><a id="__codelineno-214-1" name="__codelineno-214-1" href="#__codelineno-214-1"></a><span class="c1"># 基于scale实现弹性伸缩</span>
</span><span id="__span-214-2"><a id="__codelineno-214-2" name="__codelineno-214-2" href="#__codelineno-214-2"></a>kubectl<span class="w"> </span>scale<span class="w"> </span>deploy/Deployment名称<span class="w"> </span>--replicas<span class="w"> </span>集群个数
</span><span id="__span-214-3"><a id="__codelineno-214-3" name="__codelineno-214-3" href="#__codelineno-214-3"></a><span class="c1"># 或者修改yaml文件</span>
</span><span id="__span-214-4"><a id="__codelineno-214-4" name="__codelineno-214-4" href="#__codelineno-214-4"></a>kubectl<span class="w"> </span>edit<span class="w"> </span>deploy<span class="w"> </span>Deployment名称
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">图形化页面修改</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220104210823057" src="../../images/DevOps/image-20220104210823057.png" /></td>
</tr>
</tbody>
</table>
<p>灰度发布</p>
<p>Deploy可以在部署新版本数据时，成功启动一个pod，才会下线一个老版本的Pod</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-215-1"><a id="__codelineno-215-1" name="__codelineno-215-1" href="#__codelineno-215-1"></a>kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>image<span class="w"> </span>deployment/Deployment名称<span class="w"> </span><span class="nv">容器名</span><span class="o">=</span>镜像:版本
</span></code></pre></div>
<h6 id="1044-service"><a class="toclink" href="../../devops/#1044-service">10.4.4 Service</a></h6>
<p>可以将多个Pod对外暴露一个Service，让客户端可以通过Service访问到这一组Pod，并且可以实现负载均衡</p>
<p>ClusterIP方式：</p>
<p>ClusterIP是集群内部Pod之间的访问方式</p>
<ul>
<li>命令实现效果</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-216-1"><a id="__codelineno-216-1" name="__codelineno-216-1" href="#__codelineno-216-1"></a><span class="c1"># 通过生成service映射一个Deployment下的所有pod中的某一个端口的容器</span>
</span><span id="__span-216-2"><a id="__codelineno-216-2" name="__codelineno-216-2" href="#__codelineno-216-2"></a>kubectl<span class="w"> </span>expose<span class="w"> </span>deployment<span class="w"> </span>Deployment名称<span class="w"> </span>--port<span class="o">=</span>Service端口号<span class="w"> </span>--target-port<span class="o">=</span>Pod内容器端口
</span></code></pre></div>
<p>之后通过<code>kubectl get service</code>查看Service提供的ip，即可访问</p>
<table>
<thead>
<tr>
<th style="text-align: center;">kubectl get service</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220104214659229" src="../../images/DevOps/image-20220104214659229.png" /></td>
</tr>
</tbody>
</table>
<p>也可以通过<code>Deployment名称.namespace名称.svc</code>作为域名访问</p>
<table>
<thead>
<tr>
<th style="text-align: center;">在服务容器内执行</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220104215030265" src="../../images/DevOps/image-20220104215030265.png" /></td>
</tr>
</tbody>
</table>
<p>NodePort方式</p>
<p>ClusterIP的方式只能在Pod内部实现访问，但是一般需要对外暴露网关，所以需要NodePort的方式Pod外暴露访问</p>
<ul>
<li>命令实现方式</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-217-1"><a id="__codelineno-217-1" name="__codelineno-217-1" href="#__codelineno-217-1"></a><span class="c1"># 通过生成service映射一个Deployment下的所有pod中的某一个端口的容器</span>
</span><span id="__span-217-2"><a id="__codelineno-217-2" name="__codelineno-217-2" href="#__codelineno-217-2"></a>kubectl<span class="w"> </span>expose<span class="w"> </span>deployment<span class="w"> </span>Deployment名称<span class="w"> </span>--port<span class="o">=</span>Service端口号<span class="w"> </span>--target-port<span class="o">=</span>Pod内容器端口<span class="w"> </span>--type<span class="o">=</span>NodePort
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">查看Service效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220104222750733" src="../../images/DevOps/image-20220104222750733.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="image-20220104222819455" src="../../images/DevOps/image-20220104222819455.png" /></td>
</tr>
</tbody>
</table>
<p>Service也可以通过yaml文件实现</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-218-1"><a id="__codelineno-218-1" name="__codelineno-218-1" href="#__codelineno-218-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-218-2"><a id="__codelineno-218-2" name="__codelineno-218-2" href="#__codelineno-218-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-218-3"><a id="__codelineno-218-3" name="__codelineno-218-3" href="#__codelineno-218-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-218-4"><a id="__codelineno-218-4" name="__codelineno-218-4" href="#__codelineno-218-4"></a><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">labels</span>
</span><span id="__span-218-5"><a id="__codelineno-218-5" name="__codelineno-218-5" href="#__codelineno-218-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-218-6"><a id="__codelineno-218-6" name="__codelineno-218-6" href="#__codelineno-218-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-218-7"><a id="__codelineno-218-7" name="__codelineno-218-7" href="#__codelineno-218-7"></a><span class="w">  </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-218-8"><a id="__codelineno-218-8" name="__codelineno-218-8" href="#__codelineno-218-8"></a><span class="w">    </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-218-9"><a id="__codelineno-218-9" name="__codelineno-218-9" href="#__codelineno-218-9"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-218-10"><a id="__codelineno-218-10" name="__codelineno-218-10" href="#__codelineno-218-10"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-218-11"><a id="__codelineno-218-11" name="__codelineno-218-11" href="#__codelineno-218-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8888</span>
</span><span id="__span-218-12"><a id="__codelineno-218-12" name="__codelineno-218-12" href="#__codelineno-218-12"></a><span class="w">    </span><span class="w w-Error"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-218-13"><a id="__codelineno-218-13" name="__codelineno-218-13" href="#__codelineno-218-13"></a><span class="w">     </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span></code></pre></div>
<p>通过apply启动就也可以创建Service</p>
<p>测试效果-Deployment部署，通过Service暴露</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-219-1"><a id="__codelineno-219-1" name="__codelineno-219-1" href="#__codelineno-219-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-219-2"><a id="__codelineno-219-2" name="__codelineno-219-2" href="#__codelineno-219-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id="__span-219-3"><a id="__codelineno-219-3" name="__codelineno-219-3" href="#__codelineno-219-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-219-4"><a id="__codelineno-219-4" name="__codelineno-219-4" href="#__codelineno-219-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-deployment</span>
</span><span id="__span-219-5"><a id="__codelineno-219-5" name="__codelineno-219-5" href="#__codelineno-219-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-219-6"><a id="__codelineno-219-6" name="__codelineno-219-6" href="#__codelineno-219-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-deployment</span>
</span><span id="__span-219-7"><a id="__codelineno-219-7" name="__codelineno-219-7" href="#__codelineno-219-7"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-219-8"><a id="__codelineno-219-8" name="__codelineno-219-8" href="#__codelineno-219-8"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id="__span-219-9"><a id="__codelineno-219-9" name="__codelineno-219-9" href="#__codelineno-219-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-219-10"><a id="__codelineno-219-10" name="__codelineno-219-10" href="#__codelineno-219-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-219-11"><a id="__codelineno-219-11" name="__codelineno-219-11" href="#__codelineno-219-11"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-deployment</span>
</span><span id="__span-219-12"><a id="__codelineno-219-12" name="__codelineno-219-12" href="#__codelineno-219-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-219-13"><a id="__codelineno-219-13" name="__codelineno-219-13" href="#__codelineno-219-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-219-14"><a id="__codelineno-219-14" name="__codelineno-219-14" href="#__codelineno-219-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-219-15"><a id="__codelineno-219-15" name="__codelineno-219-15" href="#__codelineno-219-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-deployment</span>
</span><span id="__span-219-16"><a id="__codelineno-219-16" name="__codelineno-219-16" href="#__codelineno-219-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-219-17"><a id="__codelineno-219-17" name="__codelineno-219-17" href="#__codelineno-219-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-219-18"><a id="__codelineno-219-18" name="__codelineno-219-18" href="#__codelineno-219-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-deployment</span>
</span><span id="__span-219-19"><a id="__codelineno-219-19" name="__codelineno-219-19" href="#__codelineno-219-19"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id="__span-219-20"><a id="__codelineno-219-20" name="__codelineno-219-20" href="#__codelineno-219-20"></a><span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-219-21"><a id="__codelineno-219-21" name="__codelineno-219-21" href="#__codelineno-219-21"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-219-22"><a id="__codelineno-219-22" name="__codelineno-219-22" href="#__codelineno-219-22"></a><span class="nn">---</span>
</span><span id="__span-219-23"><a id="__codelineno-219-23" name="__codelineno-219-23" href="#__codelineno-219-23"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-219-24"><a id="__codelineno-219-24" name="__codelineno-219-24" href="#__codelineno-219-24"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id="__span-219-25"><a id="__codelineno-219-25" name="__codelineno-219-25" href="#__codelineno-219-25"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-219-26"><a id="__codelineno-219-26" name="__codelineno-219-26" href="#__codelineno-219-26"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-219-27"><a id="__codelineno-219-27" name="__codelineno-219-27" href="#__codelineno-219-27"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-service</span>
</span><span id="__span-219-28"><a id="__codelineno-219-28" name="__codelineno-219-28" href="#__codelineno-219-28"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-service</span>
</span><span id="__span-219-29"><a id="__codelineno-219-29" name="__codelineno-219-29" href="#__codelineno-219-29"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-219-30"><a id="__codelineno-219-30" name="__codelineno-219-30" href="#__codelineno-219-30"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-219-31"><a id="__codelineno-219-31" name="__codelineno-219-31" href="#__codelineno-219-31"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-deployment</span>
</span><span id="__span-219-32"><a id="__codelineno-219-32" name="__codelineno-219-32" href="#__codelineno-219-32"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-219-33"><a id="__codelineno-219-33" name="__codelineno-219-33" href="#__codelineno-219-33"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8888</span>
</span><span id="__span-219-34"><a id="__codelineno-219-34" name="__codelineno-219-34" href="#__codelineno-219-34"></a><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id="__span-219-35"><a id="__codelineno-219-35" name="__codelineno-219-35" href="#__codelineno-219-35"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id="__span-219-36"><a id="__codelineno-219-36" name="__codelineno-219-36" href="#__codelineno-219-36"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span></code></pre></div>
<p>可以查看到暴露的信息</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Service信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220105205334996" src="../../images/DevOps/image-20220105205334996.png" /></td>
</tr>
</tbody>
</table>
<h6 id="1045-ingress"><a class="toclink" href="../../devops/#1045-ingress">10.4.5 Ingress</a></h6>
<p>Kubernetes推荐将Ingress作为所有Service的入口，提供统一的入口，避免多个服务之间需要记录大量的IP或者域名，毕竟IP可能改变，服务太多域名记录不方便。</p>
<p>Ingress底层其实就是一个Nginx， 可以在Kuboard上直接点击安装</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Kuboard安装</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220105153343642" src="../../images/DevOps/image-20220105153343642.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><strong><img alt="image-20220105153416367" src="../../images/DevOps/image-20220105153416367.png" /></strong></td>
</tr>
</tbody>
</table>
<p>因为副本数默认为1，但是k8s整体集群就2个节点，所以显示下面即为安装成功</p>
<table>
<thead>
<tr>
<th style="text-align: center;">安装成功</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220105153502619" src="../../images/DevOps/image-20220105153502619.png" /></td>
</tr>
</tbody>
</table>
<p>可以将Ingress接收到的请求转发到不同的Service中。</p>
<p>推荐使用yaml文件方式</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-220-1"><a id="__codelineno-220-1" name="__codelineno-220-1" href="#__codelineno-220-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id="__span-220-2"><a id="__codelineno-220-2" name="__codelineno-220-2" href="#__codelineno-220-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id="__span-220-3"><a id="__codelineno-220-3" name="__codelineno-220-3" href="#__codelineno-220-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-220-4"><a id="__codelineno-220-4" name="__codelineno-220-4" href="#__codelineno-220-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span>
</span><span id="__span-220-5"><a id="__codelineno-220-5" name="__codelineno-220-5" href="#__codelineno-220-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-220-6"><a id="__codelineno-220-6" name="__codelineno-220-6" href="#__codelineno-220-6"></a><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress</span>
</span><span id="__span-220-7"><a id="__codelineno-220-7" name="__codelineno-220-7" href="#__codelineno-220-7"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-220-8"><a id="__codelineno-220-8" name="__codelineno-220-8" href="#__codelineno-220-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx.mashibing.com</span>
</span><span id="__span-220-9"><a id="__codelineno-220-9" name="__codelineno-220-9" href="#__codelineno-220-9"></a><span class="w">    </span><span class="nt">http</span><span class="p">:</span>
</span><span id="__span-220-10"><a id="__codelineno-220-10" name="__codelineno-220-10" href="#__codelineno-220-10"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
</span><span id="__span-220-11"><a id="__codelineno-220-11" name="__codelineno-220-11" href="#__codelineno-220-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</span><span id="__span-220-12"><a id="__codelineno-220-12" name="__codelineno-220-12" href="#__codelineno-220-12"></a><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
</span><span id="__span-220-13"><a id="__codelineno-220-13" name="__codelineno-220-13" href="#__codelineno-220-13"></a><span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
</span><span id="__span-220-14"><a id="__codelineno-220-14" name="__codelineno-220-14" href="#__codelineno-220-14"></a><span class="w">          </span><span class="nt">service</span><span class="p">:</span>
</span><span id="__span-220-15"><a id="__codelineno-220-15" name="__codelineno-220-15" href="#__codelineno-220-15"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-service</span>
</span><span id="__span-220-16"><a id="__codelineno-220-16" name="__codelineno-220-16" href="#__codelineno-220-16"></a><span class="w">            </span><span class="nt">port</span><span class="p">:</span>
</span><span id="__span-220-17"><a id="__codelineno-220-17" name="__codelineno-220-17" href="#__codelineno-220-17"></a><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8888</span>
</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;">启动时问题</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220105203819715" src="../../images/DevOps/image-20220105203819715.png" /></td>
</tr>
</tbody>
</table>
<p>Kuboard安装的Ingress有admission的校验配置，需要先删除配置再启动</p>
<p>找到指定的ingress的校验信息，删除即可</p>
<table>
<thead>
<tr>
<th style="text-align: center;">删除信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220105204434044" src="../../images/DevOps/image-20220105204434044.png" /></td>
</tr>
</tbody>
</table>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-221-1"><a id="__codelineno-221-1" name="__codelineno-221-1" href="#__codelineno-221-1"></a><span class="c1"># 查看校验webhook的配置</span>
</span><span id="__span-221-2"><a id="__codelineno-221-2" name="__codelineno-221-2" href="#__codelineno-221-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>-A<span class="w"> </span>ValidatingWebhookConfiguration
</span><span id="__span-221-3"><a id="__codelineno-221-3" name="__codelineno-221-3" href="#__codelineno-221-3"></a>
</span><span id="__span-221-4"><a id="__codelineno-221-4" name="__codelineno-221-4" href="#__codelineno-221-4"></a><span class="c1"># 删除指定的校验</span>
</span><span id="__span-221-5"><a id="__codelineno-221-5" name="__codelineno-221-5" href="#__codelineno-221-5"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>ValidatingWebhookConfiguration<span class="w"> </span>ingress-nginx-admission-my-ingress-controller
</span></code></pre></div>
<p>配置本地hosts文件</p>
<table>
<thead>
<tr>
<th style="text-align: center;">配置hosts</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220105204921272" src="../../images/DevOps/image-20220105204921272.png" /></td>
</tr>
</tbody>
</table>
<p>记下来既可以访问在Service中暴露的Nginx信息</p>
<table>
<thead>
<tr>
<th style="text-align: center;">服通过Ingress访问</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="image-20220105205407393" src="../../images/DevOps/image-20220105205407393.png" /></td>
</tr>
</tbody>
</table>
<h5 id="105-jenkinskubernetes"><a class="toclink" href="../../devops/#105-jenkinskubernetes">10.5 Jenkins集成Kubernetes</a></h5>
<h6 id="1051-yml"><a class="toclink" href="../../devops/#1051-yml">10.5.1 准备部署的yml文件</a></h6>
<div class="language-text highlight"><pre><span></span><code><span id="__span-222-1"><a id="__codelineno-222-1" name="__codelineno-222-1" href="#__codelineno-222-1"></a>apiVersion: apps/v1
</span><span id="__span-222-2"><a id="__codelineno-222-2" name="__codelineno-222-2" href="#__codelineno-222-2"></a>kind: Deployment
</span><span id="__span-222-3"><a id="__codelineno-222-3" name="__codelineno-222-3" href="#__codelineno-222-3"></a>metadata:
</span><span id="__span-222-4"><a id="__codelineno-222-4" name="__codelineno-222-4" href="#__codelineno-222-4"></a>  namespace: test
</span><span id="__span-222-5"><a id="__codelineno-222-5" name="__codelineno-222-5" href="#__codelineno-222-5"></a>  name: pipeline
</span><span id="__span-222-6"><a id="__codelineno-222-6" name="__codelineno-222-6" href="#__codelineno-222-6"></a>  labels:
</span><span id="__span-222-7"><a id="__codelineno-222-7" name="__codelineno-222-7" href="#__codelineno-222-7"></a>    app: pipeline
</span><span id="__span-222-8"><a id="__codelineno-222-8" name="__codelineno-222-8" href="#__codelineno-222-8"></a>spec:
</span><span id="__span-222-9"><a id="__codelineno-222-9" name="__codelineno-222-9" href="#__codelineno-222-9"></a>  replicas: 2
</span><span id="__span-222-10"><a id="__codelineno-222-10" name="__codelineno-222-10" href="#__codelineno-222-10"></a>  selector:
</span><span id="__span-222-11"><a id="__codelineno-222-11" name="__codelineno-222-11" href="#__codelineno-222-11"></a>    matchLabels:
</span><span id="__span-222-12"><a id="__codelineno-222-12" name="__codelineno-222-12" href="#__codelineno-222-12"></a>      app: pipeline
</span><span id="__span-222-13"><a id="__codelineno-222-13" name="__codelineno-222-13" href="#__codelineno-222-13"></a>  template:
</span><span id="__span-222-14"><a id="__codelineno-222-14" name="__codelineno-222-14" href="#__codelineno-222-14"></a>    metadata:
</span><span id="__span-222-15"><a id="__codelineno-222-15" name="__codelineno-222-15" href="#__codelineno-222-15"></a>      labels:
</span><span id="__span-222-16"><a id="__codelineno-222-16" name="__codelineno-222-16" href="#__codelineno-222-16"></a>        app: pipeline    
</span><span id="__span-222-17"><a id="__codelineno-222-17" name="__codelineno-222-17" href="#__codelineno-222-17"></a>    spec:
</span><span id="__span-222-18"><a id="__codelineno-222-18" name="__codelineno-222-18" href="#__codelineno-222-18"></a>      containers:
</span><span id="__span-222-19"><a id="__codelineno-222-19" name="__codelineno-222-19" href="#__codelineno-222-19"></a>      - name: pipeline
</span><span id="__span-222-20"><a id="__codelineno-222-20" name="__codelineno-222-20" href="#__codelineno-222-20"></a>        image: 192.168.11.102:80/repo/pipeline:v4.0.0
</span><span id="__span-222-21"><a id="__codelineno-222-21" name="__codelineno-222-21" href="#__codelineno-222-21"></a>        imagePullPolicy: Always
</span><span id="__span-222-22"><a id="__codelineno-222-22" name="__codelineno-222-22" href="#__codelineno-222-22"></a>        ports:
</span><span id="__span-222-23"><a id="__codelineno-222-23" name="__codelineno-222-23" href="#__codelineno-222-23"></a>        - containerPort: 8080
</span><span id="__span-222-24"><a id="__codelineno-222-24" name="__codelineno-222-24" href="#__codelineno-222-24"></a>---
</span><span id="__span-222-25"><a id="__codelineno-222-25" name="__codelineno-222-25" href="#__codelineno-222-25"></a>apiVersion: v1
</span><span id="__span-222-26"><a id="__codelineno-222-26" name="__codelineno-222-26" href="#__codelineno-222-26"></a>kind: Service
</span><span id="__span-222-27"><a id="__codelineno-222-27" name="__codelineno-222-27" href="#__codelineno-222-27"></a>metadata:
</span><span id="__span-222-28"><a id="__codelineno-222-28" name="__codelineno-222-28" href="#__codelineno-222-28"></a>  namespace: test
</span><span id="__span-222-29"><a id="__codelineno-222-29" name="__codelineno-222-29" href="#__codelineno-222-29"></a>  labels:
</span><span id="__span-222-30"><a id="__codelineno-222-30" name="__codelineno-222-30" href="#__codelineno-222-30"></a>    app: pipeline
</span><span id="__span-222-31"><a id="__codelineno-222-31" name="__codelineno-222-31" href="#__codelineno-222-31"></a>  name: pipeline  
</span><span id="__span-222-32"><a id="__codelineno-222-32" name="__codelineno-222-32" href="#__codelineno-222-32"></a>spec:
</span><span id="__span-222-33"><a id="__codelineno-222-33" name="__codelineno-222-33" href="#__codelineno-222-33"></a>  selector:
</span><span id="__span-222-34"><a id="__codelineno-222-34" name="__codelineno-222-34" href="#__codelineno-222-34"></a>    app: pipeline
</span><span id="__span-222-35"><a id="__codelineno-222-35" name="__codelineno-222-35" href="#__codelineno-222-35"></a>  ports:
</span><span id="__span-222-36"><a id="__codelineno-222-36" name="__codelineno-222-36" href="#__codelineno-222-36"></a>  - port: 8081
</span><span id="__span-222-37"><a id="__codelineno-222-37" name="__codelineno-222-37" href="#__codelineno-222-37"></a>    targetPort: 8080
</span><span id="__span-222-38"><a id="__codelineno-222-38" name="__codelineno-222-38" href="#__codelineno-222-38"></a>  type: NodePort
</span><span id="__span-222-39"><a id="__codelineno-222-39" name="__codelineno-222-39" href="#__codelineno-222-39"></a>---
</span><span id="__span-222-40"><a id="__codelineno-222-40" name="__codelineno-222-40" href="#__codelineno-222-40"></a>apiVersion: networking.k8s.io/v1
</span><span id="__span-222-41"><a id="__codelineno-222-41" name="__codelineno-222-41" href="#__codelineno-222-41"></a>kind: Ingress
</span><span id="__span-222-42"><a id="__codelineno-222-42" name="__codelineno-222-42" href="#__codelineno-222-42"></a>metadata:
</span><span id="__span-222-43"><a id="__codelineno-222-43" name="__codelineno-222-43" href="#__codelineno-222-43"></a>  namespace: test
</span><span id="__span-222-44"><a id="__codelineno-222-44" name="__codelineno-222-44" href="#__codelineno-222-44"></a>  name: pipeline
</span><span id="__span-222-45"><a id="__codelineno-222-45" name="__codelineno-222-45" href="#__codelineno-222-45"></a>spec:
</span><span id="__span-222-46"><a id="__codelineno-222-46" name="__codelineno-222-46" href="#__codelineno-222-46"></a>  ingressClassName: ingress
</span><span id="__span-222-47"><a id="__codelineno-222-47" name="__codelineno-222-47" href="#__codelineno-222-47"></a>  rules:
</span><span id="__span-222-48"><a id="__codelineno-222-48" name="__codelineno-222-48" href="#__codelineno-222-48"></a>  - host: mashibing.pipeline.com
</span><span id="__span-222-49"><a id="__codelineno-222-49" name="__codelineno-222-49" href="#__codelineno-222-49"></a>    http:
</span><span id="__span-222-50"><a id="__codelineno-222-50" name="__codelineno-222-50" href="#__codelineno-222-50"></a>      paths:
</span><span id="__span-222-51"><a id="__codelineno-222-51" name="__codelineno-222-51" href="#__codelineno-222-51"></a>      - path: /
</span><span id="__span-222-52"><a id="__codelineno-222-52" name="__codelineno-222-52" href="#__codelineno-222-52"></a>        pathType: Prefix
</span><span id="__span-222-53"><a id="__codelineno-222-53" name="__codelineno-222-53" href="#__codelineno-222-53"></a>        backend:
</span><span id="__span-222-54"><a id="__codelineno-222-54" name="__codelineno-222-54" href="#__codelineno-222-54"></a>          service:
</span><span id="__span-222-55"><a id="__codelineno-222-55" name="__codelineno-222-55" href="#__codelineno-222-55"></a>            name: pipeline
</span><span id="__span-222-56"><a id="__codelineno-222-56" name="__codelineno-222-56" href="#__codelineno-222-56"></a>            port:
</span><span id="__span-222-57"><a id="__codelineno-222-57" name="__codelineno-222-57" href="#__codelineno-222-57"></a>              number: 8081
</span></code></pre></div>
<h6 id="1052-harbor"><a class="toclink" href="../../devops/#1052-harbor">10.5.2 Harbor私服配置</a></h6>
<p>在尝试用kubernetes的yml文件启动pipeline服务时，会出现Kubernetes无法拉取镜像的问题，这里需要在kubernetes所在的Linux中配置Harbor服务信息，并且保证Kubernetes可以拉取Harbor上的镜像</p>
<ul>
<li>设置Master和Worker的私服地址信息</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">设置Harbor私服地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642498962716" src="../../images/DevOps/1642498962716.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>在Kuboard上设置私服密文信息</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">设置密文并测试</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642498994935" src="../../images/DevOps/1642498994935.png" /></td>
</tr>
</tbody>
</table>
<p>按照复制指令的位置测试认证，效果如下</p>
<table>
<thead>
<tr>
<th style="text-align: center;">测试效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642499172789" src="../../images/DevOps/1642499172789.png" /></td>
</tr>
</tbody>
</table>
<h6 id="1053"><a class="toclink" href="../../devops/#1053">10.5.3 测试使用效果</a></h6>
<p>执行kubectl命令，基于yml启动服务，并且基于部署后服务的提示信息以及Ingress的设置，直接访问</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="1642499368121" src="../../images/DevOps/1642499368121.png" /></td>
</tr>
<tr>
<td><img alt="1642499788199" src="../../images/DevOps/1642499788199.png" /></td>
</tr>
</tbody>
</table>
<h6 id="1053-jenkins"><a class="toclink" href="../../devops/#1053-jenkins">10.5.3 Jenkins远程调用</a></h6>
<ul>
<li>将pipeline.yml配置到Gitlab中</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">配置yml文件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642499885324" src="../../images/DevOps/1642499885324.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>配置Jenkins的目标服务器，可以将yml文件传输到K8s的Master上</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">设置目标服务器</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642499992148" src="../../images/DevOps/1642499992148.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>修改Jenkinsfile，重新设置流水线任务脚本，并测试效果</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">传递yml文件脚本</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642500061153" src="../../images/DevOps/1642500061153.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="1642500102996" src="../../images/DevOps/1642500102996.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>设置Jenkins无密码登录k8s-master</li>
</ul>
<p>将Jenkins中公钥信息复制到k8s-master的~/.ssh/authorized_keysz中，保证远程连接无密码</p>
<table>
<thead>
<tr>
<th style="text-align: center;">远程执行命令无需密码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642500239406" src="../../images/DevOps/1642500239406.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>设置执行kubectl的脚本到Jenkinsfile</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">设置Jenkinsfile</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642500378788" src="../../images/DevOps/1642500378788.png" /></td>
</tr>
</tbody>
</table>
<ul>
<li>执行查看效果</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">执行流水线</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642500413802" src="../../images/DevOps/1642500413802.png" /></td>
</tr>
</tbody>
</table>
<p>可以查看到yml文件是由变化的， 这样k8s就会重新加载</p>
<ul>
<li>查看效果</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;">效果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642500474036" src="../../images/DevOps/1642500474036.png" /></td>
</tr>
</tbody>
</table>
<p><a href="">Ps：这种方式更适应与CD操作，将项目将基于某个版本部署到指定的目标服务器</a></p>
<h5 id="106-gitlabwebhooks"><a class="toclink" href="../../devops/#106-gitlabwebhooks">10.6 基于GitLab的WebHooks</a></h5>
<p>这里要实现自动化的一个CI操作，也就是开发人员Push代码到Git仓库后，Jenkins会自动的构建项目，将最新的提交点代码构建并进行打包部署，这里区别去上述的CD操作，CD操作需要基于某个版本进行部署，而这里每次都是将最新的提交点集成到主干上并测试。</p>
<h6 id="1061-webhooks"><a class="toclink" href="../../devops/#1061-webhooks">10.6.1 WebHooks通知</a></h6>
<p>开启Jenkins的自动构建</p>
<table>
<thead>
<tr>
<th style="text-align: center;">构建触发器</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642500817131" src="../../images/DevOps/1642500817131.png" /></td>
</tr>
</tbody>
</table>
<p>设置Gitlab的Webhooks</p>
<table>
<thead>
<tr>
<th style="text-align: center;">设置Gitlab的Webhooks</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642500933316" src="../../images/DevOps/1642500933316.png" /></td>
</tr>
</tbody>
</table>
<p>需要关闭Jenkins的Gitlab认证</p>
<table>
<thead>
<tr>
<th style="text-align: center;">关闭Jenkins的Gitlab认证</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642501016474" src="../../images/DevOps/1642501016474.png" /></td>
</tr>
</tbody>
</table>
<p>再次测试Gitlab</p>
<table>
<thead>
<tr>
<th style="text-align: center;">再次测试</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642501065243" src="../../images/DevOps/1642501065243.png" /></td>
</tr>
</tbody>
</table>
<h6 id="1062"><a class="toclink" href="../../devops/#1062">10.6.2 修改配置</a></h6>
<p>修改Jenkinsfile实现基于最新提交点实现持续集成效果，将之前引用${tag}的全部去掉</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-223-1"><a id="__codelineno-223-1" name="__codelineno-223-1" href="#__codelineno-223-1"></a><span class="c1">// 所有的脚本命令都放在pipeline中</span>
</span><span id="__span-223-2"><a id="__codelineno-223-2" name="__codelineno-223-2" href="#__codelineno-223-2"></a><span class="err">pipeli</span><span class="kc">ne</span><span class="p">{</span>
</span><span id="__span-223-3"><a id="__codelineno-223-3" name="__codelineno-223-3" href="#__codelineno-223-3"></a><span class="w">    </span><span class="c1">// 指定任务再哪个集群节点中执行</span>
</span><span id="__span-223-4"><a id="__codelineno-223-4" name="__codelineno-223-4" href="#__codelineno-223-4"></a><span class="w">    </span><span class="err">age</span><span class="kc">nt</span><span class="w"> </span><span class="err">a</span><span class="kc">n</span><span class="err">y</span>
</span><span id="__span-223-5"><a id="__codelineno-223-5" name="__codelineno-223-5" href="#__codelineno-223-5"></a>
</span><span id="__span-223-6"><a id="__codelineno-223-6" name="__codelineno-223-6" href="#__codelineno-223-6"></a><span class="w">    </span><span class="c1">// 声明全局变量，方便后面使用</span>
</span><span id="__span-223-7"><a id="__codelineno-223-7" name="__codelineno-223-7" href="#__codelineno-223-7"></a><span class="w">    </span><span class="err">e</span><span class="kc">n</span><span class="err">viro</span><span class="kc">n</span><span class="err">me</span><span class="kc">nt</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-8"><a id="__codelineno-223-8" name="__codelineno-223-8" href="#__codelineno-223-8"></a><span class="w">        </span><span class="err">harborUser</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">&#39;admi</span><span class="kc">n</span><span class="err">&#39;</span>
</span><span id="__span-223-9"><a id="__codelineno-223-9" name="__codelineno-223-9" href="#__codelineno-223-9"></a><span class="w">        </span><span class="err">harborPasswd</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">&#39;Harbor</span><span class="mi">12345</span><span class="err">&#39;</span>
</span><span id="__span-223-10"><a id="__codelineno-223-10" name="__codelineno-223-10" href="#__codelineno-223-10"></a><span class="w">        </span><span class="err">harborAddress</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">&#39;</span><span class="mf">192.168.11.102</span><span class="p">:</span><span class="mi">80</span><span class="err">&#39;</span>
</span><span id="__span-223-11"><a id="__codelineno-223-11" name="__codelineno-223-11" href="#__codelineno-223-11"></a><span class="w">        </span><span class="err">harborRepo</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">&#39;repo&#39;</span>
</span><span id="__span-223-12"><a id="__codelineno-223-12" name="__codelineno-223-12" href="#__codelineno-223-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-223-13"><a id="__codelineno-223-13" name="__codelineno-223-13" href="#__codelineno-223-13"></a>
</span><span id="__span-223-14"><a id="__codelineno-223-14" name="__codelineno-223-14" href="#__codelineno-223-14"></a><span class="w">    </span><span class="err">s</span><span class="kc">ta</span><span class="err">ges</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-15"><a id="__codelineno-223-15" name="__codelineno-223-15" href="#__codelineno-223-15"></a><span class="w">        </span><span class="err">s</span><span class="kc">ta</span><span class="err">ge(&#39;拉取gi</span><span class="kc">t</span><span class="err">仓库代码&#39;)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-16"><a id="__codelineno-223-16" name="__codelineno-223-16" href="#__codelineno-223-16"></a><span class="w">            </span><span class="err">s</span><span class="kc">te</span><span class="err">ps</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-17"><a id="__codelineno-223-17" name="__codelineno-223-17" href="#__codelineno-223-17"></a><span class="w">                </span><span class="err">checkou</span><span class="kc">t</span><span class="err">(</span><span class="p">[</span><span class="err">$class</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;Gi</span><span class="kc">t</span><span class="err">SCM&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">bra</span><span class="kc">n</span><span class="err">ches</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;*/mas</span><span class="kc">ter</span><span class="err">&#39;</span><span class="p">]],</span><span class="w"> </span><span class="err">ex</span><span class="kc">tens</span><span class="err">io</span><span class="kc">ns</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="err">userRemo</span><span class="kc">te</span><span class="err">Co</span><span class="kc">nf</span><span class="err">igs</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="err">url</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;h</span><span class="kc">tt</span><span class="err">p</span><span class="p">:</span><span class="c1">//192.168.11.101:8929/root/mytest.git&#39;]]])</span>
</span><span id="__span-223-18"><a id="__codelineno-223-18" name="__codelineno-223-18" href="#__codelineno-223-18"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-223-19"><a id="__codelineno-223-19" name="__codelineno-223-19" href="#__codelineno-223-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-223-20"><a id="__codelineno-223-20" name="__codelineno-223-20" href="#__codelineno-223-20"></a><span class="w">        </span><span class="err">s</span><span class="kc">ta</span><span class="err">ge(&#39;通过mave</span><span class="kc">n</span><span class="err">构建项目&#39;)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-21"><a id="__codelineno-223-21" name="__codelineno-223-21" href="#__codelineno-223-21"></a><span class="w">            </span><span class="err">s</span><span class="kc">te</span><span class="err">ps</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-22"><a id="__codelineno-223-22" name="__codelineno-223-22" href="#__codelineno-223-22"></a><span class="w">                </span><span class="err">sh</span><span class="w"> </span><span class="err">&#39;/var/je</span><span class="kc">n</span><span class="err">ki</span><span class="kc">ns</span><span class="err">_home/mave</span><span class="kc">n</span><span class="err">/bi</span><span class="kc">n</span><span class="err">/mv</span><span class="kc">n</span><span class="w"> </span><span class="err">clea</span><span class="kc">n</span><span class="w"> </span><span class="err">package</span><span class="w"> </span><span class="mi">-</span><span class="err">DskipTes</span><span class="kc">ts</span><span class="err">&#39;</span>
</span><span id="__span-223-23"><a id="__codelineno-223-23" name="__codelineno-223-23" href="#__codelineno-223-23"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-223-24"><a id="__codelineno-223-24" name="__codelineno-223-24" href="#__codelineno-223-24"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-223-25"><a id="__codelineno-223-25" name="__codelineno-223-25" href="#__codelineno-223-25"></a><span class="w">        </span><span class="err">s</span><span class="kc">ta</span><span class="err">ge(&#39;通过So</span><span class="kc">nar</span><span class="err">Qube做代码质量检测&#39;)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-26"><a id="__codelineno-223-26" name="__codelineno-223-26" href="#__codelineno-223-26"></a><span class="w">            </span><span class="err">s</span><span class="kc">te</span><span class="err">ps</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-27"><a id="__codelineno-223-27" name="__codelineno-223-27" href="#__codelineno-223-27"></a><span class="w">                </span><span class="err">sh</span><span class="w"> </span><span class="err">&#39;/var/je</span><span class="kc">n</span><span class="err">ki</span><span class="kc">ns</span><span class="err">_home/so</span><span class="kc">nar</span><span class="mi">-</span><span class="err">sca</span><span class="kc">nner</span><span class="err">/bi</span><span class="kc">n</span><span class="err">/so</span><span class="kc">nar</span><span class="mi">-</span><span class="err">sca</span><span class="kc">nner</span><span class="w"> </span><span class="mi">-</span><span class="err">Dso</span><span class="kc">nar</span><span class="err">.source=./</span><span class="w"> </span><span class="mi">-</span><span class="err">Dso</span><span class="kc">nar</span><span class="err">.projec</span><span class="kc">tna</span><span class="err">me=$</span><span class="p">{</span><span class="err">JOB_NAME</span><span class="p">}</span><span class="w"> </span><span class="mi">-</span><span class="err">Dso</span><span class="kc">nar</span><span class="err">.projec</span><span class="kc">t</span><span class="err">Key=$</span><span class="p">{</span><span class="err">JOB_NAME</span><span class="p">}</span><span class="w"> </span><span class="mi">-</span><span class="err">Dso</span><span class="kc">nar</span><span class="err">.java.bi</span><span class="kc">nar</span><span class="err">ies=./</span><span class="kc">tar</span><span class="err">ge</span><span class="kc">t</span><span class="err">/</span><span class="w"> </span><span class="mi">-</span><span class="err">Dso</span><span class="kc">nar</span><span class="err">.logi</span><span class="kc">n</span><span class="err">=</span><span class="mi">40306</span><span class="err">ae</span><span class="mf">8e</span><span class="err">a</span><span class="mi">69</span><span class="err">a</span><span class="mi">4792</span><span class="err">d</span><span class="kc">f</span><span class="mi">2</span><span class="err">ceb</span><span class="mi">4</span><span class="err">d</span><span class="mi">9</span><span class="err">d</span><span class="mi">25</span><span class="kc">fe</span><span class="mi">8</span><span class="err">a</span><span class="mi">6</span><span class="err">ab</span><span class="mi">1701</span><span class="err">&#39;</span>
</span><span id="__span-223-28"><a id="__codelineno-223-28" name="__codelineno-223-28" href="#__codelineno-223-28"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-223-29"><a id="__codelineno-223-29" name="__codelineno-223-29" href="#__codelineno-223-29"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-223-30"><a id="__codelineno-223-30" name="__codelineno-223-30" href="#__codelineno-223-30"></a><span class="w">        </span><span class="err">s</span><span class="kc">ta</span><span class="err">ge(&#39;通过Docker制作自定义镜像&#39;)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-31"><a id="__codelineno-223-31" name="__codelineno-223-31" href="#__codelineno-223-31"></a><span class="w">            </span><span class="err">s</span><span class="kc">te</span><span class="err">ps</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-223-32"><a id="__codelineno-223-32" name="__codelineno-223-32" href="#__codelineno-223-32"></a><span class="w">                </span><span class="err">sh</span><span class="w"> </span><span class="err">&#39;&#39;&#39;mv</span><span class="w"> </span><span class="err">./</span><span class="kc">tar</span><span class="err">ge</span><span class="kc">t</span><span class="err">/*.jar ./docker/</span>
</span><span id="__span-223-33"><a id="__codelineno-223-33" name="__codelineno-223-33" href="#__codelineno-223-33"></a><span class="err">                docker build -t ${JOB_NAME}:latest ./docker/&#39;&#39;&#39;</span>
</span><span id="__span-223-34"><a id="__codelineno-223-34" name="__codelineno-223-34" href="#__codelineno-223-34"></a><span class="err">            }</span>
</span><span id="__span-223-35"><a id="__codelineno-223-35" name="__codelineno-223-35" href="#__codelineno-223-35"></a><span class="err">        }</span>
</span><span id="__span-223-36"><a id="__codelineno-223-36" name="__codelineno-223-36" href="#__codelineno-223-36"></a><span class="err">        stage(&#39;将自定义镜像推送到Harbor&#39;) {</span>
</span><span id="__span-223-37"><a id="__codelineno-223-37" name="__codelineno-223-37" href="#__codelineno-223-37"></a><span class="err">            steps {</span>
</span><span id="__span-223-38"><a id="__codelineno-223-38" name="__codelineno-223-38" href="#__codelineno-223-38"></a><span class="err">                sh &#39;&#39;&#39;docker login -u ${harborUser} -p ${harborPasswd} ${harborAddress}</span>
</span><span id="__span-223-39"><a id="__codelineno-223-39" name="__codelineno-223-39" href="#__codelineno-223-39"></a><span class="err">                docker tag ${JOB_NAME}:latest  ${harborAddress}/${harborRepo}/${JOB_NAME}:latest</span>
</span><span id="__span-223-40"><a id="__codelineno-223-40" name="__codelineno-223-40" href="#__codelineno-223-40"></a><span class="err">                docker push ${harborAddress}/${harborRepo}/${JOB_NAME}:latest &#39;&#39;&#39;</span>
</span><span id="__span-223-41"><a id="__codelineno-223-41" name="__codelineno-223-41" href="#__codelineno-223-41"></a><span class="err">            }</span>
</span><span id="__span-223-42"><a id="__codelineno-223-42" name="__codelineno-223-42" href="#__codelineno-223-42"></a><span class="err">        }</span>
</span><span id="__span-223-43"><a id="__codelineno-223-43" name="__codelineno-223-43" href="#__codelineno-223-43"></a><span class="err">        stage(&#39;将yml文件传到k8s-master上&#39;) {</span>
</span><span id="__span-223-44"><a id="__codelineno-223-44" name="__codelineno-223-44" href="#__codelineno-223-44"></a><span class="err">            steps {</span>
</span><span id="__span-223-45"><a id="__codelineno-223-45" name="__codelineno-223-45" href="#__codelineno-223-45"></a><span class="err">                sshPublisher(publishers: [sshPublisherDesc(configName: &#39;k8s&#39;, transfers: [sshTransfer(cleanRemote: false, excludes: &#39;&#39;, execCommand: &#39;&#39;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#39;[, ]+&#39;, remoteDirectory: &#39;&#39;, remoteDirectorySDF: false, removePrefix: &#39;&#39;, sourceFiles: &#39;pipeline.yml&#39;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])</span>
</span><span id="__span-223-46"><a id="__codelineno-223-46" name="__codelineno-223-46" href="#__codelineno-223-46"></a><span class="err">            }</span>
</span><span id="__span-223-47"><a id="__codelineno-223-47" name="__codelineno-223-47" href="#__codelineno-223-47"></a><span class="err">        }</span>
</span><span id="__span-223-48"><a id="__codelineno-223-48" name="__codelineno-223-48" href="#__codelineno-223-48"></a><span class="err">        stage(&#39;远程执行k8s-master的kubectl命令&#39;) {</span>
</span><span id="__span-223-49"><a id="__codelineno-223-49" name="__codelineno-223-49" href="#__codelineno-223-49"></a><span class="err">            steps {</span>
</span><span id="__span-223-50"><a id="__codelineno-223-50" name="__codelineno-223-50" href="#__codelineno-223-50"></a><span class="err">               sh &#39;&#39;&#39;ssh root@192.168.11.201 kubectl apply -f /usr/local/k8s/pipeline.yml</span>
</span><span id="__span-223-51"><a id="__codelineno-223-51" name="__codelineno-223-51" href="#__codelineno-223-51"></a><span class="err">                ssh root@192.168.11.201 kubectl rollout restart deployment pipeline -n test&#39;&#39;&#39;</span>
</span><span id="__span-223-52"><a id="__codelineno-223-52" name="__codelineno-223-52" href="#__codelineno-223-52"></a><span class="err">            }</span>
</span><span id="__span-223-53"><a id="__codelineno-223-53" name="__codelineno-223-53" href="#__codelineno-223-53"></a><span class="err">        }</span>
</span><span id="__span-223-54"><a id="__codelineno-223-54" name="__codelineno-223-54" href="#__codelineno-223-54"></a>
</span><span id="__span-223-55"><a id="__codelineno-223-55" name="__codelineno-223-55" href="#__codelineno-223-55"></a><span class="err">    }</span>
</span><span id="__span-223-56"><a id="__codelineno-223-56" name="__codelineno-223-56" href="#__codelineno-223-56"></a><span class="err">    post {</span>
</span><span id="__span-223-57"><a id="__codelineno-223-57" name="__codelineno-223-57" href="#__codelineno-223-57"></a><span class="err">        success {</span>
</span><span id="__span-223-58"><a id="__codelineno-223-58" name="__codelineno-223-58" href="#__codelineno-223-58"></a><span class="err">            dingtalk(</span>
</span><span id="__span-223-59"><a id="__codelineno-223-59" name="__codelineno-223-59" href="#__codelineno-223-59"></a><span class="err">                robot: &#39;Jenkins-DingDing&#39;,</span>
</span><span id="__span-223-60"><a id="__codelineno-223-60" name="__codelineno-223-60" href="#__codelineno-223-60"></a><span class="err">                type: &#39;MARKDOWN&#39;,</span>
</span><span id="__span-223-61"><a id="__codelineno-223-61" name="__codelineno-223-61" href="#__codelineno-223-61"></a><span class="err">                title: &quot;success: ${JOB_NAME}&quot;,</span>
</span><span id="__span-223-62"><a id="__codelineno-223-62" name="__codelineno-223-62" href="#__codelineno-223-62"></a><span class="err">                text: [&quot;- 成功构建：${JOB_NAME}! \n- 版本：latest \n- 持续时间：${currentBuild.durationString}&quot; ]</span>
</span><span id="__span-223-63"><a id="__codelineno-223-63" name="__codelineno-223-63" href="#__codelineno-223-63"></a><span class="err">            )</span>
</span><span id="__span-223-64"><a id="__codelineno-223-64" name="__codelineno-223-64" href="#__codelineno-223-64"></a><span class="err">        }</span>
</span><span id="__span-223-65"><a id="__codelineno-223-65" name="__codelineno-223-65" href="#__codelineno-223-65"></a><span class="err">        failure {</span>
</span><span id="__span-223-66"><a id="__codelineno-223-66" name="__codelineno-223-66" href="#__codelineno-223-66"></a><span class="err">            dingtalk(</span>
</span><span id="__span-223-67"><a id="__codelineno-223-67" name="__codelineno-223-67" href="#__codelineno-223-67"></a><span class="err">                robot: &#39;Jenkins-DingDing&#39;,</span>
</span><span id="__span-223-68"><a id="__codelineno-223-68" name="__codelineno-223-68" href="#__codelineno-223-68"></a><span class="err">                type: &#39;MARKDOWN&#39;,</span>
</span><span id="__span-223-69"><a id="__codelineno-223-69" name="__codelineno-223-69" href="#__codelineno-223-69"></a><span class="err">                title: &quot;success: ${JOB_NAME}&quot;,</span>
</span><span id="__span-223-70"><a id="__codelineno-223-70" name="__codelineno-223-70" href="#__codelineno-223-70"></a><span class="err">                text: [&quot;- 构建失败：${JOB_NAME}! \n- 版本：latest \n- 持续时间：${currentBuild.durationString}&quot; ]</span>
</span><span id="__span-223-71"><a id="__codelineno-223-71" name="__codelineno-223-71" href="#__codelineno-223-71"></a><span class="err">            )</span>
</span><span id="__span-223-72"><a id="__codelineno-223-72" name="__codelineno-223-72" href="#__codelineno-223-72"></a><span class="err">        }</span>
</span><span id="__span-223-73"><a id="__codelineno-223-73" name="__codelineno-223-73" href="#__codelineno-223-73"></a><span class="err">    }</span>
</span><span id="__span-223-74"><a id="__codelineno-223-74" name="__codelineno-223-74" href="#__codelineno-223-74"></a><span class="err">}</span>
</span></code></pre></div>
<p>修改pipeline.yml，更改镜像版本</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-224-1"><a id="__codelineno-224-1" name="__codelineno-224-1" href="#__codelineno-224-1"></a>apiVersion: apps/v1
</span><span id="__span-224-2"><a id="__codelineno-224-2" name="__codelineno-224-2" href="#__codelineno-224-2"></a>kind: Deployment
</span><span id="__span-224-3"><a id="__codelineno-224-3" name="__codelineno-224-3" href="#__codelineno-224-3"></a>metadata:
</span><span id="__span-224-4"><a id="__codelineno-224-4" name="__codelineno-224-4" href="#__codelineno-224-4"></a>  namespace: test
</span><span id="__span-224-5"><a id="__codelineno-224-5" name="__codelineno-224-5" href="#__codelineno-224-5"></a>  name: pipeline
</span><span id="__span-224-6"><a id="__codelineno-224-6" name="__codelineno-224-6" href="#__codelineno-224-6"></a>  labels:
</span><span id="__span-224-7"><a id="__codelineno-224-7" name="__codelineno-224-7" href="#__codelineno-224-7"></a>    app: pipeline
</span><span id="__span-224-8"><a id="__codelineno-224-8" name="__codelineno-224-8" href="#__codelineno-224-8"></a>spec:
</span><span id="__span-224-9"><a id="__codelineno-224-9" name="__codelineno-224-9" href="#__codelineno-224-9"></a>  replicas: 2
</span><span id="__span-224-10"><a id="__codelineno-224-10" name="__codelineno-224-10" href="#__codelineno-224-10"></a>  selector:
</span><span id="__span-224-11"><a id="__codelineno-224-11" name="__codelineno-224-11" href="#__codelineno-224-11"></a>    matchLabels:
</span><span id="__span-224-12"><a id="__codelineno-224-12" name="__codelineno-224-12" href="#__codelineno-224-12"></a>      app: pipeline
</span><span id="__span-224-13"><a id="__codelineno-224-13" name="__codelineno-224-13" href="#__codelineno-224-13"></a>  template:
</span><span id="__span-224-14"><a id="__codelineno-224-14" name="__codelineno-224-14" href="#__codelineno-224-14"></a>    metadata:
</span><span id="__span-224-15"><a id="__codelineno-224-15" name="__codelineno-224-15" href="#__codelineno-224-15"></a>      labels:
</span><span id="__span-224-16"><a id="__codelineno-224-16" name="__codelineno-224-16" href="#__codelineno-224-16"></a>        app: pipeline    
</span><span id="__span-224-17"><a id="__codelineno-224-17" name="__codelineno-224-17" href="#__codelineno-224-17"></a>    spec:
</span><span id="__span-224-18"><a id="__codelineno-224-18" name="__codelineno-224-18" href="#__codelineno-224-18"></a>      containers:
</span><span id="__span-224-19"><a id="__codelineno-224-19" name="__codelineno-224-19" href="#__codelineno-224-19"></a>      - name: pipeline
</span><span id="__span-224-20"><a id="__codelineno-224-20" name="__codelineno-224-20" href="#__codelineno-224-20"></a>        image: 192.168.11.102:80/repo/pipeline:latest   # 这里
</span><span id="__span-224-21"><a id="__codelineno-224-21" name="__codelineno-224-21" href="#__codelineno-224-21"></a>        imagePullPolicy: Always
</span><span id="__span-224-22"><a id="__codelineno-224-22" name="__codelineno-224-22" href="#__codelineno-224-22"></a>        ports:
</span><span id="__span-224-23"><a id="__codelineno-224-23" name="__codelineno-224-23" href="#__codelineno-224-23"></a>        - containerPort: 8080
</span><span id="__span-224-24"><a id="__codelineno-224-24" name="__codelineno-224-24" href="#__codelineno-224-24"></a># 省略其他内容…………
</span></code></pre></div>
<h6 id="1063"><a class="toclink" href="../../devops/#1063">10.6.3 滚动更新</a></h6>
<p>因为pipeline没有改变时，每次不会重新加载，这样会导致Pod中的容器不会动态更新，这里需要使用kubectl的rollout restart命令滚动更新</p>
<table>
<thead>
<tr>
<th style="text-align: center;">设置Jenkinsfle</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="1642501521065" src="../../images/DevOps/1642501521065.png" /></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="1642501549176" src="../../images/DevOps/1642501549176.png" /></td>
</tr>
</tbody>
</table>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/saymealoud.png" alt="Chester Zhao">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-03-22 00:00:00">March 22, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">tech</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rabbitmq"><a class="toclink" href="../../rabbitmq/">RabbitMQ</a></h2>
<p>消息真的发送出去了吗?</p>
<ul>
<li>消息发送后,发送端不知道Rabbit MQ 是否真的收到了消息</li>
<li>若 Rabbit MQ 异常,消息丢失后,订单处理流程停止,业务异常</li>
<li>需要使用Rabbit MQ 发送端确认机制, 确认消息发送</li>
</ul>
<p>消息真的被路由了吗?</p>
<ul>
<li>消息发送后,发送端不知道消息是否被正确路由, 若路由异常,消息会被丢弃</li>
<li>消息丢弃后,订单处理流程停止,业务异常</li>
<li>需要使用 Rabbit MQ 消息返回机制, 确认消息被正确路由</li>
</ul>
<p>队列饱满怎么办?</p>
<ul>
<li>默认情况下,消息进入队列,会永远存在,直到被消费</li>
<li>大量堆积的消息会给Rabbit MQ 产生很大的压力</li>
<li>需要使用 Rabbit MQ 消息过期时间,  防止消息大量积压</li>
</ul>
<p>如何转移过期消息</p>
<ul>
<li>消息被设置了过期时间,过期后会直接被丢弃</li>
<li>直接被丢弃的消息,无法对系统运行异常发出警报 </li>
<li>需要使用 Rabbit MQ <strong>死信队列</strong> ,收集过期消息,以供分析</li>
</ul>
<p>目前需要处理:</p>
<ol>
<li>发送端确认</li>
<li>消息返回</li>
<li>消费端限流</li>
<li>消费端确认</li>
<li>消息过期机制</li>
<li>死信队列</li>
</ol>
<p>实际开发经验</p>
<ol>
<li>线程池    溢出  线程爆炸</li>
<li>POJO    类 单一职责</li>
</ol>
<p>发送方</p>
<ul>
<li>需要使用 Rabbit MQ <strong>发送端确认机制,</strong>确认消息成功发送到 Rabbit MQ 并被处理</li>
<li>需要使用Rabbit MQ  <strong>消息返回机制</strong>, 若没发现目标队列, 中间件会通知发送方</li>
</ul>
<p>消费方</p>
<ul>
<li>需要使用 Rabbit MQ <strong>消费端确认机制</strong>,  确认消息没有发生处理异常</li>
<li>需要使用 Rabbit MQ  <strong>消费端限流机制</strong>, 限制消息推送速度, 保障接收端服务稳定</li>
</ul>
<p>Rabbit MQ 自身</p>
<ul>
<li>大量堆积的消息会给 Rabbit MQ  产生很大的压力, 需要使用 Rabbit MQ <strong>消息过期时间</strong>,防止消息大量积压</li>
<li>过期后会直接丢弃, 无法对系统运行异常发出警报, 需要使用 Rabbit MQ  <strong>死信队列</strong> , 收集过期消息,以供分析</li>
</ul>
<p>消息真的发出去了吗?</p>
<ul>
<li>消息发送后, 发送端不知道 Rabbit MQ 是否真的收到了消息</li>
<li>若 Rabbit MQ异常 , 消息丢失后, 订单处理流程停止, 业务异常</li>
<li>需要使用 Rabbit MQ <strong>发送端确认机制</strong>, 确认消息发送</li>
</ul>
<p>什么是发送端确认机制</p>
<ul>
<li>消息发送后, 若中间件收到消息,会给发送端一个应答</li>
<li>生产者,接收应答,用来确认这条消息是否正常发送到中间件</li>
</ul>
<p>三种确认机制</p>
<ul>
<li>单条同步确认</li>
<li>配置 Channel ,开启确认模式: channel.confirmSelect()</li>
<li>每发送一条消息,调用 channel.waitForConfirms()方法,等待确认</li>
<li>多条同步确认 (不推荐)</li>
<li>配置 Channel ,开启确认模式: channel.confirmSelect()</li>
<li>发送多条消息,调用 channel.waitForConfirms()方法,等待确认 </li>
<li>异步确认 (不推荐)</li>
<li>配置 Channel ,开启确认模式: channel.confirmSelect()</li>
<li>在channel 上添加监听: addConfirmListener, 发送消息后,会回调此方法,通知是否发送成功</li>
<li>异步确认有可能是单条, 也有可能是多条,取决于 MQ</li>
</ul>
<p>消息真的被路由了吗</p>
<ul>
<li>消息发送后,发送端不知道消息是否被正确路由,若路由异常,消息会被丢弃</li>
<li>消息丢弃后,订单处理流程停止,业务异常</li>
<li>需要使用 Rabbit MQ <strong>消息返回机制</strong>, 确认消息被正确路由</li>
</ul>
<p>消息返回机制的原理</p>
<ul>
<li>消息发送后,中间件会对消息进行路由</li>
<li>若没有发现目标队列, 中间件会通知发送方</li>
<li>Return Listener 会被调用</li>
</ul>
<p>消息返回的开启方法</p>
<ul>
<li>在 Rabbit MQ 基础配置中有一个关键配置项 : Mandatory </li>
<li>Mandatory 若为false, Rabbit MQ 将直接丢弃无法路由的消息</li>
<li>Mandatory 若为 true , Rabbit MQ 才会处理无法路由的消息</li>
</ul>
<p>消费端确认机制</p>
<ul>
<li>默认情况下,消费端接收消息时,消息会被自动确认 (ACK)</li>
<li>消费端处理消息异常时,发送端与消息中间件无法得知消息处理情况</li>
<li>需要使用 Rabbit MQ <strong>消费端确认机制</strong>, 确认消息被正确处理</li>
</ul>
<p>消费端 ACK 类型</p>
<ul>
<li>自动 ACK : 消费端收到消息后, 会自动签收消息</li>
<li>手动 ACK: 消费端收到消息后, 不会自动签收消息, 需要我们在业务代码中显式签收消息</li>
<li>单条手动 ACK : multiple = false (<strong>推荐</strong>)</li>
<li>多条手动 ACK : multiple = true</li>
</ul>
<p>重回队列</p>
<ul>
<li>若设置了重回队列, 消息被 NACK后, 会返回队列末尾,等待进一步处理</li>
<li>一般不建议开启重回队列,因为第一次处理异常的消息,再次处理,基本上也是异常</li>
</ul>
<p>消费端限流机制</p>
<ul>
<li>业务高峰期,可能出现发送端与接收端性能不一致,大量消息被同时推送给接收端,造成接收端服务崩溃</li>
<li>需要使用 Rabbit MQ <strong>消费端限流机制</strong>, 限制消息推送速度,保障接收端服务稳定</li>
</ul>
<p>实际场景</p>
<ul>
<li>业务高峰期,有个微服务崩溃了,崩溃期间队列积压了大量消息,微服务上线后,收到大量并发消息</li>
<li>将同样多的消息推给能力不同的副本,会导致部分副本异常</li>
</ul>
<p>Rabbit MQ   QoS</p>
<ul>
<li>针对上面问题,  Rabbit MQ 开发了 QoS (服务质量保证)功能</li>
<li>QoS 功能保证了在一定数目的消息未被确认前,不消费新的信息</li>
<li>Qos 功能的前提是不使用自动确认</li>
</ul>
<p>QoS 原理</p>
<ul>
<li>QoS 原理是当消费者有一定数量的消息未被 ACK 确认时, Rabbit MQ 不给消费端推送新的消息</li>
<li>Rabbit MQ 使用 QoS 机制实现了消费端限流</li>
</ul>
<p>消费端限流机制参数设置</p>
<ul>
<li>prefetchCount:  针对消费端最多推送多少未确认消息</li>
<li>global: true : 针对整个消费端限流 false : 针对当前 channel </li>
<li>prefetchSize: 0 (单个消息大小限制, 一般为 0)</li>
<li>prefetchSize 与 global 两项, Rabbit MQ 暂时未实现</li>
</ul>
<p>消息过期机制</p>
<p>队列饱满怎么办?</p>
<ul>
<li>默认情况下,消息进入队列,会永远存在,直到被消费</li>
<li>大量堆积的消息回给 Rabbit MQ 产生很大的压力</li>
<li>需要使用 Rabbit MQ <strong>消息过期时间</strong>,防止消息大量积压</li>
</ul>
<p>Rabbit MQ的 过期时间 (TTL)</p>
<ul>
<li>Rabbit MQ 的过期时间称为  TTL </li>
<li>Rabbit MQ 过期时间分为 消息 TTL 和 队列 TTL</li>
<li>消息TTL 设置了消息的单条过期</li>
<li>队列 TTL 设置了队列中所有消息的过期时间  (如果之前已经定义了队列那就要删除,不然会设置 TTL 启动会报错)</li>
</ul>
<p>如何找到自己合适的 TTL?</p>
<ul>
<li>TTL  设置主要考虑技术架构与业务</li>
<li>TTL 应该明显长于服务的平均重启时间</li>
<li>建议 TTL 长于业务高峰期时间</li>
</ul>
<p>死信队列</p>
<p>如何转移过期消息?</p>
<ul>
<li>消息设置了过期时间,过期后会直接丢弃</li>
<li>直接丢弃的消息,无法对系统运行异常发出警报</li>
<li>需要使用 Rabbit MQ 私信队列, 收集过期消息,以供分析</li>
</ul>
<p>什么是死信队列</p>
<ul>
<li>死信队列: 队列配置了 DLX 属性(Dead-Letter-Exchange)</li>
<li>当一个消息变成死信(dead message )后, 能重新被发布到另一个 Exchange,这个 Exchange 也是一个普通的交换机</li>
<li>死信被死信交换机路由后, 一般进入一个固定队列</li>
</ul>
<p>怎么变成死信</p>
<ul>
<li>消息被拒绝 (reject/nack) 并且 requeue = false</li>
<li>消息过期 (TTL 到期)</li>
<li>队列达到最大长度</li>
</ul>
<p>死信队列设置方法</p>
<ul>
<li>设置转发、接收死信的交换机和队列:</li>
<li>Exchange: dlx.exchange</li>
<li>Queue: dlx.queue</li>
<li>RoutingKey: #</li>
<li>在需要设置死信的队列加入参数:</li>
<li>X-dead-letter-exchange =dlx.exchange</li>
</ul>
<p>summary</p>
<p>慎用Rabbit MQ 高级特性</p>
<ul>
<li>不要无限追求高级,用 Rabbit MQ的高级特性</li>
<li>重回队列、发送端确认是不常用的特性,谨慎使用</li>
<li>管控台是 调试 Rabbit MQ的利器</li>
<li>Rabbit MQ高级特性多数涉及交换机、队列的属性配置,可以在管控台确认配置是否生效</li>
<li>Rabbit MQ 高级特性很多都可以在管控台进行实验</li>
</ul>
<p>总结</p>
<ul>
<li>为了确保消息发送,使用了发送端确认机制</li>
<li>为了确保消息正确路由,使用了消息返回机制</li>
<li>为了保证消息正常梳理,使用了消费端确认机制</li>
<li>为了保证消费端稳定,使用消费端限流机制</li>
<li>为了中间件问题,使用过期时间机制</li>
<li>为了处理异常消息,使用死信机制</li>
</ul>
<p>引入 Spring Boot 的重要性 </p>
<ol>
<li>易用的 Rabbit MQ 连接方式</li>
<li>方便的 Rabbit MQ配置方式</li>
<li>提供了完善的消息收发方式</li>
</ol>
<p>Spring AMQP 特性</p>
<ul>
<li>异步消息监听容器</li>
<li>原始实现: 自己实现线程池、回调方法,并注册回调方法</li>
<li>Spring Boot: 自动实现可配置的线程池,并自动注册回调方法,只需实现回调方法</li>
<li>原生提供 RabbitTemplate , 方便收发消息</li>
<li>相比 basicPublish, 功能更强大,能自动实现消息转换等功能</li>
<li>原生提供 RabbitAdmin ,方便队列、交换机声明</li>
<li>声明式提供队列、交换机、绑定关系的注册方法</li>
<li>设置不需要显式的注册代码</li>
<li>Spring Boot Config  原生支持 Rabbit MQ </li>
<li>充分发挥 Spring Boot 约定大于配置的特性</li>
<li>可以隐式建立 Connection、Channel</li>
</ul>
<p>RabbitAdmin</p>
<ul>
<li>
<p>管理 Rabbit MQ</p>
</li>
<li>
<p>declareExchange : 创建交换机</p>
</li>
<li>deleteExchange: 删除交换机</li>
<li>declareQueue: 创建队列</li>
<li>deleteQueue : 删除队列</li>
<li>purgeQueue: 清空队列</li>
<li>declareBinding: 新建绑定关系</li>
<li>removeBinding:  删除绑定关系</li>
<li>
<p>getQueueProperties: 查询队列属性</p>
</li>
<li>
<p>创建方法</p>
</li>
</ul>
<div class="language-java highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">ConnectionFactory</span><span class="w"> </span><span class="n">connectionFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CachingConnectionFactory</span><span class="p">();</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">RabbitAdmin</span><span class="w"> </span><span class="n">rabbitAdmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RabbitAdmin</span><span class="p">(</span><span class="n">connectionFactory</span><span class="p">);</span>
</span></code></pre></div>
<p>RabbitAdmin 声明式配置</p>
<ul>
<li>将Exchange、Queue、Binding 声明为 Bean</li>
<li>再将 RabbitAdmin 声明为  Bean</li>
<li>Exchange、Queue、Binding 即可自动创建</li>
</ul>
<p>RabbitAdmin  声明式配置的优点</p>
<ul>
<li>将声明和创建工作分开,解耦多人工作</li>
<li>不需要显式声明,减少代码量,减少bug</li>
</ul>
<p>RabbitTemplate</p>
<ul>
<li>RabbitTemplate 与 RestTemplate 类似,使用了模版方法设计模式</li>
<li>RabbitTemplate 提供了丰富的功能,方便消息收发</li>
<li>RabbitTemplate 可以显式传入配置也可以隐式声明配置</li>
</ul>
<p>SimpleMessageListenerContainer 高效监听消息</p>
<ul>
<li>设置同时监听多个队列、自动启动、自动配置Rabbit MQ</li>
<li>设置消费者数量 (最大数量、最小数量、批量消费)</li>
<li>设置消息确认模式、是否重回队列、异常捕获</li>
<li>设置是否独占、其他消费者属性等</li>
<li>设置具体的监听器、消息转换器等</li>
<li>支持动态设置,运行中修改监听器配置</li>
</ul>
<p>MessageListenerAdapter 消息监听适配器</p>
<ul>
<li>适配器设计模式</li>
<li>解决业务逻辑代码无法修改的问题</li>
</ul>
<p>MessageConverter</p>
<ul>
<li>
<p>收发消息,使用 Byte[] 数组作为消息体</p>
</li>
<li>
<p>编写业务逻辑时,需要使用 Java 对象</p>
</li>
<li>
<p>MessageConverter 用来在接收消息时自动转换消息</p>
</li>
</ul>
<p>Jackson2JsonMessageConverter</p>
<ul>
<li>最常用的 MessageConverter ,用来转换 Json 格式信息</li>
<li>配合 ClassMapper 可以直接转换为 POJO 对象 </li>
</ul>
<p>RabbitListener </p>
<ul>
<li>RabbitListener 是 SpringBoot 架构中监听消息的“终极方案”</li>
<li>RabbitListener 使用注解声明,对业务代码无侵入</li>
<li>RabbitListener 可以在 Springboot  配置文件中进行配置</li>
</ul>
<p>@RabbitListener 注解</p>
<ul>
<li>@RabbitListener 是一个组合注解,可以嵌套以下注解</li>
<li>@Exchange : 自动声明Exchange</li>
<li>@Queue : 自动声明队列</li>
<li>@QueueBinding: 自动声明绑定关系</li>
</ul>
<p>Rabbit 容量不足</p>
<ul>
<li>受制于服务器、虚机、容器的规模,单节Rabbit MQ容量受限</li>
<li>在业务量庞大时,单节点MQ可能会因为内存不足导致 OOM</li>
</ul>
<p>Rabbit MQ 数据无副本</p>
<ul>
<li>单节点 Rabbit MQ 没有备份数据</li>
<li>若单节点故障, 消息数据丢失</li>
</ul>
<p>Rabbit MQ 可用性低</p>
<ul>
<li>单节点 Rabbit MQ 不可避免会出现故障</li>
<li>单节点故障后, Rabbit MQ 服务不可用,系统业务崩溃</li>
</ul>
<p>单节点:</p>
<ol>
<li>规模不大 OOM</li>
<li>数据安全</li>
<li>可用性</li>
</ol>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/saymealoud.png" alt="Chester Zhao">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-03-22 00:00:00">March 22, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">tech</a></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rabbitmq"><a class="toclink" href="../../%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85rabbitmq%E6%8C%87%E5%8D%97/">单节点安装Rabbitmq指南</a></h2>
<blockquote>
<p>基于 CentOS 8 版本</p>
</blockquote>
<p>设置主机名称，注意将星号替换为数字</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>hostnamectl set-hostname mq0*.localdomain
</span></code></pre></div>
<p>在hosts文件中，前两行里加入主机名称</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>vi /etc/hosts
</span></code></pre></div>
<p>安装epel</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>sudo yum install epel-release -y
</span></code></pre></div>
<p>安装erlang</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>sudo yum install erlang -y
</span></code></pre></div>
<p>安装socat</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>yum install socat -y
</span></code></pre></div>
<p>安装wget</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>yum install wget -y
</span></code></pre></div>
<p>下载rabbitmq安装包</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.8.8/rabbitmq-server-3.8.8-1.el8.noarch.rpm
</span></code></pre></div>
<p>导入rabbitmq密钥</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>rpm -import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc
</span></code></pre></div>
<p>安装rabbitmq</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>rpm -ivh rabbitmq-server-3.8.8-1.el8.noarch.rpm
</span></code></pre></div>
<p>启动rabbitmq</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>systemctl start rabbitmq-server
</span></code></pre></div>
<p>查看rabbitmq服务状态</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>systemctl status rabbitmq-server
</span></code></pre></div>
<p>启用管控台插件</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>rabbitmq-plugins enable rabbitmq_management
</span></code></pre></div>
<p>关闭系统防火墙</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>systemctl stop firewalld.service
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>systemctl disable firewalld.service
</span></code></pre></div>
<p>添加测试账户</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>rabbitmqctl add_user test test
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>rabbitmqctl set_user_tags test administrator
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>rabbitmqctl set_permissions -p / test &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;
</span></code></pre></div>
<h2 id="rabbitmq_1"><a class="toclink" href="../../%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85rabbitmq%E6%8C%87%E5%8D%97/#rabbitmq_1">RabbitMQ集群配置指南</a></h2>
<p>在集群所有节点安装rabbitmq</p>
<p>编辑hosts,使得节点间可以通过主机名互相访问</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>vi /etc/hosts
</span></code></pre></div>
<p>修改.erlang.cookie权限</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>chmod 777 /var/lib/rabbitmq/.erlang.cookie
</span></code></pre></div>
<p>将主节点的.erlang.cookie文件传输至集群所有节点</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>scp /var/lib/rabbitmq/.erlang.cookie root@mq02:/var/lib/rabbitmq
</span></code></pre></div>
<p>复原.erlang.cookie权限</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a>chmod 400 /var/lib/rabbitmq/.erlang.cookie
</span></code></pre></div>
<p>加入集群</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a>rabbitmqctl stop_app
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a>rabbitmqctl join_cluster --ram rabbit@mq01
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>rabbitmqctl start_app
</span></code></pre></div>
<h2 id="_1"><a class="toclink" href="../../%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85rabbitmq%E6%8C%87%E5%8D%97/#_1">镜像队列配置指南</a></h2>
<p>在主节点增加镜像队列配置</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>rabbitmqctl set_policy ha-all &quot;^&quot; &#39;{&quot;ha-mode&quot;:&quot;all&quot;}&#39;
</span></code></pre></div>
<h2 id="haproxy"><a class="toclink" href="../../%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85rabbitmq%E6%8C%87%E5%8D%97/#haproxy">haproxy负载均衡安装指南</a></h2>
<p>安装haproxy</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>yum install haproxy -y
</span></code></pre></div>
<p>编辑hosts，使得haproxy能够通过主机名访问集群节点</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a>vi /etc/hosts
</span></code></pre></div>
<p>编辑haproxy配置文件</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a>vi /etc/haproxy/haproxy.cfg
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a>global
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a>    # 日志输出配置、所有日志都记录在本机，通过 local0 进行输出
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a>    log 127.0.0.1 local0 info
</span><span id="__span-99-4"><a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>    # 最大连接数
</span><span id="__span-99-5"><a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>    maxconn 4096
</span><span id="__span-99-6"><a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>    daemon
</span><span id="__span-99-7"><a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a># 默认配置
</span><span id="__span-99-8"><a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a>defaults
</span><span id="__span-99-9"><a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a>    # 应用全局的日志配置
</span><span id="__span-99-10"><a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a>    log global
</span><span id="__span-99-11"><a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a>    # 使用4层代理模式，7层代理模式则为&quot;http&quot;
</span><span id="__span-99-12"><a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a>    mode tcp
</span><span id="__span-99-13"><a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a>    # 日志类别
</span><span id="__span-99-14"><a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a>    option tcplog
</span><span id="__span-99-15"><a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a>    # 不记录健康检查的日志信息
</span><span id="__span-99-16"><a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a>    option dontlognull
</span><span id="__span-99-17"><a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a>    # 3次失败则认为服务不可用
</span><span id="__span-99-18"><a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a>    retries 3
</span><span id="__span-99-19"><a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a>    # 每个进程可用的最大连接数
</span><span id="__span-99-20"><a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a>    maxconn 2000
</span><span id="__span-99-21"><a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a>    # 连接超时
</span><span id="__span-99-22"><a id="__codelineno-99-22" name="__codelineno-99-22" href="#__codelineno-99-22"></a>    timeout connect 5s
</span><span id="__span-99-23"><a id="__codelineno-99-23" name="__codelineno-99-23" href="#__codelineno-99-23"></a>    # 客户端超时
</span><span id="__span-99-24"><a id="__codelineno-99-24" name="__codelineno-99-24" href="#__codelineno-99-24"></a>    timeout client 120s
</span><span id="__span-99-25"><a id="__codelineno-99-25" name="__codelineno-99-25" href="#__codelineno-99-25"></a>    # 服务端超时
</span><span id="__span-99-26"><a id="__codelineno-99-26" name="__codelineno-99-26" href="#__codelineno-99-26"></a>    timeout server 120s
</span><span id="__span-99-27"><a id="__codelineno-99-27" name="__codelineno-99-27" href="#__codelineno-99-27"></a>
</span><span id="__span-99-28"><a id="__codelineno-99-28" name="__codelineno-99-28" href="#__codelineno-99-28"></a># 绑定配置
</span><span id="__span-99-29"><a id="__codelineno-99-29" name="__codelineno-99-29" href="#__codelineno-99-29"></a>listen rabbitmq_cluster
</span><span id="__span-99-30"><a id="__codelineno-99-30" name="__codelineno-99-30" href="#__codelineno-99-30"></a>    bind :5672
</span><span id="__span-99-31"><a id="__codelineno-99-31" name="__codelineno-99-31" href="#__codelineno-99-31"></a>    # 配置TCP模式
</span><span id="__span-99-32"><a id="__codelineno-99-32" name="__codelineno-99-32" href="#__codelineno-99-32"></a>    mode tcp
</span><span id="__span-99-33"><a id="__codelineno-99-33" name="__codelineno-99-33" href="#__codelineno-99-33"></a>    # 采用加权轮询的机制进行负载均衡
</span><span id="__span-99-34"><a id="__codelineno-99-34" name="__codelineno-99-34" href="#__codelineno-99-34"></a>    balance roundrobin
</span><span id="__span-99-35"><a id="__codelineno-99-35" name="__codelineno-99-35" href="#__codelineno-99-35"></a>    # RabbitMQ 集群节点配置
</span><span id="__span-99-36"><a id="__codelineno-99-36" name="__codelineno-99-36" href="#__codelineno-99-36"></a>    server mq01 mq01:5672 check inter 5000 rise 2 fall 3 weight 1
</span><span id="__span-99-37"><a id="__codelineno-99-37" name="__codelineno-99-37" href="#__codelineno-99-37"></a>    server mq02 mq02:5672 check inter 5000 rise 2 fall 3 weight 1
</span><span id="__span-99-38"><a id="__codelineno-99-38" name="__codelineno-99-38" href="#__codelineno-99-38"></a>    server mq03 mq03:5672 check inter 5000 rise 2 fall 3 weight 1
</span><span id="__span-99-39"><a id="__codelineno-99-39" name="__codelineno-99-39" href="#__codelineno-99-39"></a>
</span><span id="__span-99-40"><a id="__codelineno-99-40" name="__codelineno-99-40" href="#__codelineno-99-40"></a># 配置监控页面
</span><span id="__span-99-41"><a id="__codelineno-99-41" name="__codelineno-99-41" href="#__codelineno-99-41"></a>listen monitor
</span><span id="__span-99-42"><a id="__codelineno-99-42" name="__codelineno-99-42" href="#__codelineno-99-42"></a>    bind *:8100
</span><span id="__span-99-43"><a id="__codelineno-99-43" name="__codelineno-99-43" href="#__codelineno-99-43"></a>    mode http
</span><span id="__span-99-44"><a id="__codelineno-99-44" name="__codelineno-99-44" href="#__codelineno-99-44"></a>    option httplog
</span><span id="__span-99-45"><a id="__codelineno-99-45" name="__codelineno-99-45" href="#__codelineno-99-45"></a>    stats enable
</span><span id="__span-99-46"><a id="__codelineno-99-46" name="__codelineno-99-46" href="#__codelineno-99-46"></a>    stats uri /rabbitmq
</span><span id="__span-99-47"><a id="__codelineno-99-47" name="__codelineno-99-47" href="#__codelineno-99-47"></a>    stats refresh 5s
</span></code></pre></div>
<p>设置seLinux</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>sudo setsebool -P haproxy_connect_any=1
</span></code></pre></div>
<p>关闭防火墙</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a>systemctl stop firewalld.service
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a>systemctl disable firewalld.service
</span></code></pre></div>
<p>启动haproxy</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>systemctl start haproxy
</span></code></pre></div>
<h2 id="keepalived"><a class="toclink" href="../../%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85rabbitmq%E6%8C%87%E5%8D%97/#keepalived">keepalived配置指南</a></h2>
<p>安装keepalived</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>yum install keepalived -y
</span></code></pre></div>
<p>编辑keepalived配置文件</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a>vi /etc/keepalived/keepalived.conf
</span></code></pre></div>
<p>主机配置文件：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a>! Configuration File for keepalived
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a>global_defs {
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>   router_id mq04
</span><span id="__span-105-5"><a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a>   vrrp_skip_check_adv_addr
</span><span id="__span-105-6"><a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a>   vrrp_strict
</span><span id="__span-105-7"><a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a>   vrrp_garp_interval 0
</span><span id="__span-105-8"><a id="__codelineno-105-8" name="__codelineno-105-8" href="#__codelineno-105-8"></a>   vrrp_gna_interval 0
</span><span id="__span-105-9"><a id="__codelineno-105-9" name="__codelineno-105-9" href="#__codelineno-105-9"></a>}
</span><span id="__span-105-10"><a id="__codelineno-105-10" name="__codelineno-105-10" href="#__codelineno-105-10"></a>
</span><span id="__span-105-11"><a id="__codelineno-105-11" name="__codelineno-105-11" href="#__codelineno-105-11"></a>vrrp_script chk_haproxy {
</span><span id="__span-105-12"><a id="__codelineno-105-12" name="__codelineno-105-12" href="#__codelineno-105-12"></a>    script &quot;/etc/keepalived/haproxy_check.sh&quot;  ##执行脚本位置
</span><span id="__span-105-13"><a id="__codelineno-105-13" name="__codelineno-105-13" href="#__codelineno-105-13"></a>    interval 2  ##检测时间间隔
</span><span id="__span-105-14"><a id="__codelineno-105-14" name="__codelineno-105-14" href="#__codelineno-105-14"></a>    weight -20  ##如果条件成立则权重减20
</span><span id="__span-105-15"><a id="__codelineno-105-15" name="__codelineno-105-15" href="#__codelineno-105-15"></a>}
</span><span id="__span-105-16"><a id="__codelineno-105-16" name="__codelineno-105-16" href="#__codelineno-105-16"></a>
</span><span id="__span-105-17"><a id="__codelineno-105-17" name="__codelineno-105-17" href="#__codelineno-105-17"></a>vrrp_instance VI_1 {
</span><span id="__span-105-18"><a id="__codelineno-105-18" name="__codelineno-105-18" href="#__codelineno-105-18"></a>    state MASTER
</span><span id="__span-105-19"><a id="__codelineno-105-19" name="__codelineno-105-19" href="#__codelineno-105-19"></a>    interface ens33
</span><span id="__span-105-20"><a id="__codelineno-105-20" name="__codelineno-105-20" href="#__codelineno-105-20"></a>    virtual_router_id 51
</span><span id="__span-105-21"><a id="__codelineno-105-21" name="__codelineno-105-21" href="#__codelineno-105-21"></a>    mcast_src_ip 192.168.57.133
</span><span id="__span-105-22"><a id="__codelineno-105-22" name="__codelineno-105-22" href="#__codelineno-105-22"></a>    priority 100
</span><span id="__span-105-23"><a id="__codelineno-105-23" name="__codelineno-105-23" href="#__codelineno-105-23"></a>    advert_int 1
</span><span id="__span-105-24"><a id="__codelineno-105-24" name="__codelineno-105-24" href="#__codelineno-105-24"></a>    authentication {
</span><span id="__span-105-25"><a id="__codelineno-105-25" name="__codelineno-105-25" href="#__codelineno-105-25"></a>        auth_type PASS
</span><span id="__span-105-26"><a id="__codelineno-105-26" name="__codelineno-105-26" href="#__codelineno-105-26"></a>        auth_pass 1111
</span><span id="__span-105-27"><a id="__codelineno-105-27" name="__codelineno-105-27" href="#__codelineno-105-27"></a>    }
</span><span id="__span-105-28"><a id="__codelineno-105-28" name="__codelineno-105-28" href="#__codelineno-105-28"></a>    virtual_ipaddress {
</span><span id="__span-105-29"><a id="__codelineno-105-29" name="__codelineno-105-29" href="#__codelineno-105-29"></a>        192.168.57.233
</span><span id="__span-105-30"><a id="__codelineno-105-30" name="__codelineno-105-30" href="#__codelineno-105-30"></a>    }
</span><span id="__span-105-31"><a id="__codelineno-105-31" name="__codelineno-105-31" href="#__codelineno-105-31"></a>    track_script {
</span><span id="__span-105-32"><a id="__codelineno-105-32" name="__codelineno-105-32" href="#__codelineno-105-32"></a>        chk_haproxy
</span><span id="__span-105-33"><a id="__codelineno-105-33" name="__codelineno-105-33" href="#__codelineno-105-33"></a>    }
</span><span id="__span-105-34"><a id="__codelineno-105-34" name="__codelineno-105-34" href="#__codelineno-105-34"></a>}
</span></code></pre></div>
<p>热备机配置文件：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a>global_defs {
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a>   router_id mq04
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a>   vrrp_skip_check_adv_addr
</span><span id="__span-106-4"><a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a>   vrrp_strict
</span><span id="__span-106-5"><a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a>   vrrp_garp_interval 0
</span><span id="__span-106-6"><a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a>   vrrp_gna_interval 0
</span><span id="__span-106-7"><a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a>}
</span><span id="__span-106-8"><a id="__codelineno-106-8" name="__codelineno-106-8" href="#__codelineno-106-8"></a>
</span><span id="__span-106-9"><a id="__codelineno-106-9" name="__codelineno-106-9" href="#__codelineno-106-9"></a>vrrp_script chk_haproxy {
</span><span id="__span-106-10"><a id="__codelineno-106-10" name="__codelineno-106-10" href="#__codelineno-106-10"></a>    script &quot;/etc/keepalived/haproxy_check.sh&quot;  ##执行脚本位置
</span><span id="__span-106-11"><a id="__codelineno-106-11" name="__codelineno-106-11" href="#__codelineno-106-11"></a>    interval 2  ##检测时间间隔
</span><span id="__span-106-12"><a id="__codelineno-106-12" name="__codelineno-106-12" href="#__codelineno-106-12"></a>    weight -20  ##如果条件成立则权重减20
</span><span id="__span-106-13"><a id="__codelineno-106-13" name="__codelineno-106-13" href="#__codelineno-106-13"></a>}
</span><span id="__span-106-14"><a id="__codelineno-106-14" name="__codelineno-106-14" href="#__codelineno-106-14"></a>
</span><span id="__span-106-15"><a id="__codelineno-106-15" name="__codelineno-106-15" href="#__codelineno-106-15"></a>vrrp_instance VI_1 {
</span><span id="__span-106-16"><a id="__codelineno-106-16" name="__codelineno-106-16" href="#__codelineno-106-16"></a>    state BACKUP
</span><span id="__span-106-17"><a id="__codelineno-106-17" name="__codelineno-106-17" href="#__codelineno-106-17"></a>    interface ens33
</span><span id="__span-106-18"><a id="__codelineno-106-18" name="__codelineno-106-18" href="#__codelineno-106-18"></a>    virtual_router_id 51
</span><span id="__span-106-19"><a id="__codelineno-106-19" name="__codelineno-106-19" href="#__codelineno-106-19"></a>    mcast_src_ip 192.168.57.131
</span><span id="__span-106-20"><a id="__codelineno-106-20" name="__codelineno-106-20" href="#__codelineno-106-20"></a>    priority 50
</span><span id="__span-106-21"><a id="__codelineno-106-21" name="__codelineno-106-21" href="#__codelineno-106-21"></a>    advert_int 1
</span><span id="__span-106-22"><a id="__codelineno-106-22" name="__codelineno-106-22" href="#__codelineno-106-22"></a>    authentication {
</span><span id="__span-106-23"><a id="__codelineno-106-23" name="__codelineno-106-23" href="#__codelineno-106-23"></a>        auth_type PASS
</span><span id="__span-106-24"><a id="__codelineno-106-24" name="__codelineno-106-24" href="#__codelineno-106-24"></a>        auth_pass 1111
</span><span id="__span-106-25"><a id="__codelineno-106-25" name="__codelineno-106-25" href="#__codelineno-106-25"></a>    }
</span><span id="__span-106-26"><a id="__codelineno-106-26" name="__codelineno-106-26" href="#__codelineno-106-26"></a>    virtual_ipaddress {
</span><span id="__span-106-27"><a id="__codelineno-106-27" name="__codelineno-106-27" href="#__codelineno-106-27"></a>        192.168.57.233
</span><span id="__span-106-28"><a id="__codelineno-106-28" name="__codelineno-106-28" href="#__codelineno-106-28"></a>    }
</span><span id="__span-106-29"><a id="__codelineno-106-29" name="__codelineno-106-29" href="#__codelineno-106-29"></a>    track_script {
</span><span id="__span-106-30"><a id="__codelineno-106-30" name="__codelineno-106-30" href="#__codelineno-106-30"></a>        chk_haproxy
</span><span id="__span-106-31"><a id="__codelineno-106-31" name="__codelineno-106-31" href="#__codelineno-106-31"></a>    }
</span><span id="__span-106-32"><a id="__codelineno-106-32" name="__codelineno-106-32" href="#__codelineno-106-32"></a>}
</span></code></pre></div>
<p>健康检测脚本</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a>vi /etc/keepalived/haproxy_check.sh
</span></code></pre></div>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="nv">COUNT</span><span class="o">=</span><span class="sb">`</span>ps<span class="w"> </span>-C<span class="w"> </span>haproxy<span class="w"> </span>--no-header<span class="w"> </span><span class="p">|</span>wc<span class="w"> </span>-l<span class="sb">`</span>
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$COUNT</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span><span id="__span-108-4"><a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a><span class="w">    </span>systemctl<span class="w"> </span>start<span class="w"> </span>haproxy
</span><span id="__span-108-5"><a id="__codelineno-108-5" name="__codelineno-108-5" href="#__codelineno-108-5"></a><span class="w">    </span>sleep<span class="w"> </span><span class="m">2</span>
</span><span id="__span-108-6"><a id="__codelineno-108-6" name="__codelineno-108-6" href="#__codelineno-108-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="sb">`</span>ps<span class="w"> </span>-C<span class="w"> </span>haproxy<span class="w"> </span>--no-header<span class="w"> </span><span class="p">|</span>wc<span class="w"> </span>-l<span class="sb">`</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span><span id="__span-108-7"><a id="__codelineno-108-7" name="__codelineno-108-7" href="#__codelineno-108-7"></a><span class="w">        </span>systemctl<span class="w"> </span>stop<span class="w"> </span>keepalived
</span><span id="__span-108-8"><a id="__codelineno-108-8" name="__codelineno-108-8" href="#__codelineno-108-8"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-108-9"><a id="__codelineno-108-9" name="__codelineno-108-9" href="#__codelineno-108-9"></a><span class="k">fi</span>
</span></code></pre></div>
<p>修改健康检测脚本执行权限</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a>chmod +x /etc/keepalived/haproxy_check.sh
</span></code></pre></div>
<p>启动keepalived</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a>systemctl start keepalived
</span></code></pre></div>
<p>做故障转移实验时，关闭keepalived即可</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a>systemctl stop keepalived
</span></code></pre></div>
<h2 id="federation"><a class="toclink" href="../../%E5%8D%95%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85rabbitmq%E6%8C%87%E5%8D%97/#federation">Federation 配置指南</a></h2>
<p>首先需要开启federation插件</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a>rabbitmq-plugins enable rabbitmq_federation_management
</span></code></pre></div>
<p>federation的配置一共有三个层次</p>
<ul>
<li>Upstreams - 每个upstream定义怎么连接到其他broker</li>
<li>Upstream sets - 把每一个upstreajiangm设置在一个组中，使upstreams使用federation。</li>
<li>Policies 可以将Upstreams和Upstream sets按照规则配置到exchange和queue中</li>
</ul>
<p>实际上，在最简单的使用情况下，你可以忽略已经存在的upstream设置，因为有一个隐含的默认upstream叫做“all”，他会添加所有的upstream。</p>
<div class="language-text highlight"><pre><span></span><code>   upstreams和upstream set都是实例的参数，就像exchanges、queues、virtual host都有他们自己的特有的parameters和policies一样。可以通过三种方式设置parameter和policy：rabbitmqctl、http api、ui。
</code></pre></div>
<p>实验环境</p>
<p>把ubuntuTest01的数据自动复制到ubuntuTest02</p>
<ul>
<li>10.20.112.26 ubuntuTest01</li>
<li>10.20.112.27 ubuntuTest02</li>
</ul>
<p>首先确保两台机器的federation插件已经安装，参照上面步骤。</p>
<p>在浏览器登陆ubuntuTest02的rabbitmq的ui管理界面：http://10.20.112.27:15672/#/</p>
<p>创建exchange：test.exchange，使用默认配置</p>
<p>UI操作：Exchanges-&gt;Add a new exchange</p>
<p><img alt="6-1" src="../../images/rabbitmq-cluster/6-1.jpg" /></p>
<p>在rabbitmq中会有一些默认的exchange，创建完毕后如图：</p>
<p><img alt="6-2" src="../../images/rabbitmq-cluster/6-2.jpg" /></p>
<p>创建queue：test.queue，绑定到test.exchange，key使用test。</p>
<p>UI操作：Queues-&gt;Add a new queue</p>
<p><img alt="6-3" src="../../images/rabbitmq-cluster/6-3.jpg" /></p>
<p>绑定到test.exchange，并设置key</p>
<p>UI操作：Queues-&gt;All queues(test.queue[单击])-&gt;Bindings</p>
<p><img alt="6-4" src="../../images/rabbitmq-cluster/6-4.jpg" /></p>
<p>创建upstream：upstream1</p>
<p>UI操作：Admin-&gt;Federation Upstreams-&gt;Add a new upstream</p>
<p><img alt="6-5" src="../../images/rabbitmq-cluster/6-5.jpg" /></p>
<p>创建Parameters：mqcluster</p>
<p>UI操作：Admin-&gt;Federation Upstreams-&gt;Parameters</p>
<p><img alt="6-6" src="../../images/rabbitmq-cluster/6-6.jpg" /></p>
<p>创建policy：mypolicy</p>
<p>UI操作：Admin-&gt;Policies-&gt;Add / update a policy</p>
<p><img alt="6-7" src="../../images/rabbitmq-cluster/6-7.jpg" /></p>
<p>状态图</p>
<p><img alt="6-8" src="../../images/rabbitmq-cluster/6-8.jpg" /></p>
<p>观察26上面的连接</p>
<p><img alt="6-9" src="../../images/rabbitmq-cluster/6-9.jpg" /></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/saymealoud.png" alt="Chester Zhao">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-03-04 00:00:00">March 4, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">tech</a></li>
        
        
          
          <li class="md-meta__item">
            
              7 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="xxx-job"><a class="toclink" href="../../xxx-job/">Xxx job</a></h2>
<h4 id="xxl-jobspringboot"><a class="toclink" href="../../xxx-job/#xxl-jobspringboot">第一章 新版分布式调度XXL-Job+SpringBoot课程介绍</a></h4>
<h5 id="1-xxl-jobspringboot"><a class="toclink" href="../../xxx-job/#1-xxl-jobspringboot">第1集 新版分布式调度XXL-Job+SpringBoot实战专题课程介绍</a></h5>
<p><strong>简介：分布式调度XXL-Job介绍-适合人员和学后水平</strong></p>
<ul>
<li>课程介绍</li>
<li>
<p>本套课程 是<strong>全新录制，</strong>从0到1讲解新版分布式调度XXL-Job核心基础+<strong>高级知识点。</strong></p>
</li>
<li>
<p>不止讲解新版XXL-Job核心知识 ，横向对比多个业界解决方案，源码部署分布式调度XXL-Job，讲解控制台各个模块知识点，使用SpringBoot整合XXL-Job实战，多节点执行器和调度策略实战，命令行参数传递和日志配置</p>
</li>
<li>
<p>【高级部分】XXL-Job集群部署和架构链路讲解，海量任务调度解决方案分片广播讲解和实战</p>
</li>
<li>
<p>为什么要学习分布式调度XXL-Job</p>
</li>
<li>XXL-JOB是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展</li>
<li>多数互联网公司里面用的技术，周期性业务 如<strong>消息推送、支付对账、数据统计</strong>等，离不开分布式调度</li>
<li>在多数互联网公司中，分布式调度XXL-Job占有率很高，是近几年大量流行</li>
<li>可以作为公司内部培训技术分享必备知识，超多案例+实战等</li>
<li>
<p>有谁在用</p>
<ul>
<li>众多互联网大厂，包括并不限于虎牙、京东、荔枝FM、平安、360、网易 等 一二线大厂</li>
<li>https://www.xuxueli.com/</li>
</ul>
</li>
<li>
<p>课程技术栈和测试环境说明</p>
</li>
<li>
<p>JDk8或者JDK11 + SpringBoot + 源码部署 + IDEA+XXLJob2.3</p>
</li>
<li>
<p>技术不断更新，版本如何选择 </p>
<ul>
<li>中间件使用这块，不建议做第一个吃螃蟹的人</li>
<li>不同中间件，厂商不一样，不一定及时更新</li>
</ul>
</li>
<li>
<p>学后水平</p>
</li>
<li>
<p>掌握新版XXL-Job核心知识 ，横向对比多个业界解决方案</p>
</li>
<li>源码部署XXL-Job和控制台菜单模块功能点</li>
<li>掌握使用SpringBoot整合XXL-Job实战</li>
<li>掌握多节点执行器和调度策略实战，命令行参数传递和日志配置</li>
<li>【高级】XXL-Job集群部署和架构链路讲解</li>
<li>【高级】海量任务调度解决方案分片广播讲解和实战</li>
</ul>
<h5 id="2-xxl-jobspringboot"><a class="toclink" href="../../xxx-job/#2-xxl-jobspringboot">第2集 新版分布式调度XXL-Job+SpringBoot实战大纲速览</a></h5>
<p><strong>简介：新版分布式调度XXL-Job+SpringBoot实战大纲速览</strong></p>
<ul>
<li>课程学前基础</li>
<li>有Linux+SpringBoot就行，不会的话我们有专题课程学习,联系客服小姐姐即可</li>
<li>
<p>框架整合这块：采用SpringBoot框架（采用其他语言或框架也行）</p>
</li>
<li>
<p>目录大纲浏览</p>
</li>
</ul>
<h4 id="xxl-job"><a class="toclink" href="../../xxx-job/#xxl-job">第二章 急速认知分布式调度XXL-Job框架和源码安装</a></h4>
<h5 id="1"><a class="toclink" href="../../xxx-job/#1">第1集 你知道多少种定时任务的实现方式</a></h5>
<p><strong>简介：你知道多少种定时任务的实现方式</strong></p>
<ul>
<li>需求分析</li>
<li>在平常的业务场景当中，经常有一些场景需要使用到定时任务</li>
<li>比如说在某个时间点会发送优惠券、发送短信等等的一些业务操作，难道这些操作都需要人工来进行干预吗？</li>
<li>
<p>比如一些支付系统，需要在每天的凌晨1点来进行对前一天的清算，难道每次都要一个人来负责这个业务吗？</p>
</li>
<li>
<p>定时任务</p>
</li>
<li>通过时间表达式这一方式来进行任务调度的被称为定时任务</li>
<li>
<p>分类</p>
<ul>
<li>单机定时任务</li>
<li>单机的容易实现，但应用于集群环境做分布式部署，就会带来重复执行</li>
<li>解决方案有很多比如加锁、数据库等，但是增加了很多非业务逻辑</li>
<li>分布式调度（分布式定时任务）</li>
<li>把需要处理的计划任务放入到统一的平台，实现集群管理调度与分布式部署的定时任务 叫做分布式定时任务</li>
<li>支持集群部署、高可用、并行调度、分片处理等</li>
</ul>
</li>
<li>
<p>常见定时任务</p>
</li>
<li>单机：Java自带的java.util.Timer类配置比较麻烦，时间延后问题</li>
<li>单机：ScheduledExecutorService<ul>
<li>是基于线程池来进行设计的定时任务类，在这里每个调度的任务都会分配到线程池里的一个线程去执行该任务，并发执行，互不影响</li>
</ul>
</li>
<li>
<p>单机：SpringBoot框架自带</p>
<ul>
<li>SpringBoot使用注解方式开启定时任务</li>
<li>启动类里面 @EnableScheduling开启定时任务，自动扫描</li>
<li>定时任务业务类 加注解 @Component被容器扫描</li>
<li>定时执行的方法加上注解 @Scheduled(fixedRate=2000) 定期执行一次</li>
</ul>
</li>
<li>
<p>为什么需要任务调度平台</p>
</li>
<li>
<p>因为在传统的Java当中，传统的定时任务实现方案，像上述的Timer、Quartz等</p>
</li>
<li>
<p>它们都有不少缺点</p>
<ul>
<li>不支持集群、不支持统计、没有管理的平台、也没有报警、监控等等</li>
<li>在分布式架构当中，有一些场景是需要用到分布式的任务调度的，在同一个服务器中的多个实例任务之间存在着互斥，需要进行统一的调度，所以任务调度需要支持高可用、监控、故障告警等一系列措施。</li>
<li>需要统一管理和追踪各个的服务节点之间任务调度的结果，并保存记录任务信息等等</li>
</ul>
</li>
<li>
<p>如何解决上述问题？</p>
<ul>
<li>分布式调度平台</li>
</ul>
</li>
</ul>
<h5 id="2"><a class="toclink" href="../../xxx-job/#2">第2集 常见的分布式调度平台快速认知</a></h5>
<p><strong>简介：常见的分布式调度平台快速认知</strong></p>
<ul>
<li>
<p>常见分布式定时任务</p>
</li>
<li>
<p>Quartz</p>
<ul>
<li>Quartz关注点在于定时任务而并非是数据，并没有一套根据数据化处理而定的流程</li>
<li>虽然可以实现数据库作业的高可用，但是缺少了分布式的并行调度功能，相对弱点</li>
<li>不支持任务分片、没UI界面管理，并行调度、失败策略等也缺少</li>
</ul>
</li>
<li>
<p>TBSchedule</p>
<ul>
<li>这个是阿里早期开源的分布式任务调度系统，使用的是timer而不是线程池执行任务调度，使用timer在处理异常的时候是有缺陷的，但TBSchedule的作业类型比较单一，文档也缺失得比较严重</li>
<li>目前阿里内部使用的是ScheduleX</li>
<li>阿里云也有商业化版本: https://help.aliyun.com/product/147760.html</li>
</ul>
<p><img alt="image-20220519175053475" src="img/image-20220519175053475.png" /></p>
</li>
<li>
<p>Elastic-job</p>
<ul>
<li>当当开发的分布式任务调度系统，功能强大，采用的是zookeeper实现分布式协调，具有高可用与分片。</li>
<li>2020年6月，ElasticJob的四个子项目已经正式迁入Apache仓库</li>
<li>由 2 个相互独立的子项目 ElasticJob-Lite 和 ElasticJob-Cloud 组成</li>
<li>ElasticJob-Lite 定位为轻量级无中心化解决方案，使用jar的形式提供分布式任务的协调服务；</li>
<li>ElasticJob-Cloud 使用 Mesos 的解决方案，额外提供资源治理、应用分发以及进程隔离等服务</li>
<li>地址：https://shardingsphere.apache.org/elasticjob/index_zh.html</li>
</ul>
</li>
<li>
<p>XXL-JOB</p>
<ul>
<li>大众点评的员工徐雪里在15年发布的分布式任务调度平台，是轻量级的分布式任务调度框架，目标是开发迅速、简单、清理、易扩展; 老版本是依赖quartz的定时任务触发，在v2.1.0版本开始 移除quartz依赖</li>
<li>地址：https://www.xuxueli.com/xxl-job/</li>
</ul>
</li>
<li>
<p>常规对比图</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>对比项</th>
<th>XXL-JOB</th>
<th>elastic-job</th>
</tr>
</thead>
<tbody>
<tr>
<td>并行调度</td>
<td>调度系统多线程并行</td>
<td>任务分片的方式并行</td>
</tr>
<tr>
<td>弹性扩容</td>
<td>使用Quartz基于数据库分布式功能</td>
<td>通过zookeeper保证</td>
</tr>
<tr>
<td>高可用</td>
<td>通过DB锁保证</td>
<td>通过zookeeper保证</td>
</tr>
<tr>
<td>阻塞策略</td>
<td>单机串行/丢弃后续的调度/覆盖之前的调度</td>
<td>执行超过zookeeper的session timeout时间的话，会被清除，重新进行分片</td>
</tr>
<tr>
<td>动态分片策略</td>
<td>以执行器为维度进行分片、支持动态的扩容</td>
<td>平均分配/作业名hash分配/自定义策略</td>
</tr>
<tr>
<td>失败处理策略</td>
<td>失败告警/失败重试</td>
<td>执行完毕后主动获取未分配分片任务 服务器下线后主动寻找可以用的服务器执行任务</td>
</tr>
<tr>
<td>监控</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>日志</td>
<td>支持</td>
<td>支持</td>
</tr>
</tbody>
</table>
<ul>
<li>如何选择哪一个分布式任务调度平台</li>
<li>XXL-Job和Elastic-Job都具有广泛的用户基础和完善的技术文档，都可以满足定时任务的基本功能需求</li>
<li>xxl-job侧重在业务实现简单和管理方便，容易学习，失败与路由策略丰富, 推荐使用在用户基数相对较少，服务器的数量在一定的范围内的场景下使用</li>
<li>elastic-job关注的点在数据，添加了弹性扩容和数据分片的思路，更方便利用分布式服务器的资源, 但是学习难度较大，推荐在数据量庞大，服务器数量多的时候使用</li>
</ul>
<h5 id="3-xxl-job"><a class="toclink" href="../../xxx-job/#3-xxl-job">第3集 带你走近分布式调度XXL-Job核心特性</a></h5>
<p><strong>简介：带你走近分布式调度XXL-Job核心特性</strong></p>
<ul>
<li>
<p>什么是XXL-Job</p>
</li>
<li>
<p>XXL-JOB</p>
<ul>
<li>大众点评的员工徐雪里在15年发布的分布式任务调度平台，是轻量级的分布式任务调度框架，目标是开发迅速、简单、清理、易扩展; 老版本是依赖quartz的定时任务触发，在v2.1.0版本开始 移除quartz依赖</li>
<li>官网地址：https://www.xuxueli.com/xxl-job/</li>
<li>GitHub地址：https://github.com/xuxueli/xxl-job/</li>
</ul>
</li>
<li>
<p>xxl-job的设计思想</p>
<ul>
<li>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</li>
<li>将任务抽象成分散的JobHandler，交由“执行器”统一管理</li>
<li>“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</li>
<li>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性</li>
</ul>
</li>
<li>
<p>架构图(图片来源是xxl-job官网)</p>
</li>
<li>
<p>调度中心</p>
<ul>
<li>负责管理调度的信息，按照调度的配置来发出调度请求</li>
<li>支持可视化、简单的动态管理调度信息，包括新建、删除、更新等，这些操作都会实时生效，同时也支持监控调度结果以及执行日志。</li>
</ul>
</li>
<li>
<p>执行器</p>
<ul>
<li>负责接收请求并且执行任务的逻辑。任务模块专注于任务的执行操作等等，使得开发和维护更加的简单与高效</li>
</ul>
</li>
<li>
<p>XXL-Job具有哪些特性</p>
</li>
<li>调度中心HA（中心式）：调度采用了中心式进行设计，“调度中心”支持集群部署，可保证调度中心HA</li>
<li>执行器HA（分布式）：任务分布式的执行，任务执行器支持集群部署，可保证任务执行HA</li>
<li>触发策略：有Cron触发、固定间隔触发、固定延时触发、API事件触发、人工触发、父子任务触发</li>
<li>路由策略：执行器在集群部署的时候提供了丰富的路由策略，如：第一个、最后一个、轮询、随机、一致性HASH、最不经常使用LFU、最久未使用LRU、故障转移等等</li>
<li>故障转移：如果执行器集群的一台机器发生故障，会自动切换到一台正常的执行器发送任务调度</li>
<li>Rolling实时日志的监控：支持rolling方式查看输入的完整执行日志</li>
<li>脚本任务：支持GLUE模式开发和运行脚本任务，包括Shell、python、node.js、php等等类型脚本</li>
</ul>
<h5 id="4-xxl-job"><a class="toclink" href="../../xxx-job/#4-xxl-job">第4集 分布式调度XXl-Job源码部署和数据库表建立《上》</a></h5>
<p><strong>简介：新版分布式调度XXl-Job源码部署和数据库表建立《上》</strong></p>
<ul>
<li>
<p>下载地址（版本和课程保证一致）</p>
</li>
<li>
<p>https://github.com/xuxueli/xxl-job/releases</p>
</li>
<li>
<p>版本V-2.3</p>
</li>
<li>
<p>源码（本章本集资料）</p>
</li>
<li>
<p>环境：IDEA旗舰版+Maven+JDK8或JDK11+Mysql5.7（本身就是SpringBoot项目）</p>
</li>
<li>
<p>目录介绍</p>
<ul>
<li>doc：xxl-job的文档资料，包括了数据库的脚本（后面要用到）</li>
<li>xxl-job-core：公共jar包依赖</li>
<li>xxl-job-admin：调度中心，项目源码，是Springboot项目，可以直接启动</li>
<li>xxl-job-executor-samples：执行器，是Sample实例项目，里面的Springboot工程可以直接启动，也可以在该项目的基础上进行开发，也可以将现有的项目改造成为执行器项目</li>
</ul>
</li>
<li>
<p>数据库（本章本集资料或者源码doc/db目录下）</p>
</li>
<li>
<p>xxl_job的数据库里有如下几个表</p>
<ul>
<li>xxl_job_group：执行器信息表，用于维护任务执行器的信息</li>
<li>xxl_job_info：调度扩展信息表，主要是用于保存xxl-job的调度任务的扩展信息，比如说像任务分组、任务名、机器的地址等等</li>
<li>xxl_job_lock：任务调度锁表</li>
<li>xxl_job_log：日志表，主要是用在保存xxl-job任务调度历史信息，像调度结果、执行结果、调度入参等等</li>
<li>xxl_job_log_report：日志报表，会存储xxl-job任务调度的日志报表，会在调度中心里的报表功能里使用到</li>
<li>xxl_job_logglue：任务的GLUE日志，用于保存GLUE日志的更新历史变化，支持GLUE版本的回溯功能</li>
<li>xxl_job_registry：执行器的注册表，用在维护在线的执行器与调度中心的地址信息</li>
<li>xxl_job_user：系统的用户表</li>
</ul>
</li>
</ul>
<h5 id="5-xxl-job"><a class="toclink" href="../../xxx-job/#5-xxl-job">第5集 新版分布式调度XXl-Job源码部署和数据库表建立《下》</a></h5>
<p><strong>简介：新版分布式调度XXl-Job源码部署和数据库表建立《下》</strong></p>
<ul>
<li>
<p>部署XXL-Job步骤</p>
</li>
<li>
<p>xxl-job-admin目录配置文件 application.properties</p>
<ul>
<li>配置数据库连接</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>### xxl-job, datasource
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>spring.datasource.username=root
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>spring.datasource.password=xdclass.net
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
</span></code></pre></div>
<ul>
<li>配置 xxl.job.accessToken（后续要配置客户端接入配置token）</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>xxl.job.accessToken=xdclass.net
</span></code></pre></div>
</li>
<li>
<p>构建编译：mvn install</p>
</li>
<li>
<p>启动项目</p>
</li>
<li>
<p>注意</p>
</li>
<li>
<p>网络部署属于CS架构，需要双方网络互通</p>
</li>
<li>
<p>Mac电脑启动报错</p>
</li>
<li>
<p>访问地址</p>
</li>
<li>地址：ip:8080/xxl-job-admin</li>
<li>默认账号密码：admin / 123456</li>
</ul>
<h5 id="6-xxl-job-ui"><a class="toclink" href="../../xxx-job/#6-xxl-job-ui">第6集 分布式调度XXL-Job UI菜单模块介绍</a></h5>
<p><strong>简介：分布式调度XXL-Job UI界面介绍</strong></p>
<ul>
<li>运行报表</li>
<li>
<p>以图形化来展示了整体的任务执行情况</p>
<ul>
<li>任务数量：能够看到调度中心运行的任务数量</li>
<li>调度次数：调度中心所触发的调度次数</li>
<li>执行器数量：在整个调度中心中，在线的执行器数量有多少</li>
</ul>
</li>
<li>
<p>任务管理（配置执行任务）</p>
</li>
<li>示例执行器：所用到的执行器</li>
<li>任务描述：概述该任务是做什么的</li>
<li>路由策略：<ul>
<li>第一个：选择第一个机器</li>
<li>最后一个：选择最后一个机器</li>
<li>轮询：依次选择执行</li>
<li>随机：随机选择在线的机器</li>
<li>一致性HASH：每个任务按照Hash算法固定选择某一台机器，并且所有的任务均匀散列在不同的机器上</li>
<li>最不经常使用：使用频率最低的机器优先被使用</li>
<li>最近最久未使用：最久未使用的机器优先被选举</li>
<li>故障转移：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标的执行器并且会发起任务调度</li>
<li>忙碌转移：按照顺序来依次进行空闲检测，第一个空闲检测成功的机器会被选定为目标群机器，并且会发起任务调度</li>
<li>分片广播：广播触发对于集群中的所有机器执行任务，同时会系统会自动传递分片的参数</li>
</ul>
</li>
<li>Cron：执行规则 </li>
<li>调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等</li>
<li>JobHandler：定义执行器的名字</li>
<li>阻塞处理策略：<ul>
<li>单机串行：新的调度任务在进入到执行器之后，该调度任务进入FIFO队列，并以串行的方式去进行</li>
<li>丢弃后续调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，本次的调度任务请求就会被丢弃掉，并且标记为失败</li>
<li>覆盖之前的调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，就会终止掉当前正在运行的调度任务，并且清空队列，运行新的调度任务。</li>
</ul>
</li>
<li>子任务ID：输入子任务的任务id，可填写多个</li>
<li>任务超时时间：添加任务超时的时候，单位s，设置时间大于0的时候就会生效</li>
<li>失败重试次数：设置失败重试的次数，设置时间大于0的时候就会生效</li>
<li>负责人：填写该任务调度的负责人</li>
<li>
<p>报警邮件：出现报警，则发送邮件</p>
</li>
<li>
<p>调度日志</p>
</li>
<li>这里是查看调度的日志，根据日志来查看任务具体的执行情况是怎样的</li>
<li>执行器管理</li>
<li>这里是配置执行器，等待执行器启动的时候都会被调度中心监听加入到地址列表</li>
<li>用户管理</li>
<li>可以对用户的一些操作</li>
</ul>
<h4 id="springbootxxl-job"><a class="toclink" href="../../xxx-job/#springbootxxl-job">第三章 新版SpringBoot整合XXL-Job分布式调度任务实操</a></h4>
<h5 id="1-springbootxxl-job"><a class="toclink" href="../../xxx-job/#1-springbootxxl-job">第1集 新版Springboot整合XXL-Job项目搭建</a></h5>
<p><strong>简介：新版Springboot整合XXL-Job项目搭建</strong></p>
<ul>
<li>新版Springboot介绍</li>
<li>GitHub地址：https://github.com/spring-projects/spring-boot</li>
<li>官方文档：https://spring.io/guides/gs/spring-boot/</li>
<li>视频地址：https://item.taobao.com/item.htm?id=618384570391</li>
<li>在线创建：https://start.spring.io/</li>
<li>相关的软件环境</li>
<li>jdk8/11+maven3.5</li>
<li>编辑器IDEA</li>
<li>创建一个Springboot项目</li>
<li>
<p>导入本集课程代码即可，pom版本保持一致</p>
</li>
<li>
<p>添加XXL-Job依赖</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>         &lt;dependency&gt;
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>            &lt;groupId&gt;com.xuxueli&lt;/groupId&gt;
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>            &lt;artifactId&gt;xxl-job-core&lt;/artifactId&gt;
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>            &lt;version&gt;2.3.0&lt;/version&gt;
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>        &lt;/dependency&gt;
</span></code></pre></div>
<ul>
<li>
<p>编写简单的任务调度例子</p>
</li>
<li>
<p>新增logback.xml</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>&lt;configuration debug=&quot;false&quot; scan=&quot;true&quot; scanPeriod=&quot;1 seconds&quot;&gt;
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>    &lt;contextName&gt;logback&lt;/contextName&gt;
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>    &lt;property name=&quot;log.path&quot; value=&quot;./data/logs/xxl-job/app.log&quot;/&gt;
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>    &lt;appender name=&quot;console&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>        &lt;encoder&gt;
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>            &lt;pattern&gt;%d{HH:mm:ss.SSS} %contextName [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>        &lt;/encoder&gt;
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>    &lt;/appender&gt;
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>    &lt;appender name=&quot;file&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>        &lt;file&gt;${log.path}&lt;/file&gt;
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>            &lt;fileNamePattern&gt;${log.path}.%d{yyyy-MM-dd}.zip&lt;/fileNamePattern&gt;
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>        &lt;/rollingPolicy&gt;
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>        &lt;encoder&gt;
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>            &lt;pattern&gt;%date %level [%thread] %logger{36} [%file : %line] %msg%n
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>            &lt;/pattern&gt;
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>        &lt;/encoder&gt;
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>    &lt;/appender&gt;
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>    &lt;root level=&quot;info&quot;&gt;
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>        &lt;appender-ref ref=&quot;console&quot;/&gt;
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>        &lt;appender-ref ref=&quot;file&quot;/&gt;
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>    &lt;/root&gt;
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a>&lt;/configuration&gt;
</span></code></pre></div>
<ul>
<li>配置文件</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>#----------xxl-job配置--------------
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>logging.config=classpath:logback.xml
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>#调度中心部署地址,多个配置逗号分隔 &quot;http://address01,http://address02&quot;
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>xxl.job.admin.addresses=http://127.0.0.1:8080/xxl-job-admin
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>#执行器token，非空时启用 xxl-job, access token 
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>xxl.job.accessToken=xdclass.net
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a># 执行器app名称,和控制台那边配置一样的名称，不然注册不上去
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>xxl.job.executor.appname=xdclass-shop
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a># [选填]执行器注册：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>#从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>xxl.job.executor.address=
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>#[选填]执行器IP ：默认为空表示自动获取IP（即springboot容器的ip和端口，可以自动获取，也可以指定），多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;，
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>xxl.job.executor.ip=
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a># [选填]执行器端口号：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>xxl.job.executor.port=9999
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>#执行器日志文件存储路径，需要对该路径拥有读写权限；为空则使用默认路径
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>xxl.job.executor.logpath=./data/logs/xxl-job/executor
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>#执行器日志保存天数
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a>xxl.job.executor.logretentiondays=30
</span></code></pre></div>
<ul>
<li>XxlJobConfig</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>@Configuration
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>public class XxlJobConfig {
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>    private Logger log = LoggerFactory.getLogger(XxlJobConfig.class);
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>    @Value(&quot;${xxl.job.admin.addresses}&quot;)
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>    private String adminAddresses;
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>    @Value(&quot;${xxl.job.executor.appname}&quot;)
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>    private String appName;
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>    @Value(&quot;${xxl.job.executor.ip}&quot;)
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>    private String ip;
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a>    @Value(&quot;${xxl.job.executor.port}&quot;)
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a>    private int port;
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>    @Value(&quot;${xxl.job.accessToken}&quot;)
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a>    private String accessToken;
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a>    @Value(&quot;${xxl.job.executor.logpath}&quot;)
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>    private String logPath;
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a>    @Value(&quot;${xxl.job.executor.logretentiondays}&quot;)
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a>    private int logRetentionDays;
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>    //旧版的有bug
</span><span id="__span-35-27"><a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>    //@Bean(initMethod = &quot;start&quot;, destroyMethod = &quot;destroy&quot;)
</span><span id="__span-35-28"><a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a>    @Bean
</span><span id="__span-35-29"><a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a>    public XxlJobSpringExecutor xxlJobExecutor() {
</span><span id="__span-35-30"><a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a>        log.info(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;);
</span><span id="__span-35-31"><a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a>        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();
</span><span id="__span-35-32"><a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);
</span><span id="__span-35-33"><a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a>        xxlJobSpringExecutor.setAppname(appName);
</span><span id="__span-35-34"><a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a>        xxlJobSpringExecutor.setIp(ip);
</span><span id="__span-35-35"><a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a>        xxlJobSpringExecutor.setPort(port);
</span><span id="__span-35-36"><a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a>        xxlJobSpringExecutor.setAccessToken(accessToken);
</span><span id="__span-35-37"><a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a>        xxlJobSpringExecutor.setLogPath(logPath);
</span><span id="__span-35-38"><a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);
</span><span id="__span-35-39"><a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a>
</span><span id="__span-35-40"><a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a>        return xxlJobSpringExecutor;
</span><span id="__span-35-41"><a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a>    }
</span><span id="__span-35-42"><a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a>}
</span></code></pre></div>
<h5 id="2-xxl-job"><a class="toclink" href="../../xxx-job/#2-xxl-job">第2集 创建你的第一个XXL-Job分布式调度任务</a></h5>
<p><strong>简介：创建你的第一个XXL-Job分布式调度任务</strong></p>
<ul>
<li>
<p>注解介绍</p>
</li>
<li>
<p>在 Spring Bean 实例中，开发 Job 方法方式格式要求为</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>public ReturnT&lt;String&gt; execute(String param)
</span></code></pre></div>
<ul>
<li>为 Job 方法添加注解 （注解value值是调度中心新建任务的 JobHandler 属性的值）</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>@XxlJob(value=&quot;自定义jobHandler名称&quot;, init = &quot;handler初始化方法&quot;, destroy = &quot;handler 销毁方法&quot;)
</span></code></pre></div>
<ul>
<li>编写代码</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>@Component
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>public class MyJobHandler {
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>    private Logger log = LoggerFactory.getLogger(MyJobHandler.class);
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>    @XxlJob(value = &quot;demoJobHandler&quot;,init = &quot;init&quot;,destroy = &quot;destroy&quot;)
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>    public ReturnT&lt;String&gt; execute(String param){
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>        log.info(&quot;小滴课堂 execute 任务方法触发成功&quot;);
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>        return ReturnT.SUCCESS;
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>    }
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>    private void init(){
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>        log.info(&quot;小滴课堂 MyJobHandler init &gt;&gt;&gt;&gt;&gt;&quot;);
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>    }
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>    private void destroy(){
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a>        log.info(&quot;小滴课堂 MyJobHandler destroy &gt;&gt;&gt;&gt;&gt;&quot;);
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>    }
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a>}
</span></code></pre></div>
<ul>
<li>执行器管理</li>
<li>
<p>到xxl-job调度中心里的执行器管理-&gt;新增</p>
<ul>
<li>Appname：是每一个执行器的唯一表示AppName，执行器会以周期性为appname进行注册，为任务调度的时候使用</li>
<li>名称：执行器的名称，因为appname有限制字母与数字等等组成，可读性不强，这个名称就是为了提高执行器的可读性</li>
<li>注册方式：调度中心获取执行器地址的方式</li>
<li>自动注册：执行器自动进行执行器的注册，通过底层的注册表可以动态的发现执行器机器的地址</li>
<li>手动录入：人工手动录入执行器的地址信息，多地址使用逗号进行分割，供调度中心使用</li>
<li>机器地址：“注册方式”为手动录入的时候才能使用，支持人工维护执行器的地址</li>
<li>点击保存后可能要等30S左右才回显示机器的地址</li>
</ul>
</li>
<li>
<p>任务管理</p>
</li>
<li>任务管理-&gt;选择所需要管理的执行器-&gt;新增执行器</li>
</ul>
<h5 id="3-xxl-job_1"><a class="toclink" href="../../xxx-job/#3-xxl-job_1">第3集 执行和分析第一个XXL-Job分布式调度任务</a></h5>
<p><strong>简介：执行和分析第一个XXL-Job分布式调度任务</strong></p>
<ul>
<li>
<p>任务管理-启动任务</p>
</li>
<li>
<p>任务管理的状态已经从STOP变更成RUNNING</p>
</li>
<li>
<p>调度日志</p>
</li>
<li>
<p>在调度日志里能够查看调度结果与日志的信息</p>
</li>
</ul>
<h5 id="4-executor"><a class="toclink" href="../../xxx-job/#4-executor">第4集 Executor执行器多节点部署和调度策略讲解实战</a></h5>
<p><strong>简介：执行器多节点部署和调度策略讲解实战</strong></p>
<ul>
<li>本机部署多节点</li>
<li>程序端口修改</li>
<li>
<p>执行器端口修改</p>
</li>
<li>
<p>策略</p>
</li>
<li>第一个、最后一个、轮训</li>
</ul>
<p><strong>更多架构课程请访问 xdclass.net</strong></p>
<h4 id="xxl-job_1"><a class="toclink" href="../../xxx-job/#xxl-job_1">第四章 【进阶】XXL-Job分布式调度多案例实战</a></h4>
<h5 id="1_1"><a class="toclink" href="../../xxx-job/#1_1">第1集 分布式调度参数传递和调度日志配置</a></h5>
<p><strong>简介：分布式调度参数传递和调度日志配置讲解</strong></p>
<ul>
<li>UI界面参数传递</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>String jobParam = XxlJobHelper.getJobParam();
</span></code></pre></div>
<ul>
<li>执行日志打印</li>
<li>
<p>需要通过 "XxlJobHelper.log" 打印执行日志</p>
</li>
<li>
<p>执行结果</p>
</li>
<li>默认任务结果为 "成功" 状态，不需要主动设置</li>
<li>自主设置任务结果（会出现在【执行备注】里面）<ul>
<li>如想设置任务结果为失败，可以通过 "XxlJobHelper.handleFail</li>
<li>如想设置任务结果为成功，handleSuccess" </li>
</ul>
</li>
</ul>
<h5 id="2-xxl-job_1"><a class="toclink" href="../../xxx-job/#2-xxl-job_1">第2集 【高级】XXL-Job集群部署和高可用案例配置</a></h5>
<p><strong>简介：【高级】XXL-Job集群部署和高可用案例讲解</strong></p>
<ul>
<li>
<p>HA/集群</p>
</li>
<li>
<p>为了避免单点故障，任务调度系统通常需要通过集群实现系统高可用</p>
</li>
<li>
<p>由于任务调度系统的特殊性，“调度”和“任务”两个模块需要均支持集群部署，由于职责不同，因此各自集群侧重点也有有所不同。</p>
</li>
<li>
<p>调度中心集群</p>
<ul>
<li>目标为避免调度模块单点故障，集群节点需要通过锁或命名服务保证单个任务的单次触发，只在其中一个节点上生效，以防止任务的重复触发。</li>
</ul>
</li>
<li>
<p>执行器集群</p>
<ul>
<li>目标为避免任务模块单点故障，进一步可以通过自定义路由策略实现Failover等高级功能，从而在执行器某台机器节点故障时自动转移不会影响到任务的正常触发执行</li>
</ul>
</li>
<li>
<p>高可用集群架构</p>
</li>
<li>
<p>执行器配置调度中心集群</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>#调度中心部署地址,多个配置逗号分隔 &quot;http://address01,http://address02&quot;
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>xxl.job.admin.addresses=http://127.0.0.1:8080/xxl-job-admin,http://127.0.0.1:8079/xxl-job-admin
</span></code></pre></div>
<h5 id="3-xxl-job-"><a class="toclink" href="../../xxx-job/#3-xxl-job-">第3集 【高级】XXL-Job海量数据处理-分片任务实战《上》</a></h5>
<p><strong>简介：XXL-Job海量数据处理-分片任务实战《上》</strong></p>
<ul>
<li>
<p>需求</p>
</li>
<li>
<p>有一个任务需要处理100W条数据，每条数据的业务逻辑处理要0.1s</p>
</li>
<li>对于普通任务来说，只有一个线程来处理 可能需要10万秒才能处理完，业务则严重受影响</li>
<li>
<p>案例：双十一大促，给1000万用户发营销短信</p>
</li>
<li>
<p>什么是分片任务</p>
</li>
<li>
<p>执行器集群部署，如果任务的路由策略选择【分片广播】，一次任务调度将会【广播触发】对应集群中所有执行器执行一次任务，同时系统自动传递分片参数，执行器可根据分片参数开发分片任务</p>
</li>
<li>需要处理的海量数据，以执行器为划分，每个执行器分配一定的任务数，并行执行</li>
<li>XXL-Job支持动态扩容执行器集群，从而动态增加分片数量，到达更快处理任务</li>
<li>分片的值是调度中心分配的</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>// 当前分片数，从0开始，即执行器的序号
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>int shardIndex = XxlJobHelper.getShardIndex();
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>//总分片数，执行器集群总机器数量
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>int shardTotal = XxlJobHelper.getShardTotal();
</span></code></pre></div>
<ul>
<li>
<p>解决思路</p>
</li>
<li>
<p>如果将100W数据均匀分给集群里的10台机器同时处理，</p>
</li>
<li>每台机器耗时，1万秒即可，耗时会大大缩短，也能充分利用集群资源</li>
<li>
<p>在xxl-job里，可以配置执行器集群有10个机器，那么分片总数是10，分片序号0~9 分别对应那10台机器。</p>
</li>
<li>
<p>分片方式</p>
<ul>
<li>id % 分片总数 余数是0 的，在第1个执行器上执行</li>
<li>id % 分片总数 余数是1 的，在第2个执行器上执行</li>
<li>id % 分片总数 余数是2 的，在第3个执行器上执行</li>
<li>...</li>
<li>id % 分片总数 余数是9 的，在第10个执行器上执行</li>
</ul>
</li>
<li>
<p>路由策略</p>
<ul>
<li>选择为【分片广播】</li>
</ul>
</li>
<li>
<p>其他解决方式</p>
<ul>
<li>也可以启动多个job，使用同个jobHandler,通过命令行参数控制</li>
</ul>
</li>
</ul>
<h5 id="4-xxl-job-"><a class="toclink" href="../../xxx-job/#4-xxl-job-">第4集 【高级】XXL-Job海量数据处理-分片任务实战《下》</a></h5>
<p><strong>简介：XXL-Job海量数据处理-分片任务实战《上》</strong></p>
<ul>
<li>
<p>编码实战</p>
</li>
<li>
<p>需求：100个用户，分片处理</p>
</li>
<li>新增job测试案例</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>   /**
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>     * 2、分片广播任务
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>     */
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>    @XxlJob(&quot;shardingJobHandler&quot;)
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>    public void shardingJobHandler() throws Exception {
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>        // 当前分片数，从0开始，即执行器的序号
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>        int shardIndex = XxlJobHelper.getShardIndex();
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>        //总分片数，执行器集群总机器数量
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>        int shardTotal = XxlJobHelper.getShardTotal();
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>        XxlJobHelper.log(&quot;分片参数：当前分片序号 = {}, 总分片数 = {}&quot;, shardIndex, shardTotal);
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>        // 业务逻辑
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>        for (int i = 0; i &lt; shardTotal; i++) {
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>            if (i == shardIndex) {
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>                log.info(&quot;第 {} 片, 命中分片开始处理&quot;, i);
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a>            } else {
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a>                log.info(&quot;第 {} 片, 忽略&quot;, i);
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a>            }
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a>        }
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a>    }
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>* 根据id进行分片取模（部署3个执行器）
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>    /**
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>     * 2、分片广播任务
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>     */
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>    @XxlJob(&quot;shardingJobHandler&quot;)
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>    public void shardingJobHandler() throws Exception {
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>        // 当前分片数，从0开始，即执行器的序号
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>        int shardIndex = XxlJobHelper.getShardIndex();
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>        //总分片数，执行器集群总机器数量
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>        int shardTotal = XxlJobHelper.getShardTotal();
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>        XxlJobHelper.log(&quot;分片参数：当前分片序号 = {}, 总分片数 = {}&quot;, shardIndex, shardTotal);
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>        List&lt;Integer&gt; allUserIds = getAllUserIds();
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>        allUserIds.forEach(obj -&gt; {
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>            if (obj % shardTotal == shardIndex) {
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>                log.info(&quot;第 {} 片, 命中分片开始处理用户id={}&quot;,shardIndex,obj);
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>            }
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>        });
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>    }
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a>    private List&lt;Integer&gt; getAllUserIds() {
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a>        List&lt;Integer&gt; ids = new ArrayList&lt;&gt;();
</span><span id="__span-43-26"><a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a>        for (int i = 0; i &lt; 100; i++) {
</span><span id="__span-43-27"><a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a>            ids.add(i);
</span><span id="__span-43-28"><a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a>        }
</span><span id="__span-43-29"><a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a>        return ids;
</span><span id="__span-43-30"><a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a>    }
</span></code></pre></div>
<h5 id="5-"><a class="toclink" href="../../xxx-job/#5-">第5集 留给大家的作业-海量任务定时调度-处理维护三连问</a></h5>
<p><strong>简介： 留给大家的作业-海量任务定时调度-处理维护三连问</strong></p>
<ul>
<li>
<p>需求背景</p>
</li>
<li>
<p>为了促进平台用户活跃度，鼓励用户每天登录网站</p>
</li>
<li>
<p>短链平台，每天可以免费创建2次短链，每天限制次数</p>
<ul>
<li>用户量：千万级别、甚至亿级别</li>
<li>每个用户【每天】可以免费进行2次使用平台功能【免费流量包】</li>
<li>如果用户超过2次还想使用平台功能，则可以付费购买流量包，增加每天次数【付费流量包】</li>
</ul>
</li>
<li>
<p>正式案例</p>
<ul>
<li>百度云短链平台：https://dwz.cn/console/product</li>
</ul>
</li>
<li>
<p>如何维护好用户每天的免费权益次数呢 ？？？</p>
</li>
<li>
<p>怎么维护更新好流量包每天的次数呢</p>
</li>
<li>
<p>留给老王的作业，海量数据项目大课里面的核心内容</p>
</li>
<li>
<p>分片广播任务</p>
</li>
<li>
<p>惰性更新+定时更新</p>
</li>
<li>
<p>业务模型适合场景</p>
</li>
<li>
<p>拼多多用户签到，总签到次数达到一定数值后，免费领取商品，每天限制次数</p>
</li>
<li>
<p>信用卡每天领取积分，每天限制次数</p>
</li>
<li>
<p>电商平台抽奖，每天免费抽奖两次，每天限制次数</p>
</li>
</ul>
<h5 id="6-xxl-job"><a class="toclink" href="../../xxx-job/#6-xxl-job">第6集 学完分布式调度XXL-Job后你的下一步</a></h5>
<p><strong>简介： 学完分布式调度XXL-Job后你的下一步</strong></p>
<h4 id="xxl-job_2"><a class="toclink" href="../../xxx-job/#xxl-job_2">第五章 分布式调度XXL-Job课程总结和学习建议</a></h4>
<h5 id="1-xxl-job"><a class="toclink" href="../../xxx-job/#1-xxl-job">第1集  分布式调度XXL-Job课程总结</a></h5>
<p><strong>简介： 分布式调度XXL-Job课程总结</strong></p>
<ul>
<li>知识点回顾</li>
<li>需求背景</li>
<li>同类解决方案</li>
<li>XXL-Job部署架构</li>
<li>SpringBoot项目整合</li>
<li>多节点部署和调度策略</li>
<li>控制台日志配置</li>
<li>高可用案例</li>
<li>分片任务实战</li>
</ul>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.sections", "navigation.instant"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.081f42fc.min.js"></script>
      
    
  </body>
</html>